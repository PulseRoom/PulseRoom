<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" id="viewport-meta">
    <title>PulseRoom</title>
    <link rel="icon" type="image/png" href="https://yxdjmyqkltaqjulfkcuu.supabase.co/storage/v1/object/public/thumbnails/rabbit.png">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <!-- Adiciona a biblioteca de streaming HLS.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    :root {
        --background-color: #0d0d0d; --primary-text-color: #ffffff; --secondary-text-color: #a0a0a0;
        --accent-color: #FFC0CB; --card-background-color: #1a1a1a; --hover-color: #262626; --border-color: #333333;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    body { background-color: var(--background-color); color: var(--primary-text-color); }

    body {
        display: flex;
    }
    .sidebar { width: 240px; background-color: var(--background-color); border-right: 1px solid var(--border-color); padding: 20px; height: 100vh; position: fixed; left: 0; top: 0; display: flex; flex-direction: column; transition: width 0.3s ease; }
    .sidebar:hover { width: 260px; }
    .logo { display: flex; align-items: center; gap: 10px; font-size: 1.5rem; font-weight: 600; color: var(--accent-color); margin-bottom: 40px; padding: 10px 0; }
    .logo .logo-icon { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; transition: transform 0.3s ease; }
    .sidebar:hover .logo .logo-icon { transform: rotate(360deg); }
    .nav-menu a { display: flex; align-items: center; gap: 15px; color: var(--secondary-text-color); text-decoration: none; padding: 15px 10px; border-radius: 8px; margin-bottom: 10px; transition: background-color 0.3s, color 0.3s; }
    .nav-menu a:hover, .nav-menu a.active { background-color: var(--accent-color); color: var(--primary-text-color); }
    .nav-menu a i { font-size: 1.2rem; }
        .categories {
        margin-top: 30px;
        flex-grow: 1;
        overflow-y: auto; /* Adiciona a barra de rolagem vertical quando o conteúdo transborda */
        padding-right: 5px; /* Evita que a barra de rolagem cole no texto */
    }
    .categories h3 { color: var(--primary-text-color); font-weight: 500; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
    .categories ul { list-style: none; }
    .categories ul li a { display: block; color: var(--secondary-text-color); text-decoration: none; padding: 10px; border-radius: 5px; transition: background-color 0.3s, padding-left 0.3s; }
    .categories ul li a:hover, .categories ul li a.active { background-color: var(--hover-color); color: var(--primary-text-color); padding-left: 15px; }

    /* Estilização da Barra de Rolagem das Categorias */
    .categories::-webkit-scrollbar {
        width: 8px;
    }
    .categories::-webkit-scrollbar-track {
        background: transparent; /* Fundo transparente para se misturar */
    }
    .categories::-webkit-scrollbar-thumb {
        background-color: var(--border-color);
        border-radius: 4px;
        border: 2px solid var(--background-color); /* Cria um espaçamento */
    }
    .categories::-webkit-scrollbar-thumb:hover {
        background-color: var(--secondary-text-color);
    }
    /* Para Firefox */
    .categories {
        scrollbar-width: thin;
        scrollbar-color: var(--border-color) transparent;
    }

    
    .page-wrapper {
        width: calc(100% - 240px);
        margin-left: 240px;
    }
    .main-content { padding: 20px; width: 100%; } /* Removemos o margin e ajustamos a largura */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .search-bar { position: relative; }
    .search-bar input { background-color: var(--card-background-color); border: 1px solid var(--border-color); border-radius: 20px; padding: 10px 40px 10px 15px; color: var(--primary-text-color); width: 300px; transition: width 0.3s ease; }
    .search-bar input:focus { outline: none; border-color: var(--accent-color); width: 350px; }
    .search-bar i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--secondary-text-color); }
    .user-profile { display: flex; align-items: center; gap: 15px; }
    .user-profile i { font-size: 1.5rem; cursor: pointer; transition: color 0.3s; }
    .user-profile i:hover { color: var(--accent-color); }
    .user-profile img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--accent-color); cursor: pointer; object-fit: cover; }
    .featured-mural {
        height: 400px;
        border-radius: 15px;
        background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.8)), var(--card-background-color); /* Remove a URL da imagem e usa uma cor de fundo do tema */
        background-position: center;
        background-size: cover;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        padding: 40px;
        margin-bottom: 30px;
        animation: fadeIn 1s ease-in-out;
        transition: background-image 0.5s ease-in-out; /* Adiciona uma transição suave para a nova imagem */
        position: relative; /* Necessário para o overlay */
    }
    .featured-mural h1 { font-size: 3rem; font-weight: 700; margin-bottom: 10px; }
    .featured-mural p { font-size: 1.2rem; max-width: 60%; margin-bottom: 20px; }
    .featured-mural .btn { background-color: var(--accent-color); color: var(--primary-text-color); padding: 12px 25px; text-decoration: none; border-radius: 5px; font-weight: 500; display: inline-flex; align-items: center; gap: 10px; width: fit-content; transition: transform 0.3s, background-color 0.3s; }
    .featured-mural .btn:hover { transform: translateY(-3px); background-color: #F8A9B5; }
    .video-section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
    .video-section-header h2 { font-size: 1.8rem; }
    .filter-options a { color: var(--secondary-text-color); text-decoration: none; margin-left: 20px; font-weight: 500; padding: 5px 10px; border-radius: 5px; transition: background-color 0.3s, color 0.3s; }
    .filter-options a.active, .filter-options a:hover { background-color: var(--card-background-color); color: var(--primary-text-color); }
    .video-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* Padrão de 3 colunas */
        gap: 20px;
    }
    .pagination { display: flex; justify-content: center; align-items: center; margin-top: 40px; }
    .video-card { background-color: var(--card-background-color); border-radius: 10px; overflow: hidden; transition: transform 0.3s, box-shadow 0.3s; cursor: pointer; border: 1px solid transparent; will-change: transform, box-shadow; }
    .video-card:hover { transform: translateY(-10px); box-shadow: 0 10px 20px rgba(0,0,0,0.5); border-color: var(--accent-color); }
    .thumbnail-container { 
        position: relative; 
        width: 100%;
        aspect-ratio: 16 / 9; /* Proporção widescreen para a miniatura */
        background-color: var(--hover-color); /* Fundo enquanto a imagem carrega */
    }
    /* O seletor agora é específico para a miniatura, ignorando overlays */
    .thumbnail-container > img:not(.flag-overlay):not(.pro-badge-overlay) {
        width: 100%;
        height: 100%; /* Imagem preenche 100% do container que agora tem aspect-ratio */
        object-fit: cover;
        display: block;
    }
    .video-duration { position: absolute; bottom: 8px; right: 8px; background-color: rgba(0,0,0,0.7); color: var(--primary-text-color); padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; }
    .play-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); width: 60px; height: 60px; background-color: rgba(255, 192, 203, 0.8); border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s, transform 0.3s; }
    .video-card:hover .play-icon { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    .video-card .pro-badge-overlay {
        position: absolute;
        top: 8px;
        left: 8px;
        background-color: gold;
        color: #333;
        font-weight: 600;
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 5px;
        z-index: 3;
    }
    .flag-overlay {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 24px; /* Tamanho padrão para a grade */
        height: auto;
        z-index: 3;
        border-radius: 3px;
        box-shadow: 0 0 5px rgba(0,0,0,0.7);
    }
    .featured-mural .flag-overlay {
        width: 40px; /* Tamanho maior para o destaque */
        top: 20px;
        right: 20px;
    }
     .recommendation-thumbnail-container .flag-overlay {
        width: 20px; /* Tamanho menor para recomendações */
        top: 5px;
        right: 5px;
    }
    .video-info { padding: 15px; }
    .video-info h4 { 
        font-size: 1.1rem; 
        font-weight: 600; 
        margin-bottom: 8px; 
        white-space: normal; /* Permite que o texto quebre a linha */
        overflow: visible; /* Garante que o texto não seja cortado */
        text-overflow: clip; /* Remove os "..." */
        line-height: 1.3; /* Melhora a legibilidade do texto em múltiplas linhas */
        height: 2.6em; /* Limita a altura a duas linhas (1.3em * 2) */
        display: -webkit-box;
        -webkit-line-clamp: 2; /* Limita o texto a duas linhas */
        -webkit-box-orient: vertical;
        overflow: hidden; /* Esconde o texto que passar de duas linhas */
        text-overflow: ellipsis; /* Adiciona "..." se o texto for maior que duas linhas */
    }
    .video-category { background-color: var(--accent-color); color: var(--background-color); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 500; margin-top: 8px; display: inline-block; }
    .video-meta { display: flex; align-items: center; gap: 15px; color: var(--secondary-text-color); font-size: 0.9rem; }
    .pagination { display: flex; justify-content: center; align-items: center; margin-top: 40px; }
    .pagination a { color: var(--secondary-text-color); text-decoration: none; padding: 10px 15px; margin: 0 5px; border-radius: 5px; transition: background-color 0.3s, color 0.3s; border: 1px solid var(--border-color); }
    .pagination a.active, .pagination a:hover { background-color: var(--accent-color); color: var(--primary-text-color); border-color: var(--accent-color); }
    .pagination a.arrow { font-size: 1.2rem; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .video-player-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--background-color); z-index: 1000; display: none; overflow-y: auto; }
    .video-player-overlay.active { display: block; }
    .player-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background-color: var(--card-background-color); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 1020; }
    .player-logo { display: flex; align-items: center; gap: 10px; font-size: 1.5rem; font-weight: 600; color: var(--accent-color); }
    .player-logo .logo-icon { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
    .player-categories a { color: var(--secondary-text-color); text-decoration: none; margin: 0 15px; font-weight: 500; transition: color 0.3s; }
    .player-categories a:hover { color: var(--primary-text-color); }
    .player-close-btn { position: static; background-color: var(--hover-color); border-radius: 8px; width: auto; height: auto; padding: 8px 15px; display: flex; gap: 8px; cursor: pointer; border: none; color: var(--primary-text-color); font-size: 1rem; }
    .player-wrapper { display: grid; grid-template-columns: 2.5fr 1fr; max-width: 1400px; margin: 20px auto; padding: 20px; gap: 30px; }
    .video-container {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #000;
        border-radius: 10px;
        overflow: hidden;
        /* Define uma altura máxima para o container não ficar gigante em telas altas */
        max-height: 85vh; 
        height: 100%; /* Tenta ocupar a altura do grid */
    }

    .video-container video {
        /* Essas propriedades garantem que o vídeo caiba perfeitamente no container,
           seja ele vertical ou horizontal, sem distorcer ou cortar. */
        max-width: 100%;
        max-height: 100%;
        object-fit: contain; 
        border-radius: 10px;
    }
    .video-player-details { padding: 20px 0; border-bottom: 1px solid var(--border-color); }
    .video-player-details h2 { font-size: 1.8rem; margin-bottom: 10px; }
    .video-player-details p { color: var(--secondary-text-color); }
    .video-actions { display: flex; gap: 10px; padding: 20px 0; }
    .action-btn { background-color: var(--card-background-color); border: none; color: var(--primary-text-color); padding: 10px 15px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 1rem; }
    .video-comments { padding-top: 20px; }
    .comment-placeholder { display: flex; gap: 15px; margin-top: 20px; }
    .comment-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--hover-color); }
    .comment-body { flex-grow: 1; }
    .comment-line-short { height: 12px; width: 40%; background-color: var(--border-color); border-radius: 4px; margin-bottom: 8px; }
    .comment-line-long { height: 12px; width: 70%; background-color: var(--border-color); border-radius: 4px; }
    .player-sidebar h3 { margin-bottom: 20px; }
    #recommendations-list .recommendation-card { display: flex; gap: 15px; margin-bottom: 15px; cursor: pointer; }
    /* O seletor aqui também fica mais específico */
    #recommendations-list .recommendation-card .recommendation-thumbnail-container > img:not(.flag-overlay):not(.pro-badge-overlay) {
        width: 160px;
        height: 90px;
        object-fit: cover;
        border-radius: 8px;
    }
    #recommendations-list .recommendation-info h4 { font-size: 1rem; margin-bottom: 5px; }
    #recommendations-list .recommendation-info p { font-size: 0.8rem; color: var(--secondary-text-color); }
    .recommendation-thumbnail-container {
        position: relative;
        flex-shrink: 0; /* Evita que a imagem encolha */
    }
    .recommendation-thumbnail-container .pro-badge-overlay {
        position: absolute;
        top: 5px;
        left: 5px;
        background-color: gold;
        color: #333;
        font-weight: 600;
        font-size: 0.7rem;
        padding: 1px 6px;
        border-radius: 5px;
        z-index: 1;
    }

    /* Estilos para a nova tag "NOVO" */
    .new-badge-overlay {
        position: absolute;
        bottom: 8px; /* Alinhado com a duração do vídeo */
        left: 8px;   /* Alinhado com o badge PRO no topo */
        background-color: var(--accent-color); /* Cor rosa do tema */
        color: var(--background-color); /* Texto escuro para melhor contraste */
        font-weight: 600;
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 5px;
        z-index: 3;
        text-transform: uppercase;
    }

    /* Ajuste para a tag nos cards de recomendação menores */
    .recommendation-thumbnail-container .new-badge-overlay {
        font-size: 0.7rem;
        padding: 1px 6px;
        bottom: 5px;
        left: 5px;
    }
    /* Estilos do Modal de Autenticação */
    .auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; }
    .auth-overlay.active { display: flex; }
    .auth-modal { background-color: var(--card-background-color); padding: 30px; border-radius: 15px; width: 90%; max-width: 450px; position: relative; border: 1px solid var(--border-color); }
    .auth-close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--secondary-text-color); font-size: 2rem; cursor: pointer; }
    .auth-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; }
    .auth-tab-btn { background: none; border: none; color: var(--secondary-text-color); padding: 10px 20px; cursor: pointer; font-size: 1rem; border-bottom: 2px solid transparent; }
    .auth-tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
    .auth-form { display: none; }
    .auth-form.active { display: block; }
    .auth-modal .form-group { margin-bottom: 15px; }
    .auth-modal .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: var(--secondary-text-color); }
    .auth-modal .form-group input { width: 100%; padding: 10px; background-color: var(--background-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--primary-text-color); }
    .auth-modal .form-group input:focus { border-color: var(--accent-color); outline: none; }
    .btn-auth { width: 100%; padding: 12px; background-color: var(--accent-color); border: none; border-radius: 8px; color: var(--primary-text-color); font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 10px; }
    
    /* Adiciona posicionamento relativo ao container do input */
    .auth-modal .form-group {
        position: relative;
    }

    .password-toggle-icon {
        position: absolute;
        bottom: 12px; /* Posição estável a partir de baixo */
        right: 12px;
        cursor: pointer;
        color: var(--secondary-text-color);
    }
    /* Estilos de Comentários */
    .comment-form { display: flex; align-items: center; gap: 15px; margin: 20px 0; }
    .comment-form img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    .comment-form input { flex-grow: 1; background: transparent; border: none; border-bottom: 1px solid var(--border-color); color: var(--primary-text-color); padding: 8px 0; font-size: 1rem; }
    .comment-form input:focus { outline: none; border-bottom-color: var(--accent-color); }
    .comment-form button { background-color: var(--accent-color); color: var(--primary-text-color); border: none; border-radius: 15px; padding: 8px 15px; cursor: pointer; }
    .comments-list .comment-item { display: flex; gap: 15px; margin-bottom: 20px; }
    .comment-item img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    .comment-content .comment-author { font-weight: 600; margin-right: 8px; }
    .comment-content .comment-date { font-size: 0.8rem; color: var(--secondary-text-color); }
    .comment-content .comment-text { margin-top: 4px; }
    .video-actions .action-btn.active { color: var(--accent-color); }
    .comment-pro-badge {
        background-color: gold;
        color: #333;
        font-weight: 600;
        font-size: 0.7rem;
        padding: 1px 6px;
        border-radius: 8px;
        margin-left: 8px;
        vertical-align: middle;
    }
    .pro-avatar-border {
        border: 2px solid gold;
        padding: 2px; /* Espaçamento interno para a borda não cortar a imagem */
    }
    .comment-actions {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-top: 8px;
    }
    .comment-action-btn {
        display: flex;
        align-items: center;
        gap: 5px;
        color: var(--secondary-text-color);
        cursor: pointer;
        font-size: 0.9rem;
    }
    .comment-action-btn i {
        width: 16px;
        height: 16px;
    }
    .comment-action-btn.active {
        color: var(--accent-color);
    }
    .comment-clickable-user {
        cursor: pointer;
        transition: opacity 0.2s;
    }
    .comment-clickable-user:hover {
        opacity: 0.8;
    }

    /* --- Estilos de Notificação --- */
    .notification-container { position: relative; display: flex; align-items: center; }
    #notification-bell { cursor: pointer; }
    .notification-badge {
        position: absolute; top: -5px; right: -8px; background-color: var(--danger-color, #e53935);
        color: white; border-radius: 50%; width: 18px; height: 18px;
        font-size: 0.7rem; font-weight: 600; display: flex;
        justify-content: center; align-items: center; border: 1px solid var(--background-color);
    }
    .notification-dropdown {
        position: absolute; top: 120%; right: 0; background-color: var(--card-background-color);
        border: 1px solid var(--border-color); border-radius: 10px; width: 350px;
        max-height: 400px; overflow-y: auto; z-index: 1100; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }
    .notification-header { padding: 15px; font-weight: 600; border-bottom: 1px solid var(--border-color); }
    .notification-dropdown ul { list-style: none; }
    .notification-dropdown li { padding: 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s; }
    .notification-dropdown li:last-child { border-bottom: none; }
    .notification-dropdown li:hover { background-color: var(--hover-color); }
    .notification-dropdown li p { font-size: 0.9rem; margin: 0; }
    .notification-dropdown li .notification-time { font-size: 0.75rem; color: var(--secondary-text-color); margin-top: 5px; }
    /* --- Fim dos Estilos de Notificação --- */
    
    /* --- Estilos do Player de Vídeo Customizado --- */
    .custom-video-player {
        position: relative;
        overflow: hidden; /* Garante que os cantos arredondados do vídeo sejam aplicados */
        background-color: #000; /* Fundo preto para a "piscada" */
    }

    .custom-controls-container {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 10px 15px;
        background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
        opacity: 0; /* Começa invisível */
        transition: opacity 0.3s ease;
        z-index: 2;
    }

    /* Mostra os controles quando o mouse está sobre o player */
    .custom-video-player:hover .custom-controls-container {
        opacity: 1;
    }

    .progress-bar {
        width: 100%;
        height: 5px;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 5px;
        cursor: pointer;
        margin-bottom: 10px;
        position: relative; /* Necessário para posicionar as barras filhas */
        overflow: hidden; /* Garante que as barras não passem da borda */
    }

    .progress-buffered {
        width: 0%; /* Começa vazio */
        height: 100%;
        background-color: rgba(255, 255, 255, 0.5); /* Cinza claro para o buffer */
        position: absolute;
        top: 0;
        left: 0;
        transition: width 0.2s linear;
        z-index: 1;
    }

    .progress-filled {
        width: 0%; /* Começa vazio */
        height: 100%;
        background-color: var(--accent-color); /* A cor rosa do site! */
        position: absolute;
        top: 0;
        left: 0;
        transition: width 0.1s linear;
        z-index: 2; /* Garante que a barra de progresso fique sobre a de buffer */
    }

    .controls-main {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .controls-left, .controls-right {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .control-btn {
        background: none;
        border: none;
        color: var(--primary-text-color); /* Ícone branco */
        cursor: pointer;
        padding: 5px;
        transition: color 0.2s, transform 0.2s;
    }
    .control-btn i {
        width: 24px;
        height: 24px;
    }

    .volume-container {
        display: flex;
        align-items: center;
    }

    #volume-slider {
        width: 0px;
        max-width: 100px;
        opacity: 0;
        transition: width 0.3s ease, opacity 0.2s ease;
        -webkit-appearance: none;
        background: transparent;
        cursor: pointer;
        margin-left: 5px;
    }
    .volume-container:hover #volume-slider, #volume-slider:active {
        width: 80px;
        opacity: 1;
    }
    #volume-slider::-webkit-slider-runnable-track {
        width: 100%;
        height: 5px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 5px;
    }
    #volume-slider::-webkit-slider-thumb {
       -webkit-appearance: none;
        height: 15px;
        width: 15px;
        border-radius: 50%;
        background: var(--accent-color);
        margin-top: -5px; /* Alinha o polegar verticalmente */
    }
    #volume-slider::-moz-range-track {
        width: 100%;
        height: 5px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 5px;
    }
    #volume-slider::-moz-range-thumb {
        height: 15px;
        width: 15px;
        border-radius: 50%;
        background: var(--accent-color);
        border: none;
    }

    .control-btn:hover {
        color: var(--accent-color); /* Ícone fica rosa ao passar o mouse */
        transform: scale(1.1);
    }

    .quality-selector {
        position: relative;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .quality-label {
        font-size: 0.9rem;
        color: var(--secondary-text-color);
    }
    .quality-btn {
        background: none;
        border: 1px solid var(--danger-color, #e53935); /* Borda vermelha */
        color: var(--primary-text-color);
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        padding: 4px 8px; /* Ajuste para a borda */
        border-radius: 5px;
    }
    .quality-options {
        position: absolute; bottom: 120%; right: 0;
        background-color: var(--card-background-color); border-radius: 8px;
        overflow: hidden; display: none; list-style: none; width: 120px;
        border: 1px solid var(--danger-color, #e53935); /* Borda vermelha */
        box-shadow: 0 -5px 15px rgba(0,0,0,0.3); z-index: 10;
    }
    .quality-options.active { display: block; }
    .quality-options li {
        padding: 10px 15px; font-size: 0.9rem; cursor: pointer;
        transition: background-color 0.2s; display: flex;
        justify-content: space-between; align-items: center;
    }
    .quality-options li:hover { background-color: var(--hover-color); }
        .quality-options .pro-badge {
        background-color: gold; color: #333; font-weight: 600;
        font-size: 0.7rem; padding: 1px 6px; border-radius: 8px;
    }
    /* Efeito para simular qualidade SD (agora mais sutil) */
    .sd-quality-effect {
        filter: blur(0.6px) contrast(0.9);
    }
    /* --- Fim dos Estilos do Player Customizado --- */

    /* CORREÇÃO GLOBAL PARA TELA VERDE: Força a renderização em uma camada separada */
    video#main-player-video {
        transform: translateZ(0);
    }

    /* --- Estilos da Animação do Coelho Promocional --- */
    #promo-rabbit-container {
        position: fixed;
        bottom: 0;
        right: 20px;
        z-index: 9999;
        display: none; /* Começa escondido */
        align-items: flex-end; /* Alinha a imagem e o texto na base */
        gap: 15px;
        pointer-events: none; /* Evita que a animação bloqueie cliques */
    }

    #promo-rabbit-img {
        width: 150px;
        height: auto;
        display: block;
    }

    #promo-rabbit-text {
        background-color: var(--accent-color);
        color: var(--background-color);
        padding: 10px 15px;
        border-radius: 20px 20px 0 20px; /* Formato de balão de fala */
        font-weight: 600;
        margin-bottom: 50px; /* Posiciona o balão acima da "mão" do coelho */
        opacity: 0; /* Começa invisível */
        transform: scale(0); /* Começa pequeno */
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    /* Animações */
    @keyframes bounceInUp {
        0% { transform: translateY(200px); opacity: 0; }
        60% { transform: translateY(-15px); opacity: 1; }
        80% { transform: translateY(5px); }
        100% { transform: translateY(0); opacity: 1; }
    }

        @keyframes textBounceIn {
        0% { transform: scale(0); opacity: 0; }
        60% { transform: scale(1.1); opacity: 1; }
        80% { transform: scale(0.95); }
        100% { transform: scale(1); opacity: 1; }
    }

    @keyframes textFadeOut {
        from { transform: scale(1); opacity: 1; }
        to { transform: scale(0.8); opacity: 0; }
    }

    @keyframes bounceOutDown {
        0% { transform: translateY(0); opacity: 1; }
        20% { transform: translateY(-10px); }
        100% { transform: translateY(200px); opacity: 0; }
    }

    /* Classes para controlar a animação via JS */
    #promo-rabbit-container.animate-in {
        display: flex;
        animation: bounceInUp 0.8s ease-out forwards;
    }

    #promo-rabbit-text.animate-in {
        opacity: 1; /* Garante que seja visível para a animação */
        transform-origin: bottom left; /* Ponto de origem da animação */
        animation: textBounceIn 0.6s ease-out forwards;
    }
    
    #promo-rabbit-text.animate-out {
        animation: textFadeOut 0.4s ease-in forwards;
    }

    #promo-rabbit-container.animate-out {
        animation: bounceOutDown 0.7s ease-in forwards 0.3s; /* Adiciona um pequeno delay para o texto sumir primeiro */
    }


    /* Estilos do Botão de Apagar Comentário */
    .comment-item { position: relative; } /* Necessário para posicionar o botão */
    .delete-comment-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        cursor: pointer;
        color: var(--secondary-text-color);
        padding: 5px;
        display: none; /* Escondido por padrão */
    }
    .comment-item:hover .delete-comment-btn {
        display: block; /* Mostra ao passar o mouse sobre o comentário */
    }
    .delete-comment-btn:hover {
        color: #e53935; /* Vermelho para indicar perigo */
    }
    .delete-comment-btn i {
        width: 16px;
        height: 16px;
    }


    /* Estilos do Modal de Perfil */
    .profile-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; }
    .profile-overlay.active { display: flex; }
    .profile-modal { background-color: var(--card-background-color); padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; position: relative; border: 1px solid var(--border-color); max-height: 90vh; display: flex; flex-direction: column; }
    .profile-close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--secondary-text-color); font-size: 2rem; cursor: pointer; }
    .profile-content { overflow-y: auto; padding-right: 15px; } /* Para barra de rolagem */
    .profile-header { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 20px; text-align: center; }
    .profile-avatar-container { position: relative; }
    /* Agrupamos os dois IDs para compartilhar os mesmos estilos */
    #profile-avatar-img, #mini-profile-avatar-img { 
        width: 120px; 
        height: 120px; 
        border-radius: 50%; 
        object-fit: cover; 
        border: 3px solid var(--accent-color); 
    }
    #change-avatar-btn { position: absolute; bottom: 5px; right: 5px; background-color: var(--accent-color); color: var(--background-color); border-radius: 50%; width: 30px; height: 30px; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; }
    #avatar-file-input { display: none; }
    #profile-user-name { font-size: 1.8rem; font-weight: 600; }
    #profile-user-age { color: var(--secondary-text-color); }
    .profile-section { margin-top: 25px; }
    .profile-section h3 { border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; font-size: 1.2rem; }
    #profile-bio-textarea { width: 100%; height: 100px; background-color: var(--background-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--primary-text-color); padding: 10px; resize: vertical; }
    #save-bio-btn { display: block; margin-top: 10px; margin-left: auto; background-color: var(--accent-color); color: var(--primary-text-color); border: none; border-radius: 15px; padding: 8px 15px; cursor: pointer; }
    #recent-comments-list .comment-item { background-color: var(--background-color); padding: 10px; border-radius: 8px; margin-bottom: 10px; }
    #recent-comments-list .comment-text { font-style: italic; }
    #recent-comments-list .comment-video-title { font-size: 0.8rem; color: var(--secondary-text-color); margin-top: 5px; }
    .profile-actions { margin-top: 30px; text-align: center; }
    #logout-btn { background-color: #581a22; color: #ff8a9b; border: 1px solid #ff8a9b; width: 100%; padding: 12px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; }
    
    #login-prompt-btn {
        background-color: var(--card-background-color);
        border: 1px solid var(--border-color);
        color: var(--primary-text-color);
        padding: 8px 15px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.3s, color 0.3s;
    }
    #login-prompt-btn:hover {
        background-color: var(--accent-color);
        color: var(--background-color);
        border-color: var(--accent-color);
    }
    
    /* --- Estilos do Modal de Assinatura --- */
    .subscription-modal {
        /* Removemos o gradiente roxo e usamos a cor padrão dos cards */
        background-color: var(--card-background-color);
        /* Usamos a cor de borda padrão */
        border: 1px solid var(--border-color);
    }
    .plan-card h2 { color: var(--primary-text-color); font-size: 1.8rem; }
    .plan-card p { color: var(--secondary-text-color); }
    .price-info { margin: 20px 0; }
    .old-price { font-size: 1.5rem; text-decoration: line-through; color: var(--secondary-text-color); margin-right: 10px; }
    .new-price { font-size: 2.5rem; font-weight: 600; color: var(--primary-text-color); }
    .period { font-size: 1.5rem; color: var(--secondary-text-color); }
    .billing-details { font-size: 0.9rem; color: var(--secondary-text-color); margin-top: -15px; margin-bottom: 25px; }
    .features-list { list-style: none; margin-top: 25px; text-align: left; }
    .features-list li { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; color: var(--secondary-text-color); }
    .features-list li i { color: var(--accent-color); }

    /* --- Estilo do Botão de Pagamento Pendente --- */
    #pending-payment-clock {
        /* Cor e transição */
        color: gold; 
        transition: transform 0.2s;
        
        /* display é controlado via JS */
    }
    #pending-payment-clock:hover {
        transform: scale(1.1);
    }

    /* --- Estilos do Pop-up de Pagamento Pendente --- */
    #pending-payment-menu {
        display: none;
        position: absolute;
        background-color: var(--card-background-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px;
        z-index: 1200;
        width: 220px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }
    #pending-payment-menu button {
        background-color: var(--hover-color);
        width: 100%;
        border: 1px solid var(--border-color);
        color: var(--primary-text-color);
        padding: 8px;
        border-radius: 5px;
        cursor: pointer;
        margin-bottom: 5px;
        font-size: 0.9rem;
        transition: background-color 0.2s, color 0.2s;
    }
     #pending-payment-menu button:last-child {
        margin-bottom: 0;
    }
    #pending-payment-menu button:hover {
        opacity: 0.9;
    }
    
    .payment-menu-header-container {
        padding: 5px 10px 15px 10px;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 10px;
    }
    .payment-menu-header {
        font-size: 1rem;
        font-weight: 600;
        text-align: center;
        margin-bottom: 8px;
        color: var(--primary-text-color);
    }
     .payment-menu-description {
        font-size: 0.85rem;
        line-height: 1.5;
        color: var(--secondary-text-color);
        text-align: center;
        margin: 0;
    }
    .payment-menu-view {
        display: none;
    }
    .payment-menu-view.active {
        display: block;
    }
    #pending-payment-menu p {
        font-size: 0.85rem;
        line-height: 1.5;
        color: var(--secondary-text-color);
        margin-bottom: 10px;
        text-align: center;
    }
    .support-email-btn {
        display: block;
        text-align: center;
        text-decoration: none;
        background-color: var(--accent-color);
        width: 100%;
        border: none;
        color: var(--background-color);
        padding: 8px;
        border-radius: 5px;
        cursor: pointer;
        margin-bottom: 5px;
        font-size: 0.9rem;
        font-weight: 500;
        transition: opacity 0.2s;
    }
    .support-email-btn:hover {
        opacity: 0.9;
    }

    /* Classe para travar a rolagem do fundo quando um modal está aberto */
    .body-no-scroll {
        height: 100vh;
        overflow-y: hidden;
    }

    /* --- Estilos do Chat --- */
    #chat-container {
        display: flex;
        width: 90%;
        max-width: 900px;
        height: 85vh;
        max-height: 700px;
        background-color: var(--card-background-color);
        border-radius: 15px;
        overflow: hidden;
        border: 1px solid var(--border-color);
    }
    #chat-list-sidebar {
        width: 35%;
        min-width: 250px;
        background-color: var(--background-color);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
    }
    .chat-list-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
    }
     #chat-close-btn { position: static; font-size: 1.5rem; padding: 0 5px; }
    #chat-list {
        overflow-y: auto;
        flex-grow: 1;
    }
    .chat-list-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px 20px;
        cursor: pointer;
        transition: background-color 0.2s;
        border-bottom: 1px solid var(--border-color);
    }
    .chat-list-item:hover { background-color: var(--hover-color); }
    .chat-list-item.active { background-color: var(--accent-color); color: var(--background-color); }
    .chat-list-item img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; }
    .chat-list-item .chat-info h4 { font-size: 1rem; font-weight: 500; }
    .chat-list-item .chat-info p { font-size: 0.8rem; opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-list-item.active .chat-info p { opacity: 1; }

    .chat-unread-badge {
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 12px;
        height: 12px;
        background-color: var(--danger-color, #e53935);
        border-radius: 50%;
        border: 2px solid var(--background-color);
    }

    #chat-window-main {
        width: 65%;
        display: flex;
        flex-direction: column;
    }
    #chat-welcome-screen {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: var(--secondary-text-color);
    }
    #chat-welcome-screen i { width: 60px; height: 60px; margin-bottom: 20px; }

    #active-chat-window { 
    flex-grow: 1; 
    display: flex !important; 
    flex-direction: column; 
    overflow: hidden; /* Adicionado para conter os filhos e forçar a rolagem interna */
}
    #chat-window-header {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px 20px;
        background-color: var(--card-background-color);
        border-bottom: 1px solid var(--border-color);
        position: relative; /* Adicionado para contexto do botão de voltar */
    }
    #chat-window-header img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    #chat-window-header span { font-weight: 600; }

    #chat-messages {
        flex-grow: 1;
        overflow-y: scroll; /* Força a barra de rolagem a estar sempre visível */
        padding: 20px;
        display: flex;
        flex-direction: column-reverse;
        min-height: 0; /* ESSA LINHA É A CORREÇÃO CRÍTICA */
        /* Adiciona compatibilidade para navegadores como Firefox */
        scrollbar-width: thin;
        scrollbar-color: var(--border-color) var(--background-color);
    }
    /* Estilização da Barra de Rolagem do Chat */
    #chat-messages::-webkit-scrollbar {
        width: 8px;
    }
    #chat-messages::-webkit-scrollbar-track {
        background: var(--background-color);
    }
    #chat-messages::-webkit-scrollbar-thumb {
        background-color: var(--border-color);
        border-radius: 4px;
    }
    #chat-messages::-webkit-scrollbar-thumb:hover {
        background-color: var(--secondary-text-color);
    }
    .chat-message {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 18px;
        margin-bottom: 10px;
        line-height: 1.4;
    }
    .chat-message.sent {
        background-color: var(--accent-color);
        color: var(--background-color);
        border-bottom-right-radius: 4px;
        align-self: flex-end;
    }
    .chat-message.received {
        background-color: var(--hover-color);
        color: var(--primary-text-color);
        border-bottom-left-radius: 4px;
        align-self: flex-start;
    }
    
    #chat-input-form {
        display: flex;
        padding: 15px;
        border-top: 1px solid var(--border-color);
    }
    #chat-message-input {
        flex-grow: 1;
        background-color: var(--hover-color);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        padding: 10px 15px;
        color: var(--primary-text-color);
    }
    #chat-message-input:focus { outline: none; border-color: var(--accent-color); }
    #chat-input-form button, #chat-media-btn {
        background: none;
        border: none;
        color: var(--accent-color);
        padding: 0 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .chat-message img, .chat-message video {
        max-width: 100%;
        max-height: 300px;
        border-radius: 10px;
        margin-top: 5px;
        display: block;
    }
    
    /* NOVA REGRA: Esconde o avatar quando o formulário tem a classe 'logged-out' */
    .comment-form.logged-out #comment-user-avatar {
        display: none;
    }

    /* Adicionado para o link do card de vídeo */
    .video-card-link, .recommendation-card-link {
        text-decoration: none;
        color: inherit;
        display: block; /* Garante que o link ocupe o espaço do card */
    }
</style>
    <style>
        #geo-block-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--background-color);
            color: var(--primary-text-color);
            display: none; /* Começa escondido */
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 1.5rem;
            z-index: 99999;
            padding: 20px;
        }
        .hidden-by-geo-block {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="geo-block-overlay">
        <p>You do not have permission to access this site. Only Brazilians are allowed.</p>
    </div>

    <aside class="sidebar">
        <div class="logo">
            <img src="https://yxdjmyqkltaqjulfkcuu.supabase.co/storage/v1/object/public/thumbnails/rabbit.png" alt="PulseRoom Logo" class="logo-icon">
            <span>PulseRoom</span>
        </div>
        <nav class="nav-menu">
            <a href="#" id="home-btn" class="active"><i data-feather="home"></i> <span>Início</span></a>
            <a href="#" id="explore-btn"><i data-feather="compass"></i> <span>Explorar</span></a>
            <a href="#" id="subscriptions-btn" style="position: relative;">
                <i data-feather="star"></i> 
                <span>Inscrições</span>
            </a>
            <a href="#" id="history-btn"><i data-feather="clock"></i> <span>Histórico</span></a>
            <a href="#" id="liked-videos-btn"><i data-feather="thumbs-up"></i> <span>Vídeos Curtidos</span></a>
        </nav>
        <div class="categories">
            <h3>Categorias</h3>
            <ul id="sidebar-category-list">
                <!-- Categorias do Supabase serão inseridas aqui -->
            </ul>
        </div>
    </aside>
    <!-- NOVO INVÓLUCRO PARA TODO O CONTEÚDO DA PÁGINA -->
    <div class="page-wrapper">
        <main class="main-content">
            <header class="header">
            <!-- BOTÃO DO MENU HAMBÚRGUER (SÓ APARECE NO MOBILE) -->
            <i data-feather="menu" id="mobile-menu-btn" style="cursor: pointer;"></i>
            <div class="search-bar">
                <input type="text" placeholder="Buscar vídeos...">
                <i data-feather="search"></i>
            </div>
            <div class="user-profile">
                <div style="position: relative; display: flex; align-items: center;">
                    <i data-feather="message-square" id="open-chat-btn" style="cursor: pointer;" title="Abrir Chat"></i>
                    <span id="main-chat-badge" class="notification-badge" style="top: -6px; right: -8px; display: none;"></span>
                </div>

                <!-- Ícone do relógio movido para cá -->
                <i id="pending-payment-clock" data-feather="clock" style="display: none; cursor: pointer;"></i>
                
                <div class="notification-container">
                    <i data-feather="bell" id="notification-bell"></i>
                    <span class="notification-badge" style="display: none;"></span>
                    <div class="notification-dropdown" id="notification-list" style="display: none;">
                        <div class="notification-header">Notificações</div>
                        <ul>
                            <!-- As notificações aparecerão aqui -->
                        </ul>
                    </div>
                </div>
                
                <!-- ESTE É O BOTÃO CORRETO: Apenas o ícone que abre a janela de upload para o usuário -->
                <i data-feather="upload-cloud" id="open-upload-modal-btn" style="cursor: pointer;" title="Enviar Vídeo"></i>
                
                <button id="login-prompt-btn">Login</button>
                <div id="main-avatar-container" style="position: relative; display: none;">
                    <img id="main-user-avatar" src="" alt="Avatar do Usuário">
                    <span id="main-pro-badge" style="position: absolute; bottom: -5px; right: -5px; background-color: gold; color: #333; font-weight: 600; font-size: 0.7rem; padding: 1px 6px; border-radius: 8px; border: 1px solid var(--background-color); display: none;">PRO</span>
                </div>
            </div>
        </header>
        <section class="featured-mural">
            <h1>Destaque da Semana</h1>
            <p>Talves esse video pode te interessar de uma olhada</p>
            <a href="#" id="featured-video-btn" class="btn"><i data-feather="play-circle"></i>Assistir Agora</a>
        </section>
        <section class="video-content">
            <div class="video-section-header">
                <h2>Recomendados</h2>
                <div class="filter-options">
                    <a href="#" class="active" data-sort="random">Aleatório</a>
                    <a href="#" data-sort="views">Mais Vistos</a>
                    <a href="#" data-sort="likes">Mais Gostados</a>
                    <a href="#" data-sort="recent">Recentes</a>
                    <a href="#" data-sort="hidden">Ocultos</a>
                </div>
            </div>
            <div class="video-grid"></div>
            <nav class="pagination">
                <a href="#" class="arrow"><i data-feather="arrow-left"></i></a>
                <a href="#" class="active">1</a><a href="#">2</a><a href="#">3</a><a href="#">4</a><a href="#">5</a>
                <a href="#" class="arrow"><i data-feather="arrow-right"></i></a>
            </nav>
        </section>
    </main>

    <style>
    /* --- Estilos do Menu Mobile dedicado --- */
    #mobile-menu-btn {
        display: none; /* Escondido por padrão */
    }
    .mobile-view #mobile-menu-btn {
        display: block; /* Visível apenas na visualização móvel */
    }

    .mobile-menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--background-color);
        z-index: 2500;
        display: flex;
        flex-direction: column;
        padding: 20px;
        transform: translateX(-100%);
        transition: transform 0.4s ease-in-out;
    }
    .mobile-menu-overlay.active {
        transform: translateX(0);
    }
    #mobile-menu-close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        color: var(--secondary-text-color);
        font-size: 2.5rem;
        cursor: pointer;
    }
    #mobile-menu-content {
        margin-top: 60px; /* Espaço para o botão de fechar */
        width: 100%;
        overflow-y: auto;
    }
    /* Estilos para os itens clonados dentro do menu mobile */
    #mobile-menu-content .logo {
        justify-content: center; /* Centraliza o logo */
        font-size: 2rem;
        margin-bottom: 30px;
    }
    #mobile-menu-content .nav-menu a {
        justify-content: center;
        padding: 20px 10px;
        font-size: 1.2rem;
    }
    #mobile-menu-content .categories {
        text-align: center;
        margin-top: 20px;
    }
    #mobile-menu-content .categories h3 {
        font-size: 1.3rem;
    }
    #mobile-menu-content .categories ul li a {
        padding: 15px 10px;
        font-size: 1.1rem;
    }


    /* --- Estilos para a Visualização Móvel --- */
    .mobile-view .sidebar {
        width: 0;
        padding: 0;
        overflow: hidden; /* Esconde o conteúdo da sidebar */
        border-right: none;
    }
    .mobile-view .sidebar:hover {
        width: 0; /* Impede o hover de expandir */
    }
    .mobile-view .page-wrapper {
        width: 100%;
        margin-left: 0;
    }
    .mobile-view .footer-links-wrapper {
        margin-left: 0;
    }
    .mobile-view .main-content {
        padding: 10px;
    }
    .mobile-view .header {
        flex-wrap: wrap; /* Permite que a barra de busca vá para baixo */
        gap: 10px;
    }
    .mobile-view .search-bar {
        width: 100%;
        order: 3; /* Faz a barra de busca ir para a última posição */
    }
    .mobile-view .search-bar input,
    .mobile-view .search-bar input:focus {
        width: 100%; /* Ocupa toda a largura disponível */
    }
    .mobile-view .featured-mural {
        height: 250px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .mobile-view .featured-mural h1 {
        font-size: 1.8rem;
    }
    .mobile-view .featured-mural p {
        max-width: 100%;
        font-size: 0.9rem;
        margin-bottom: 15px;
    }
    .mobile-view .video-section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    .mobile-view .filter-options {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-left: 0;
    }
    .mobile-view .filter-options a {
        margin-left: 0;
    }
    .mobile-view .video-grid {
        grid-template-columns: repeat(2, 1fr); /* DUAS colunas para vídeos maiores */
        gap: 15px; /* Aumenta um pouco o espaçamento */
    }

    /* Ajustes de fonte e espaçamento para os cards no mobile */
    .mobile-view .video-card .video-info {
        padding: 12px; /* Aumenta um pouco o padding */
    }

    .mobile-view .video-card .video-info h4 {
        font-size: 0.9rem; /* Aumenta a fonte do título */
        margin-bottom: 6px;
    }

    .mobile-view .video-card .video-meta {
        font-size: 0.8rem; /* Aumenta a fonte dos ícones */
        gap: 10px;
    }
    
    .mobile-view .video-card .video-meta i {
        width: 14px; /* Aumenta o tamanho dos ícones */
    }

    .mobile-view .video-card .video-category {
        font-size: 0.7rem; /* Aumenta um pouco a tag de categoria */
        padding: 2px 6px;
        margin-top: 6px;
    }
    
    /* Ajusta o tamanho dos badges PRO e NOVO para a nova grade */
    .mobile-view .video-card .pro-badge-overlay,
    .mobile-view .video-card .new-badge-overlay {
        font-size: 0.7rem;
        padding: 2px 6px;
        top: 6px;
        left: 6px;
    }
    .mobile-view .video-card .new-badge-overlay {
        bottom: 6px;
        top: auto; /* Garante que a propriedade top não interfira */
    }
    .mobile-view .pagination a {
        padding: 8px 12px;
        margin: 0 3px;
    }
    /* Player de Vídeo - MODO IMERSIVO MOBILE */
    .mobile-view .video-player-overlay {
        padding: 0;
        background-color: #000; /* Fundo preto para a experiência imersiva */
    }
    .mobile-view .player-wrapper {
        display: block; /* Remove o grid para empilhar o conteúdo */
        padding: 0;
        max-width: 100%;
        gap: 0;
    }
    .mobile-view .player-header {
        position: absolute; /* Coloca o header SOBRE o vídeo */
        top: 0;
        left: 0;
        right: 0;
        z-index: 10;
        background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent); /* Fundo suave */
        border-bottom: none;
        padding: 15px;
    }
    .mobile-view .player-categories {
        display: none;
    }
    .mobile-view .video-container {
        width: 100vw; /* Largura total da tela */
        height: 100vh; /* Altura total da tela */
        max-height: 100vh; /* Garante que ocupe a tela toda */
        border-radius: 0;
        background-color: #000; /* Garante fundo preto se o vídeo demorar a carregar */
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .mobile-view .video-container video {
        border-radius: 0;
        object-fit: contain; /* ESSENCIAL: Mantém a proporção do vídeo, sem cortar nada */
        max-width: 100%;
        max-height: 100%;
        /* CORREÇÃO PARA A TELA VERDE: Força a aceleração de hardware em uma nova camada */
        transform: translateZ(0);
    }
    
    /* Posiciona os detalhes e comentários ABAIXO do vídeo (visível ao rolar) */
    .mobile-view .video-player-details,
    .mobile-view .video-actions,
    .mobile-view .video-comments,
    .mobile-view .player-sidebar {
        padding: 20px; /* Adiciona um respiro para o conteúdo abaixo do vídeo */
    }

    .mobile-view .controls-left, .mobile-view .controls-right {
        gap: 8px;
    }
    .mobile-view .control-btn i {
        width: 20px;
        height: 20px;
    }
    /* Modais (Auth, Profile, Subscription, Upload) */
    .mobile-view .auth-modal,
    .mobile-view .profile-modal,
    .mobile-view .subscription-modal {
        width: 95%;
        max-height: 95vh;
        padding: 20px;
    }
    /* Chat */
    .mobile-view #chat-overlay.active {
        align-items: flex-start; /* Alinha no topo */
    }
    .mobile-view #chat-container {
        width: 100%;
        height: 100%;
        max-width: 100%;
        max-height: 100%;
        border-radius: 0;
    }
    .mobile-view #chat-list-sidebar {
        width: 100%;
        display: flex; /* Começa visível */
    }
    .mobile-view #chat-window-main {
        display: none; /* Começa escondida */
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background-color: var(--card-background-color);
        z-index: 10;
    }
    .mobile-view #chat-window-header {
        gap: 10px; /* Adjust gap */
    }
    .mobile-view #chat-back-btn {
        display: flex !important; /* Make it visible in mobile view */
        align-items: center;
        gap: 10px;
        cursor: pointer;
        padding-right: 10px;
    }
    /* Footer */
    .mobile-view .footer-info-container {
        padding: 10px;
    }
    .mobile-view .footer-info-container h2 {
        font-size: 1.5rem;
    }
    .mobile-view .footer-info-container h3 {
        font-size: 1.2rem;
    }
</style>
    
    <!-- INÍCIO DA SEÇÃO DE INFORMAÇÕES DO RODAPÉ (AGORA FORA DO MAIN-CONTENT) -->
    <style>
        .footer-info-container {
            max-width: 1200px;
            margin: 60px auto 20px auto;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            color: var(--secondary-text-color);
            display: none; /* Começa escondido */
        }
        .footer-info-container h2 {
            color: var(--primary-text-color);
            font-size: 2rem;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }
        .footer-info-container h3 {
            color: var(--primary-text-color);
            font-size: 1.5rem;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        .footer-info-container h4 {
            color: var(--accent-color);
            font-size: 1.1rem;
            margin-top: 20px;
            margin-bottom: 5px;
        }
        .footer-info-container p {
            line-height: 1.6;
            margin-bottom: 15px;
        }
        .footer-links-wrapper { /* Novo wrapper para os links */
            /* margin-left: 240px;  <-- REMOVA ESTA LINHA */
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }
        .footer-links-wrapper a {
            color: var(--secondary-text-color);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s;
        }
        .footer-links-wrapper a:hover {
            color: var(--accent-color);
        }
        .footer-links-wrapper span {
            margin: 0 10px;
        }
        .footer-links-wrapper .version-number {
            color: var(--border-color); /* Cor mais sutil para diferenciar dos links */
            cursor: default;
        }
    </style>

    </main>
    
    <footer class="footer-info-container">
        <!-- Todo o conteúdo do FAQ, Criadores e Termos continua aqui dentro -->
        <!-- Seção de Perguntas Frequentes -->
        <div id="faq">
            <h2>Perguntas Frequentes</h2>
            
            <h4>Qual a idade mínima?</h4>
            <p>Você precisa ter pelo menos 18 anos para acessar o PulseRoom.</p>

            <h4>O que é o PulseRoom?</h4>
            <p>PulseRoom é uma plataforma de hospedagem que oferece uma maneira segura e fácil de carregar, armazenar e compartilhar suas fotos e vídeos. Você controla com quem compartilha seu conteúdo.</p>

            <h4>O que posso enviar?</h4>
            <p>Fotos e vídeos. Aceitamos a maioria dos formatos de arquivo.</p>
            
            <h4>Meus arquivos estão seguros?</h4>
            <p>Sim, claro! Seus arquivos são armazenados em servidores seguros. Também temos configurações de privacidade para manter todo o seu material privado.</p>
            
            <h4>E a minha privacidade?</h4>
            <p>Nós amamos a privacidade tanto quanto você e coletamos apenas os dados necessários para você fazer login e para manter a segurança do nosso site e de seus usuários. No entanto, observe que se você enviar intencionalmente conteúdo ilegal, poderemos divulgar suas informações privadas sem aviso prévio, seja proativamente ou mediante solicitação das autoridades policiais.</p>

            <h4>Posso deletar meu conteúdo?</h4>
            <p>Você pode deletar seus vídeos a qualquer momento. Nós removeremos instantaneamente todos os arquivos de nossos servidores.</p>
            
            <h4>Posso deletar minha conta?</h4>
            <p>Você pode fazer isso por si mesmo na seção de configurações da sua conta.</p>
            
            <h4>Como denuncio abusos?</h4>
            <p>Por favor, envie um e-mail para: luanamonique2222@gmail.com</p>
        </div>

        <!-- Seção para Criadores -->
        <div id="criadores" style="margin-top: 50px;">
            <h2>Para Criadores</h2>
            <p>Nós não pagamos pelo envio de vídeos para o PulseRoom, mas você pode promover seu site de fãs ou site pago no PulseRoom e obter vendas a partir de um link em sua Biografia.</p>
            <p>Quando você se torna um Criador de Conteúdo verificado, seu perfil se destacará e atrairá mais atenção.</p>
            
            <h3>Regras</h3>
            <ul>
                <li><p>Apenas conteúdo de qualidade é aceito para não ser considerado spam e degradar o site.</p></li>
                <li><p>Isso implica: sem cenas cortadas, sem compilações e vídeos com um final lógico.</p></li>
                <li><p>Nenhuma menção à "versão completa" disponível em outro lugar, como em um site pago.</p></li>
                <li><p>Sem marcas d'água exageradas e irritantes.</p></li>
            </ul>

            <h3>Como faço?</h3>
            <p>Cadastre sua conta, vá para as Configurações do seu perfil e clique no link para "tornar-se verificado".</p>
        </div>

        <!-- Seção de Termos e Privacidade -->
        <div id="termos" style="margin-top: 50px;">
            <h2>Termos & Privacidade</h2>
            <p>Bem-vindo ao PulseRoom! Seu uso e acesso ao PulseRoom, referido como serviço, site ou website, estão incluídos abaixo. Você está aceitando estes termos ao usar este serviço. Se necessário, estes termos podem ser alterados.</p>
            
            <h3>Seu Conteúdo</h3>
            <p>Nestes termos, "seu conteúdo" significa o material (vídeos, fotos, texto, etc.) que você envia para este website. Seu conteúdo é seu.</p>
            <p>Precisamos da sua permissão para fazer coisas como hospedar e exibir seu conteúdo em conexão com o site. Nosso serviço também oferece recursos como miniaturas de fotos e vídeos, edição e compartilhamento. Você nos dá permissão para fazer essas coisas.</p>
            <p>Estes termos não nos dão nenhum direito ao seu conteúdo de usuário, exceto pelos direitos limitados que nos permitem oferecer o serviço.</p>
            <p>Após a exclusão, seu conteúdo é completamente removido do site.</p>
            <p>Reservamo-nos o direito de analisar o material enviado e remover qualquer conteúdo que não esteja em conformidade com o serviço. Seu conteúdo deve aderir às leis e regulamentos aplicáveis. Conteúdo que retrata menores de idade é estritamente proibido.</p>
            
            <h3>Sem Garantias e Responsabilidades</h3>
            <p>Este website é oferecido em sua forma atual, sem garantia.</p>
            <p>Nada neste website significa, ou pretende significar, qualquer tipo de conselho.</p>
            <p>Não seremos responsáveis perante você em relação ao conteúdo, uso ou perdas de qualquer forma em conexão com o serviço. Você aceita indenizar, defender e isentar o serviço de quaisquer perdas, responsabilidades e despesas relacionadas ou decorrentes do seu uso ou incapacidade de usar o serviço.</p>

            <h3>Privacidade</h3>
            <p>Nós respeitamos sua privacidade. Esta declaração de privacidade oferece informações sobre nossas práticas com respeito às informações individuais e públicas que podemos coletar, utilizar e revelar utilizando o serviço. É, portanto, sua obrigação legal revisar e aceitar esta política.</p>

            <h3>Informações Coletadas</h3>
            <p>Nós coletamos em contas padrão seu e-mail (opcional) e endereços IP para identificação ao visitar e utilizar o serviço.</p>
            <p>Também podemos coletar automaticamente informações relacionadas ao hardware e software do seu computador. Esta informação pode incluir: endereços IP, tipo de navegador, nomes de domínio, tempos de acesso e endereços de sites de referência. Esta informação é utilizada para a operação, para manter a qualidade do serviço e disponibilizar estatísticas gerais sobre o uso do Site. Não vendemos, alugamos ou compartilhamos listas e informações de clientes com terceiros.</p>
            <p>Estamos usando o Google Analytics para entender melhor como o site está sendo usado. Para mais informações sobre o Google Analytics, por favor, visite https://support.google.com/analytics/answer/6004245.</p>

            <h3>Anúncios</h3>
            <p>Podemos usar empresas de publicidade de terceiros para veicular anúncios quando você usa o serviço. Essas empresas podem usar informações sobre suas visitas a este e a outros sites para fornecer anúncios sobre bens e serviços de seu interesse. Se você quiser mais informações sobre essa prática e conhecer suas opções para não ter essa informação usada por essas empresas para publicidade baseada em interesses, por favor, visite http://www.aboutads.info/choices/.</p>

            <h3>Cookies</h3>
            <p>Solicitamos a você a coleta, uso e armazenamento de "Cookies" através de nossos servidores web. Podemos enviar pelo menos um cookie para o seu computador que reconhece exclusivamente sua sessão de navegador. No entanto, os recursos do site podem ficar indisponíveis se você considerar recusar os cookies.</p>

            <h3>Divulgação de Informações</h3>
            <p>Divulgaremos todas as informações privadas se você enviar intencionalmente qualquer material ilegal para o serviço, sem aviso prévio, e qualquer outra informação relevante, desde que seja solicitado legalmente ou de boa-fé. Divulgaremos todas as informações privadas se solicitado pela aplicação da lei em qualquer um dos países operacionais.</p>

            <h3>Segurança</h3>
            <p>Assumiremos todas as precauções razoáveis e técnicas para impedir a perda, uso indevido ou alteração de suas informações privadas e públicas. Todas as informações são armazenadas em nossos servidores protegidos.</p>
            <p>Você pode nos enviar um e-mail para luanamonique2222@gmail.com se tiver alguma dúvida ou acreditar que alguém usou indevidamente qualquer um destes termos.</p>
        </div>
        
        <!-- Seção de Denúncia de Abuso -->
        <div id="abuse" style="margin-top: 50px;">
            <h2>Denúncia de Abuso</h2>
            <p>O PulseRoom tem uma política de tolerância zero contra a exploração e o abuso de menores. É estritamente proibido o upload, compartilhamento ou visualização de qualquer conteúdo que envolva indivíduos menores de 18 anos.</p>
            <p>Se você encontrar qualquer conteúdo que suspeite envolver menores de idade, é seu dever cívico e moral reportá-lo imediatamente utilizando o botão "Reportar" <i data-feather="flag" style="width:14px; vertical-align: middle;"></i> no vídeo. Levamos todas as denúncias dessa natureza com a máxima seriedade e urgência. A sua ajuda é fundamental para mantermos o PulseRoom um ambiente seguro e respeitoso para todos os adultos.</p>
            
            <h4 style="margin-top: 30px;">Conteúdo Não Autorizado</h4>
            <p>Da mesma forma, levamos a sério a privacidade e o consentimento. Se você encontrar um vídeo que mostra você, um membro da sua família ou alguém que você conhece, e essa postagem não foi autorizada, por favor, utilize a função "Reportar" no vídeo imediatamente para que nossa equipe possa analisar a situação.</p>

            <h4 style="margin-top: 30px;">Origem e Responsabilidade do Conteúdo</h4>
            <p>É fundamental esclarecer que o PulseRoom atua como uma plataforma de agregação e hospedagem de conteúdo. Nós não produzimos, criamos, incentivamos ou encorajamos a realização de qualquer tipo de atividade retratada nos vídeos. O conteúdo disponível em nosso site é compilado a partir de fontes de terceiros já existentes e publicamente disponíveis na internet, como ThisVid, Motherless, fóruns diversos, XVideos, Erome, entre outros. Reiteramos que somos contra a prática de qualquer ato ilegal e reforçamos que nenhum dos vídeos hospedados na plataforma foi produzido ou enviado por nossos usuários ou assinantes. Nossa função é exclusivamente a de catalogar e disponibilizar links para materiais já em circulação na web.</p>
        </div>
    </footer>
    <!-- FIM DA SEÇÃO DE INFORMAÇÕES DO RODAPÉ -->

        <!-- OS LINKS AGORA FICAM EM UM WR 2805 APPER SEPARADO E SEMPRE VISÍVEL -->
    <div class="footer-links-wrapper">
        <a href="#faq">FAQ</a>
        <span>-</span>
        <a href="#criadores">Criadores</a>
        <span>-</span>
        <a href="#termos">Termos & Privacidade</a>
        <span>-</span>
        <a href="#" class="support-chat-link">Suporte</a>
        <span>-</span>
        <a href="#abuse">Abuso</a>
        <span>-</span>
        <span class="version-number">v12.07</span>
    </div>
</div> <!-- FIM DO page-wrapper -->

    <!-- NOVA JANELA DE PLAYER DE VÍDEO -->
<div id="video-player-overlay" class="video-player-overlay">
        <header class="player-header">
            <div class="player-logo">
                <img src="https://yxdjmyqkltaqjulfkcuu.supabase.co/storage/v1/object/public/thumbnails/rabbit.png" alt="PulseRoom Logo" class="logo-icon">
                <span>PulseRoom</span>
            </div>
            <nav id="player-categories" class="player-categories"></nav>
            <button id="player-close-btn" class="player-close-btn"><i data-feather="arrow-left"></i> Voltar</button>
        </header>
        <div class="player-wrapper">
            <div class="player-main">
                <!-- O container do vídeo agora tem uma classe extra para o CSS e JS -->
                <div class="video-container custom-video-player">
                    <!-- ATENÇÃO: O atributo "controls" foi removido do vídeo -->
                    <video id="main-player-video" controlslist="nodownload" oncontextmenu="return false;" playsinline preload="metadata"></video>

                    <!-- Nossos novos controles customizados -->
                    <div class="custom-controls-container">
                        <div class="progress-bar">
                            <div class="progress-buffered"></div> <!-- BARRA DE BUFFER ADICIONADA -->
                            <div class="progress-filled"></div>
                        </div>
                        <div class="controls-main">
                           <div class="controls-left">
                                <button id="play-pause-btn" class="control-btn"><i data-feather="play"></i></button>
                                <div class="volume-container">
                                    <button id="volume-btn" class="control-btn"><i data-feather="volume-2"></i></button>
                                    <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
                                </div>
                           </div>
                           <div class="controls-right">
                                <div class="quality-selector">
                                    <span class="quality-label">Qualidade:</span>
                                    <button id="quality-btn" class="quality-btn">SD</button>
                                    <ul id="quality-options-list" class="quality-options">
                                        <li data-quality="hd">Full HD <span class="pro-badge">PRO</span></li>
                                        <li data-quality="sd">SD</li>
                                    </ul>
                                </div>
                                <button id="download-video-btn" class="control-btn" title="Baixar Vídeo"><i data-feather="download"></i></button>
                                <button id="fullscreen-btn" class="control-btn"><i data-feather="maximize"></i></button>
                           </div>
                        </div>
                    </div>
                </div>
                <div class="video-player-details">
    <h2 id="player-video-title"></h2>
    <div id="player-category-container" style="margin-top: 10px; margin-bottom: 15px;">
        <a href="#" id="player-video-category-btn" class="video-category" style="text-decoration: none; cursor: pointer;"></a>
    </div>
    <p id="player-video-description"></p>
</div>
                <div class="video-actions">
                    <div class="action-btn"><i data-feather="eye"></i><span id="view-count">-</span></div>
                    <button id="like-btn" class="action-btn"><i data-feather="thumbs-up"></i><span id="like-count">-</span></button>
                    <button id="dislike-btn" class="action-btn"><i data-feather="thumbs-down"></i><span id="dislike-count">-</span></button>
                    <button id="share-btn" class="action-btn"><i data-feather="share-2"></i><span>Compartilhar</span></button>
                    <button id="report-video-btn" class="action-btn"><i data-feather="flag"></i><span>Reportar</span></button>
                </div>
                <div class="video-comments">
                    <h3><span id="comment-count">0</span> Comentários</h3>
                    <form id="comment-form" class="comment-form logged-out">
                        <img id="comment-user-avatar" src="" alt="Seu avatar">
                        <input type="text" id="comment-input" placeholder="Adicionar um comentário..." required>
                        <button type="submit">Comentar</button>
                    </form>
                    <div id="comments-list" class="comments-list">
                        <!-- Comentários serão inseridos aqui -->
                    </div>
                </div>
            </div>
            <div class="player-sidebar">
                <h3>Recomendados</h3>
                <div id="recommendations-list"></div>
            </div>
        </div>
    </div>

<!-- Firebase SDKs (Versão 8 - Necessária para o código atual) -->
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <!-- Supabase SDK -->
    <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        feather.replace();

        // --- CONFIGURAÇÃO SUPABASE (Constantes Globais) ---
        const SUPABASE_URL = 'https://yxdjmyqkltaqjulfkcuu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4ZGpteXFrbHRhcWp1bGZrY3V1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MjYwMDYsImV4cCI6MjA3NjQwMjAwNn0.z1wvppEflLjG289s5One1ihbfQJjfNfS7svgbAgFGLs';

        // --- VARIÁVEIS GLOBAIS DE CONEXÃO (declaradas mas não inicializadas para aguardar o 'defer') ---
        let _supabase, fbAuth, fbDb, fbStorage;

        // Retorna um objeto Date ajustado para o fuso horário de Brasília (UTC-3)
        function getBrasiliaDate() {
            const now = new Date();
            const timezoneOffset = now.getTimezoneOffset() * 60000;
            const utcTime = now.getTime() + timezoneOffset;
            const brasiliaOffset = -3 * 3600 * 1000;
            return new Date(utcTime + brasiliaOffset);
        }

                        // --- VARIÁVEIS GLOBAIS ---
        let _allVideosCache = []; // NOVO: Cache com TODOS os vídeos para as recomendações
        let allFetchedVideos = [];
        let currentViewVideos = []; // Armazena a lista de vídeos que está sendo exibida (pode ser a lista completa, de busca, de curtidos, etc.)
        let currentPage = 1;
        const videosPerPage = 9; // 3 colunas x 3 linhas
        let categoriesMap = new Map();
        let currentUserProfile = null;
        let likesListener = null;
        let commentsListener = null;
        let timeSpentInterval = null; // Para o contador de tempo online
        let proPaymentListener = null; // Listener para pagamentos PRO pendentes
        let proPaymentRef = null; // Referência para o listener de pagamento
        let userPendingPaymentId = null; // ID da confirmação de pagamento pendente
        let guestSessionId = null;
        let guestPresenceInterval = null;
        let originalPageTitle = document.title;

        // --- Variáveis do Chat ---
        let activeChatId = null;
        let chatMessageListener = null;
        let chatMessageRef = null; // Referência para o listener de mensagens
        let chatListListener = null;
        let chatListRef = null; // Referência para o listener da lista de chats
        let unreadChatsListener = null; // Listener global para o contador de não lidas
        let unreadChatsRef = null; // Referência para o listener global
        let recipientForNewChat = null; // Guarda o ID do usuário para nova conversa

        // --- FUNÇÕES DE AUTENTICAÇÃO E PERFIL (FIREBASE) ---
        function openAuthModal() { document.getElementById('auth-overlay').classList.add('active'); }
        function closeAuthModal() { document.getElementById('auth-overlay').classList.remove('active'); }
        function openProfileModal() { document.getElementById('profile-overlay').classList.add('active'); populateProfileData(); }
        function closeProfileModal() { document.getElementById('profile-overlay').classList.remove('active'); }

        function openChatOverlay() {
            if (!currentUserProfile) { openAuthModal(); return; }
            document.body.classList.add('body-no-scroll'); // TRAVA A ROLAGEM
            document.getElementById('chat-overlay').classList.add('active');
            document.getElementById('main-chat-badge').style.display = 'none';
            loadUserConversations(currentUserProfile.uid);
            feather.replace();
        }

        function closeChatOverlay() {
            document.body.classList.remove('body-no-scroll'); // DESTRAVA A ROLAGEM
            document.getElementById('chat-overlay').classList.remove('active');
            // Limpa listeners da forma correta para economizar recursos
            if (chatMessageRef && chatMessageListener) {
                chatMessageRef.off('child_added', chatMessageListener);
            }
            if (chatListRef) { // Agora o chatListRef usa múltiplos listeners
                chatListRef.off();
            }

            // Garante que a visualização do chat seja redefinida para o modo móvel
            if (document.body.classList.contains('mobile-view')) {
                document.getElementById('chat-list-sidebar').style.display = 'flex';
                document.getElementById('chat-window-main').style.display = 'none';
            }

            activeChatId = null;
            chatMessageListener = null;
            chatMessageRef = null;
            chatListListener = null;
            chatListRef = null;
        }

        async function loadUserConversations(userId) {
            const chatListDiv = document.getElementById('chat-list');
            
            if (chatListRef && chatListListener) {
                chatListRef.off('value', chatListListener);
            }

            chatListRef = fbDb.ref(`profiles/${userId}/chats`);
            
            chatListListener = chatListRef.on('value', async snapshot => {
                const userChatsData = snapshot.val();

                if (!userChatsData) {
                    chatListDiv.innerHTML = '<p style="padding: 20px; text-align: center;">Nenhuma conversa encontrada.</p>';
                    return;
                }

                const chatIds = Object.keys(userChatsData);
                const chatListData = [];

                for (const chatId of chatIds) {
                    const metadataSnapshot = await fbDb.ref(`chats/${chatId}/metadata`).once('value');
                    if (metadataSnapshot.exists()) {
                        const metadata = metadataSnapshot.val();
                        const userChatInfo = userChatsData[chatId];
                        const lastSeen = userChatInfo.last_seen_timestamp || 0;
                        const isUnread = metadata.timestamp > lastSeen && metadata.lastMessageSenderId !== userId;
                        const otherParticipantId = Object.keys(metadata.participants).find(id => id !== userId);
                        chatListData.push({ id: chatId, ...metadata, otherParticipantId, isUnread });
                    }
                }
                
                chatListData.sort((a, b) => b.timestamp - a.timestamp);
                
                // PASSO 1: Criar um array de strings HTML.
                const chatItemsHTML = [];
                for (const chat of chatListData) {
                    let participantName = 'Suporte';
                    let participantAvatar = 'https://yxdjmyqkltaqjulfkcuu.supabase.co/storage/v1/object/public/thumbnails/rabbit.png';
                    if (chat.otherParticipantId !== 'support') {
                        const profileSnapshot = await fbDb.ref(`profiles/${chat.otherParticipantId}`).once('value');
                        if (profileSnapshot.exists()) {
                            const profile = profileSnapshot.val();
                            participantName = profile.full_name;
                            participantAvatar = profile.avatar_url;
                        }
                    }
                    
                    const unreadBadge = chat.isUnread ? '<span class="chat-unread-badge"></span>' : '';
                    
                    // Adiciona a string HTML ao array.
                    chatItemsHTML.push(`
                        <div class="chat-list-item" data-chat-id="${chat.id}">
                            <div style="position: relative;">
                                <img src="${participantAvatar}" alt="Avatar">
                                ${unreadBadge}
                            </div>
                            <div class="chat-info">
                                <h4>${participantName}</h4>
                                <p>${chat.lastMessage || '...'}</p>
                            </div>
                        </div>
                    `);
                }

                // PASSO 2: Substituir o conteúdo da lista DE UMA SÓ VEZ.
                // Isso garante que o DOM seja atualizado de forma atômica, eliminando o bug.
                chatListDiv.innerHTML = chatItemsHTML.join('');
            });
        }


        async function renderChatList(chatListData, currentUserId) {
            const chatListDiv = document.getElementById('chat-list');
            chatListDiv.innerHTML = '';

            for (const chat of chatListData) {
                let participantName = 'Suporte';
                let participantAvatar = 'https://yxdjmyqkltaqjulfkcuu.supabase.co/storage/v1/object/public/thumbnails/rabbit.png';

                if (chat.otherParticipantId !== 'support') {
                    const profileSnapshot = await fbDb.ref(`profiles/${chat.otherParticipantId}`).once('value');
                    const profile = profileSnapshot.val();
                    if (profile) {
                        participantName = profile.full_name;
                        participantAvatar = profile.avatar_url;
                    }
                }
                
                const unreadBadge = chat.isUnread ? '<span class="chat-unread-badge"></span>' : '';
                const item = document.createElement('div');
                item.className = 'chat-list-item';
                item.dataset.chatId = chat.id;
                item.innerHTML = `
                    <div style="position: relative;">
                        <img src="${participantAvatar}" alt="Avatar">
                        ${unreadBadge}
                    </div>
                    <div class="chat-info">
                        <h4>${participantName}</h4>
                        <p>${chat.lastMessage || '...'}</p>
                    </div>`;
                chatListDiv.appendChild(item);
            }
        }
        
        function openChat(chatId) {
            if (activeChatId === chatId) return;
            activeChatId = chatId;

            // Marca a conversa como lida no banco de dados
            fbDb.ref(`profiles/${currentUserProfile.uid}/chats/${chatId}`).update({
                last_seen_timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            // O listener 'loadUserConversations' vai cuidar de remover o emblema da UI automaticamente.
            document.querySelectorAll('.chat-list-item').forEach(item => item.classList.toggle('active', item.dataset.chatId === chatId));

            if (document.body.classList.contains('mobile-view')) {
                // No modo móvel, esconde a lista e mostra a janela de chat
                document.getElementById('chat-list-sidebar').style.display = 'none';
                document.getElementById('chat-window-main').style.display = 'flex';
                document.getElementById('active-chat-window').style.display = 'flex';
            } else {
                // No modo desktop, mostra a janela de chat ao lado da lista
                document.getElementById('chat-welcome-screen').style.display = 'none';
                document.getElementById('active-chat-window').style.display = 'flex';
            }
            
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.innerHTML = '';

            if (chatMessageRef && chatMessageListener) {
                chatMessageRef.off('child_added', chatMessageListener);
            }

            chatMessageRef = fbDb.ref(`chats/${chatId}/messages`).limitToLast(50);
            chatMessageListener = chatMessageRef.on('child_added', snapshot => {
                const message = snapshot.val();
                displayChatMessage(message);
            });
        }
        
        function displayChatMessage(message) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'chat-message';
            messageEl.classList.add(message.senderId === currentUserProfile.uid ? 'sent' : 'received');

            // Verifica o tipo de mensagem para renderizar corretamente
            if (message.mediaType === 'image') {
                messageEl.innerHTML = `<img src="${message.mediaUrl}" alt="Imagem enviada">`;
            } else if (message.mediaType === 'video') {
                messageEl.innerHTML = `<video src="${message.mediaUrl}" controls></video>`;
            } else {
                // Mensagem de texto padrão
                messageEl.textContent = message.content;
            }

            messagesDiv.prepend(messageEl);
        }

        async function handleSendMessage(event) {
            event.preventDefault();
            if (!activeChatId || !currentUserProfile) return;
            const input = document.getElementById('chat-message-input');
            const content = input.value.trim();
            if (!content) return;

            const senderId = currentUserProfile.uid;
            const message = {
                senderId: senderId,
                content: content,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            await fbDb.ref(`chats/${activeChatId}/messages`).push(message);
            await fbDb.ref(`chats/${activeChatId}/metadata`).update({
                lastMessage: content,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                lastMessageSenderId: senderId // ADICIONA O ID DE QUEM ENVIOU
            });
            // Marca o chat como lido para mim mesmo, já que acabei de enviar uma mensagem
             await fbDb.ref(`profiles/${senderId}/chats/${activeChatId}`).update({
                last_seen_timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            input.value = '';
        }

        async function startOrOpenConversation(recipientId) {
            if (!currentUserProfile || recipientId === currentUserProfile.uid) return;
            
            // Procura por um chat existente
            const chatsRef = fbDb.ref('chats');
            const query = chatsRef.orderByChild(`metadata/participants/${currentUserProfile.uid}`).equalTo(true);
            const snapshot = await query.once('value');
            
            let existingChatId = null;
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const chat = childSnapshot.val();
                    if (chat.metadata.participants[recipientId]) {
                        existingChatId = childSnapshot.key;
                    }
                });
            }

            if (existingChatId) {
                openChatOverlay();
                openChat(existingChatId);
            } else {
                // Cria um novo chat
                const newChatRef = fbDb.ref('chats').push();
                const newChatId = newChatRef.key;
                const participants = {
                    [currentUserProfile.uid]: true,
                    [recipientId]: true
                };
                
                const chatMetadata = {
                    participants,
                    createdBy: currentUserProfile.uid,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    lastMessage: "Conversa iniciada",
                    lastMessageSenderId: null // Começa como nulo
                };

                const chatData = { metadata: chatMetadata };
                
                // Apenas cria uma mensagem inicial se for o chat de suporte
                if (recipientId === 'support') {
                    const initialMessageContent = `Bem-vindo ao suporte do PulseRoom! Como podemos ajudar?`;
                    chatData.metadata.lastMessage = initialMessageContent;
                    chatData.metadata.lastMessageSenderId = 'support'; // Define 'support' como remetente
                    chatData.messages = {
                        [fbDb.ref().push().key]: {
                            senderId: 'support',
                            content: initialMessageContent,
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        }
                    };
                }

                await newChatRef.set(chatData);

                // Inicializa o chat para o usuário atual com o timestamp
                await fbDb.ref(`profiles/${currentUserProfile.uid}/chats/${newChatId}`).set({
                    last_seen_timestamp: firebase.database.ServerValue.TIMESTAMP // Já viu, pois acabou de criar/abrir
                });
                
                if (recipientId !== 'support') {
                    // Inicializa o chat para o outro usuário com timestamp 0 para que apareça como não lido
                     await fbDb.ref(`profiles/${recipientId}/chats/${newChatId}`).set({
                        last_seen_timestamp: 0
                     });
                }
                
                openChatOverlay();
                openChat(newChatId);
            }
        }
        
        // NOVA FUNÇÃO para monitorar todas as conversas e atualizar o contador principal
        function listenForUnreadChats(userId) {
            // Remove o listener antigo para evitar acúmulo
            if (unreadChatsRef && unreadChatsListener) {
                unreadChatsRef.off('value', unreadChatsListener);
            }

            unreadChatsRef = fbDb.ref(`profiles/${userId}/chats`);
            unreadChatsListener = unreadChatsRef.on('value', async snapshot => {
                const mainBadge = document.getElementById('main-chat-badge');
                if (!snapshot.exists()) {
                    mainBadge.style.display = 'none';
                    return;
                }

                const userChatsData = snapshot.val();
                const chatIds = Object.keys(userChatsData);
                let totalUnreadCount = 0;

                // Precisamos verificar cada chat individualmente
                for (const chatId of chatIds) {
                    const metadataSnapshot = await fbDb.ref(`chats/${chatId}/metadata`).once('value');
                    if (metadataSnapshot.exists()) {
                        const metadata = metadataSnapshot.val();
                        const userChatInfo = userChatsData[chatId];
                        const lastSeen = userChatInfo.last_seen_timestamp || 0;

                        // A mesma lógica corrigida: precisa ser uma mensagem nova E do outro remetente
                        if (metadata.timestamp > lastSeen && metadata.lastMessageSenderId !== userId) {
                            totalUnreadCount++;
                        }
                    }
                }
                
                // Atualiza a UI do contador principal
                if (totalUnreadCount > 0) {
                    mainBadge.textContent = totalUnreadCount;
                    mainBadge.style.display = 'flex';
                } else {
                    mainBadge.style.display = 'none';
                }
            });
        }
        
        async function handleMediaUploadAndSend(event) {
            const file = event.target.files[0];
            if (!file || !currentUserProfile || !activeChatId) {
                return;
            }
            
            const inputForm = document.getElementById('chat-input-form');
            const textInput = document.getElementById('chat-message-input');
            const sendButton = inputForm.querySelector('button[type="submit"]');
            const mediaButton = document.getElementById('chat-media-btn');

            // Desabilita o formulário durante o upload
            textInput.disabled = true;
            sendButton.disabled = true;
            mediaButton.style.pointerEvents = 'none';
            textInput.placeholder = 'Enviando mídia...';

            try {
                // 1. Criar um caminho único para o arquivo no Supabase
                const filePath = `public/${currentUserProfile.uid}/${activeChatId}/${Date.now()}_${file.name}`;
                
                // 2. Fazer o upload para o bucket 'chat_media'
                const { error: uploadError } = await _supabase.storage
                    .from('chat_media')
                    .upload(filePath, file);

                if (uploadError) throw uploadError;

                // 3. Obter a URL pública do arquivo
                const { data: urlData } = _supabase.storage
                    .from('chat_media')
                    .getPublicUrl(filePath);
                
                // 4. Determinar o tipo de mídia
                const mediaType = file.type.startsWith('image') ? 'image' : 'video';
                const lastMessageText = mediaType === 'image' ? '📷 Foto' : '📹 Vídeo';

                // 5. Salvar a mensagem no Firebase Realtime Database
                const message = {
                    senderId: currentUserProfile.uid,
                    mediaType: mediaType,
                    mediaUrl: urlData.publicUrl,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                await fbDb.ref(`chats/${activeChatId}/messages`).push(message);

                // 6. Atualizar os metadados da conversa
                await fbDb.ref(`chats/${activeChatId}/metadata`).update({
                    lastMessage: lastMessageText,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    lastMessageSenderId: currentUserProfile.uid
                });
                
                await fbDb.ref(`profiles/${currentUserProfile.uid}/chats/${activeChatId}`).update({
                    last_seen_timestamp: firebase.database.ServerValue.TIMESTAMP
                });

            } catch (error) {
                alert('Falha ao enviar a mídia: ' + error.message);
                console.error("Erro no envio de mídia:", error);
            } finally {
                // Reabilita o formulário
                textInput.disabled = false;
                sendButton.disabled = false;
                mediaButton.style.pointerEvents = 'auto';
                textInput.placeholder = 'Digite sua mensagem...';
                event.target.value = ''; // Limpa o input de arquivo
            }
        }
        
        // --- FUNÇÕES DE PAGAMENTO PENDENTE ---
        function switchPaymentMenuView(viewIdToShow) {
            document.querySelectorAll('#pending-payment-menu .payment-menu-view').forEach(view => {
                view.classList.remove('active');
            });
            const viewToShow = document.getElementById(viewIdToShow);
            if (viewToShow) {
                viewToShow.classList.add('active');
            }
        }
        
        function hidePendingPaymentUI() {
            const subscriptionsBtn = document.getElementById('subscriptions-btn');
            const clockIcon = document.getElementById('pending-payment-clock');
            const menu = document.getElementById('pending-payment-menu');

            if (clockIcon) clockIcon.style.display = 'none';
            if (subscriptionsBtn) subscriptionsBtn.title = ''; // Remove tooltip
            if (menu) menu.style.display = 'none';
            userPendingPaymentId = null;
        }

        function showPendingPaymentUI(status) {
            const subscriptionsBtn = document.getElementById('subscriptions-btn');
            const clockIcon = document.getElementById('pending-payment-clock');
            const cancelBtn = document.getElementById('cancel-pro-btn');
            const menuHeader = document.querySelector('#pending-payment-menu .payment-menu-header');
            const menuDescription = document.querySelector('#pending-payment-menu .payment-menu-description');
            
            clockIcon.style.display = 'inline-block';
            subscriptionsBtn.title = 'Seu plano PRO está em análise. Clique no relógio para mais opções.';

            // Configura o botão E os textos com base no status do pagamento
            if (status === 'canceling') {
                // Textos para cancelamento pendente
                menuHeader.textContent = 'Cancelamento Pendente';
                menuDescription.textContent = 'Sua solicitação de cancelamento do plano pro esta em analise o cancelamento da asinatura e o rembolso sera feito em menos de 24 horas para a mesma chave pix que foi enviada.';

                // Configuração do botão
                cancelBtn.textContent = 'Mudei de ideia, vou ficar com o plano';
                cancelBtn.dataset.action = 'reinstate';
                cancelBtn.style.backgroundColor = 'var(--success-color, #28a745)';

            } else { // status 'pending'
                // Textos para análise pendente
                menuHeader.textContent = 'Análise Pendente';
                menuDescription.textContent = 'Sua solicitação de plano PRO está em análise. A aprovação pode ser instantânea ou demorar de 1 a 3 horas.';
                
                // Configuração do botão
                cancelBtn.textContent = 'Cancelar Plano PRO';
                cancelBtn.dataset.action = 'cancel';
                cancelBtn.style.backgroundColor = ''; // Volta ao padrão
            }
            
            // Sempre começa na tela principal para ver o botão e texto corretos
            switchPaymentMenuView('payment-menu-main');
        }

        function listenForPendingPayment(userId) {
            // Remove o listener antigo corretamente
            if (proPaymentRef && proPaymentListener) {
                proPaymentRef.off('value', proPaymentListener);
            }

            // Guarda a nova referência na variável global
            proPaymentRef = fbDb.ref('pro_payment_confirmations').orderByChild('user_uid').equalTo(userId);
            
            // Atribui o novo listener
            proPaymentListener = proPaymentRef.on('value', snapshot => {
                if (snapshot.exists()) {
                    let foundPending = false;
                    snapshot.forEach(childSnapshot => {
                        const confirmation = childSnapshot.val();
                        if (confirmation.status === 'pending' || confirmation.status === 'canceling') {
                            userPendingPaymentId = childSnapshot.key;
                            showPendingPaymentUI(confirmation.status);
                            foundPending = true;
                        }
                    });
                    if (!foundPending) {
                        hidePendingPaymentUI();
                    }
                } else {
                    hidePendingPaymentUI();
                }
            });
        }
        
        // --- FUNÇÕES DO MODAL DE ASSINATURA ---
        function openSubscriptionModal() {
            feather.replace(); // Recarrega os ícones no modal
            document.getElementById('subscription-overlay').classList.add('active');
        }
        function closeSubscriptionModal() { document.getElementById('subscription-overlay').classList.remove('active'); }


        async function handleSignUp(event) {
            event.preventDefault();
            const form = event.target;
            const fullName = form.querySelector('#full-name').value;
            const email = form.querySelector('#signup-email').value;
            const password = form.querySelector('#signup-password').value;
            const passwordConfirm = form.querySelector('#signup-password-confirm').value;
            const age = parseInt(form.querySelector('#age').value, 10);

            if (password !== passwordConfirm) {
                alert("As senhas não coincidem. Por favor, tente novamente.");
                return;
            }
            if (age < 18) {
                alert("Você precisa ter pelo menos 18 anos.");
                return;
            }

            try {
                const userCredential = await fbAuth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Primeiro, criamos o objeto do novo perfil
                const newUserProfile = {
                    full_name: fullName,
                    age: age,
                    bio: '',
                    avatar_url: 'https://yxdjmyqkltaqjulfkcuu.supabase.co/storage/v1/object/public/avatars/public/iYCPry8dBdWV7mMwfMM2yC7jb5n2/images%20(3).jpeg',
                    creation_timestamp: firebase.database.ServerValue.TIMESTAMP,
                    pro_status: 'none' // Garante um status inicial
                };

                // Depois, salvamos no banco de dados
                await fbDb.ref('profiles/' + user.uid).set(newUserProfile);

                // **A CORREÇÃO ESTÁ AQUI:**
                // Forçamos a atualização da interface IMEDIATAMENTE com os dados do novo perfil
                // Isso evita o problema de timing com o auto-login.
                updateUIAfterLogin({ uid: user.uid, ...newUserProfile });
                
                form.reset();
                closeAuthModal();
            } catch (error) {
                alert("Erro ao criar conta: " + error.message);
            }
        }

        function manageGuestPresence() {
            if (guestPresenceInterval) return;

            guestSessionId = sessionStorage.getItem('guestSessionId');
            if (!guestSessionId) {
                guestSessionId = fbDb.ref('guest_sessions').push().key;
                sessionStorage.setItem('guestSessionId', guestSessionId);
            }

            const guestRef = fbDb.ref(`guest_sessions/${guestSessionId}`);
            
            guestRef.set({ last_seen: firebase.database.ServerValue.TIMESTAMP });
            guestRef.onDisconnect().remove();

            guestPresenceInterval = setInterval(() => {
                if (guestSessionId) {
                    fbDb.ref(`guest_sessions/${guestSessionId}`).update({ last_seen: firebase.database.ServerValue.TIMESTAMP });
                }
            }, 60000); 
        }

        function clearGuestPresence() {
            if (guestPresenceInterval) {
                clearInterval(guestPresenceInterval);
                guestPresenceInterval = null;
            }
            guestSessionId = sessionStorage.getItem('guestSessionId');
            if (guestSessionId) {
                fbDb.ref(`guest_sessions/${guestSessionId}`).remove();
                sessionStorage.removeItem('guestSessionId');
                guestSessionId = null;
            }
        }
        
        async function handleSignIn(event) {
            event.preventDefault();
            const form = event.target;
            const email = form.querySelector('#login-email').value;
            const password = form.querySelector('#login-password').value;
            try {
                await fbAuth.signInWithEmailAndPassword(email, password);
                form.reset();
                closeAuthModal();
            } catch (error) {
                // MENSAGEM DE ERRO PERSONALIZADA (AGORA CORRIGIDA)
                // Verifica todos os possíveis erros de login e mostra uma única mensagem amigável.
                if (error.code === 'auth/invalid-credential' || 
                    error.code === 'auth/wrong-password' || 
                    error.code === 'auth/user-not-found' ||
                    error.code === 'auth/invalid-email') {
                    alert("Email ou senha incorretos.");
                } else {
                    // Para qualquer outro erro inesperado, mostra uma mensagem genérica.
                    alert("Ocorreu um erro durante o login. Tente novamente.");
                    console.error("Erro de login não tratado:", error); // Loga o erro técnico para o desenvolvedor
                }
            }
        }

        async function handleLogout() {
            try {
                if (currentUserProfile) {
                    await fbDb.ref(`online_status/${currentUserProfile.uid}`).remove();
                }
                if (timeSpentInterval) clearInterval(timeSpentInterval); // Para o contador
                // Desliga o listener de pagamento pendente da forma correta
                if (proPaymentRef && proPaymentListener) {
                    proPaymentRef.off('value', proPaymentListener);
                    proPaymentListener = null;
                    proPaymentRef = null;
                }
                hidePendingPaymentUI(); // Garante que a UI seja limpa
                await fbAuth.signOut();
                closeProfileModal();
                alert("Você saiu da sua conta.");
            } catch (error) {
                alert("Erro ao fazer logout: " + error.message);
            }
        }
        
        function updateUIAfterLogin(profile) {
            currentUserProfile = profile;
            const avatarUrl = profile.avatar_url || 'https://i.pinimg.com/236x/55-6e-2e/556e2edc7518c0e5cb4d59aef6729b24.jpg';
            const mainAvatar = document.getElementById('main-user-avatar');
            
            mainAvatar.src = avatarUrl;
            mainAvatar.style.display = 'block'; // Mostra a imagem
            
            document.getElementById('comment-user-avatar').src = avatarUrl;
        }

function resetUIToLoggedOut() {
            currentUserProfile = null;
            const avatarContainer = document.getElementById('main-avatar-container');
            const loginBtn = document.getElementById('login-prompt-btn');
            const commentForm = document.getElementById('comment-form'); // Pega o formulário
            
            avatarContainer.style.display = 'none';
            document.getElementById('main-user-avatar').src = '';
            loginBtn.style.display = 'block';
            
            // Adiciona a classe ao formulário para esconder o avatar via CSS
            if (commentForm) {
                commentForm.classList.add('logged-out');
            }
            
            if (fbDb) {
                fbDb.ref('notifications').off();
            }
        }

        // --- LÓGICA DE NOTIFICAÇÕES ---
        let unreadNotifs = 0;
        // A variável lastNotifTimestamp foi removida daqui.

        function listenForNotifications(startTime) {
            // Se não houver um tempo de início (primeiro login do usuário),
            // usamos o tempo atual para não buscar todas as notificações da história.
            const effectiveStartTime = startTime || Date.now();

            const notifRef = fbDb.ref('notifications').orderByChild('timestamp').startAt(effectiveStartTime);
            notifRef.on('child_added', snapshot => {
                const notif = snapshot.val();
                // A verificação extra é importante para evitar duplicatas em certas condições
                if (notif.timestamp > effectiveStartTime) {
                    unreadNotifs++;
                    updateNotificationUI(notif);
                }
            });
        }

        function handleGetProPlan() {
            const planCard = document.querySelector('.plan-card');
            const loadingArea = document.getElementById('payment-loading-area');
            const pixArea = document.getElementById('pix-payment-area');

            // 1. Esconde o plano e mostra a mensagem de carregamento
            planCard.style.display = 'none';
            loadingArea.querySelector('h4').textContent = 'Gerando seu código de pagamento...';
            loadingArea.style.display = 'block';
            pixArea.style.display = 'none';

            // 2. Simula um pequeno atraso para o usuário ver a mensagem
            setTimeout(() => {
                // 3. Esconde o carregamento e mostra a área de pagamento
                loadingArea.style.display = 'none';
                pixArea.style.display = 'block';
            }, 1500); // 1.5 segundos de "carregamento"
        }


        function updateNotificationUI(notif = null) {
            const badge = document.querySelector('.notification-badge');
            const list = document.querySelector('#notification-list ul');

            // Atualiza o contador
            if (unreadNotifs > 0) {
                badge.textContent = unreadNotifs;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }

            // Adiciona um novo item à lista
            if (notif && list) {
                const li = document.createElement('li');
                li.dataset.videoId = notif.videoId; // Guardamos o ID para o clique
                li.innerHTML = `
                    <p>${notif.message || 'Novo vídeo disponível!'}</p>
                    <div class="notification-time">${new Date(notif.timestamp).toLocaleString()}</div>`;
                list.prepend(li); // Adiciona no topo da lista
            }
        }

        function updateUIAfterLogin(profile) {
            currentUserProfile = profile; // Isso agora inclui o objeto pro_info
            const avatarUrl = profile.avatar_url || 'https://i.pinimg.com/236x/55-6e-2e/556e2edc7518c0e5cb4d59aef6729b24.jpg';
            
            // Seleciona todos os elementos uma vez, verificando se existem
            const mainAvatar = document.getElementById('main-user-avatar');
            const avatarContainer = document.getElementById('main-avatar-container');
            const loginBtn = document.getElementById('login-prompt-btn');
            const commentAvatar = document.getElementById('comment-user-avatar');
            const commentForm = document.getElementById('comment-form'); // Pega o formulário

            if (mainAvatar) mainAvatar.src = avatarUrl;
            if (avatarContainer) avatarContainer.style.display = 'block';
            if (loginBtn) loginBtn.style.display = 'none';
            
            if (commentAvatar) {
                commentAvatar.src = avatarUrl;
            }
            // Remove a classe do formulário para que o CSS mostre o avatar
            if (commentForm) {
                commentForm.classList.remove('logged-out');
            }
            
            const isPro = profile.pro_info?.status === 'active';

            // Lógica para status PRO
            if (mainAvatar) mainAvatar.style.border = isPro ? '3px solid gold' : '2px solid var(--accent-color)';
            if (commentAvatar) commentAvatar.classList.toggle('pro-avatar-border', isPro);
            
            // Atualiza os avatares nos outros modais também
            const profileAvatar = document.getElementById('profile-avatar-img');
            const proBadge = document.getElementById('pro-badge');
            const mainProBadge = document.getElementById('main-pro-badge');
            if (profileAvatar) profileAvatar.style.border = isPro ? '3px solid gold' : '3px solid var(--accent-color)';
            if (proBadge) proBadge.style.display = isPro ? 'inline-block' : 'none';
            if (mainProBadge) mainProBadge.style.display = isPro ? 'block' : 'none';
        }

        function resetUIToLoggedOut() {
            currentUserProfile = null;
            const avatarContainer = document.getElementById('main-avatar-container');
            const loginBtn = document.getElementById('login-prompt-btn');
            const commentAvatar = document.getElementById('comment-user-avatar');
            const defaultAvatar = 'https://i.pinimg.com/236x/55-6e-2e/556e2edc7518c0e5cb4d59aef6729b24.jpg';
            
            avatarContainer.style.display = 'none';
            document.getElementById('main-user-avatar').src = '';
            document.getElementById('main-user-avatar').style.border = '2px solid var(--accent-color)';
            loginBtn.style.display = 'block';
            
            commentAvatar.src = defaultAvatar;
            commentAvatar.classList.remove('pro-avatar-border');
            fbDb.ref('notifications').off();
        }

        

        function switchAuthForm(formToShow) {
            document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
            document.querySelectorAll('.auth-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${formToShow}-form`).classList.add('active');
            document.querySelector(`.auth-tab-btn[data-form="${formToShow}"]`).classList.add('active');
        }

        function populateProfileData() {
            if (!currentUserProfile) return;
            document.getElementById('profile-avatar-img').src = currentUserProfile.avatar_url;
            document.getElementById('profile-user-name').textContent = currentUserProfile.full_name;
            document.getElementById('profile-user-age').textContent = `Idade: ${currentUserProfile.age}`;
            document.getElementById('profile-bio-textarea').value = currentUserProfile.bio || '';
            document.getElementById('profile-gender-select').value = currentUserProfile.gender || 'Não informado';

            // Calcula e exibe tempo de conta (COM CORREÇÃO PARA NaN)
            const accountAgeEl = document.getElementById('profile-account-age');
            if (currentUserProfile.creation_timestamp && typeof currentUserProfile.creation_timestamp === 'number') {
                const diff = Date.now() - currentUserProfile.creation_timestamp;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                accountAgeEl.textContent = `Membro há ${days} dias`;
            } else {
                // Se for uma conta nova ou sem timestamp, mostra 0 dias.
                accountAgeEl.textContent = 'Membro há 0 dias';
            }

            // Calcula e exibe tempo de atividade
            const totalMinutes = currentUserProfile.time_spent_minutes || 0;
            const hours = Math.floor(totalMinutes / 60);
            document.getElementById('profile-time-spent').textContent = `~ ${hours} horas no site`;

            fetchAndDisplayUserComments(currentUserProfile.uid);
            feather.replace();
        }

        async function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file || !currentUserProfile) return;

            // Cria um caminho único para o arquivo no Supabase Storage
            const filePath = `public/${currentUserProfile.uid}/${Date.now()}_${file.name}`;

            try {
                // 1. Faz o upload do arquivo para o bucket 'avatars' do Supabase
                const { error: uploadError } = await _supabase.storage
                    .from('avatars')
                    .upload(filePath, file);

                if (uploadError) {
                    throw uploadError;
                }

                // 2. Pega a URL pública do arquivo que acabamos de enviar
                const { data: urlData } = _supabase.storage
                    .from('avatars')
                    .getPublicUrl(filePath);
                
                const publicURL = urlData.publicUrl;

                // 3. Atualiza a URL do avatar no Firebase Realtime Database
                const profileRef = fbDb.ref(`profiles/${currentUserProfile.uid}`);
                await profileRef.update({ avatar_url: publicURL });

                // 4. FORÇA A RELEITURA DO PERFIL E ATUALIZA A UI
                // Esta é a parte crucial: buscamos os dados frescos do banco de dados
                const snapshot = await profileRef.once('value');
                const updatedProfileData = snapshot.val();
                if (updatedProfileData) {
                    // Atualiza a variável global e todos os elementos da UI (avatares, etc.)
                    updateUIAfterLogin({ uid: currentUserProfile.uid, ...updatedProfileData });
                    // Repopula os dados no modal de perfil que está aberto
                    populateProfileData(); 
                }
                
                alert("Foto de perfil atualizada!");

            } catch (error) {
                console.error("Erro no upload para o Supabase: ", error.message);
                alert("Falha ao atualizar a foto de perfil: " + error.message);
            }
        }

        async function handleBioUpdate() {
            if (!currentUserProfile) return;
            const newBio = document.getElementById('profile-bio-textarea').value;
            try {
                await fbDb.ref(`profiles/${currentUserProfile.uid}`).update({ bio: newBio });
                alert("Biografia atualizada!");
            } catch (error) {
                alert("Falha ao atualizar a biografia.");
            }
        }

        async function handleGenderUpdate() {
            if (!currentUserProfile) return;
            const newGender = document.getElementById('profile-gender-select').value;
            try {
                await fbDb.ref(`profiles/${currentUserProfile.uid}`).update({ gender: newGender });
                alert("Gênero atualizado!");
            } catch (error) {
                alert("Falha ao atualizar o gênero.");
            }
        }

        async function fetchAndDisplayUserComments(userId) {
            const commentsListDiv = document.getElementById('recent-comments-list');
            commentsListDiv.innerHTML = '<p>Buscando comentários...</p>';
            const userComments = [];
            
            const videosSnapshot = await fbDb.ref('videos').once('value');
            const videosData = videosSnapshot.val() || {};
            
            for (const videoId in videosData) {
                if (videosData[videoId].comments) {
                    for (const commentId in videosData[videoId].comments) {
                        const comment = videosData[videoId].comments[commentId];
                        if (comment.user_id === userId) {
                            // Encontra o título do vídeo correspondente nos dados já buscados do Supabase
                            const videoDetails = allFetchedVideos.find(v => v.id == videoId);
                            userComments.push({ ...comment, videoTitle: videoDetails ? videoDetails.title : 'Vídeo desconhecido' });
                        }
                    }
                }
            }

            if (userComments.length === 0) {
                commentsListDiv.innerHTML = '<p>Nenhum comentário encontrado.</p>';
                return;
            }

            commentsListDiv.innerHTML = '';
            userComments.sort((a, b) => b.timestamp - a.timestamp).slice(0, 5).forEach(comment => { // Exibe os 5 mais recentes
                const item = document.createElement('div');
                item.className = 'comment-item';
                item.innerHTML = `
                    <div class="comment-content">
                        <p class="comment-text">"${comment.content}"</p>
                        <p class="comment-video-title">Comentado em: ${comment.videoTitle}</p>
                    </div>`;
                commentsListDiv.appendChild(item);
            });
        }

        // --- FUNÇÕES DE CATEGORIA (SUPABASE) ---
        async function fetchAndDisplayCategories() {
            const sidebarList = document.getElementById('sidebar-category-list');
            const playerNav = document.getElementById('player-categories');
            // Adicionamos a referência para o select do novo modal de upload
            const uploadCategorySelect = document.getElementById('upload-video-category');
            if (!sidebarList || !playerNav || !uploadCategorySelect) return;

            const { data: categories, error } = await _supabase.from('categories').select('*').order('name');
            if (error) { console.error("Erro ao buscar categorias:", error); return; }

            // Limpa as listas antes de adicionar
            categoriesMap.clear();
            sidebarList.innerHTML = `<li><a href="#" data-category="all" class="active">Todos</a></li>`;
            playerNav.innerHTML = ''; // Limpa aqui, será populado dinamicamente depois
            uploadCategorySelect.innerHTML = '<option value="">Selecione uma categoria</option>';
            
            categories.forEach(cat => {
                categoriesMap.set(cat.slug, cat.name);
                
                // Adiciona na barra lateral
                const li = document.createElement('li');
                li.innerHTML = `<a href="#" data-category="${cat.slug}">${cat.name}</a>`;
                sidebarList.appendChild(li);

                // NÃO adiciona mais na navegação do player aqui
                
                // Adiciona no select do modal de upload do usuário
                const option = document.createElement('option');
                option.value = cat.slug;
                option.textContent = cat.name;
                uploadCategorySelect.appendChild(option);
            });
            // A função setupCategoryEventListeners() foi removida daqui e sua lógica melhorada no Passo 3
        }

        // --- FUNÇÕES DE PAGINAÇÃO ---
        function setupPagination(totalVideos) {
            const paginationNav = document.querySelector('.pagination');
            if (!paginationNav) return;
            paginationNav.innerHTML = ''; 

            const totalPages = Math.ceil(totalVideos / videosPerPage);

            if (totalPages <= 1) {
                paginationNav.style.display = 'none';
                return;
            }
            paginationNav.style.display = 'flex';

            const createPageLink = (page) => {
                const pageLink = document.createElement('a');
                pageLink.href = '#';
                pageLink.textContent = page;
                pageLink.dataset.page = page;
                if (page === currentPage) {
                    pageLink.classList.add('active');
                }
                pageLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = page;
                    renderCurrentPage();
                    window.scrollTo(0, 0); // Rola para o topo da página
                });
                return pageLink;
            };

            // Botão "Anterior"
            const prevArrow = document.createElement('a');
            prevArrow.href = '#';
            prevArrow.classList.add('arrow');
            prevArrow.innerHTML = '<i data-feather="arrow-left"></i>';
            prevArrow.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    renderCurrentPage();
                    window.scrollTo(0, 0);
                }
            });
            paginationNav.appendChild(prevArrow);

            // Links das páginas
            for (let i = 1; i <= totalPages; i++) {
                paginationNav.appendChild(createPageLink(i));
            }

            // Botão "Próximo"
            const nextArrow = document.createElement('a');
            nextArrow.href = '#';
            nextArrow.classList.add('arrow');
            nextArrow.innerHTML = '<i data-feather="arrow-right"></i>';
            nextArrow.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    renderCurrentPage();
                    window.scrollTo(0, 0);
                }
            });
            paginationNav.appendChild(nextArrow);
            feather.replace();
        }

        function renderCurrentPage() {
            // Esta função agora está mais simples: ela apenas chama a displayVideos com a página correta.
            const activeCategory = document.querySelector('#sidebar-category-list a.active').dataset.category;
            const activeSort = document.querySelector('.filter-options a.active').dataset.sort;
            
            displayVideos(activeCategory, activeSort, currentPage);
            window.scrollTo(0, 0);
        }

async function renderHiddenContentPlaceholder() {
    const videoGrid = document.querySelector('.video-grid');
    videoGrid.innerHTML = '';
    document.querySelector('.video-section-header h2').textContent = 'Conteúdo Exclusivo';

    let proThumbnails = [];
    try {
        // 1. Pega os IDs de até 20 vídeos PRO para ter uma boa variedade
        const proStatusRef = fbDb.ref('video_metadata');
        const snapshot = await proStatusRef.orderByChild('is_pro').equalTo(true).limitToLast(20).once('value');
        const proVideosData = snapshot.val() || {};
        const proVideoIds = Object.keys(proVideosData);

        if (proVideoIds.length > 0) {
            // 2. Busca os thumbnails correspondentes no Supabase
            const { data, error } = await _supabase.from('videos').select('thumbnail_url').in('id', proVideoIds);
            if (error) throw error;
            // 3. Cria uma lista limpa apenas com as URLs que existem e as embaralha
            proThumbnails = data.map(v => v.thumbnail_url).filter(Boolean);
            for (let i = proThumbnails.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [proThumbnails[i], proThumbnails[j]] = [proThumbnails[j], proThumbnails[i]];
            }
        }
    } catch (error) {
        console.error("Não foi possível carregar os thumbnails para o placeholder:", error);
    }
    
    // 4. Cria os 9 cards de placeholder
    for (let i = 0; i < 9; i++) {
        // 5. LÓGICA CORRIGIDA: Usa uma imagem PRO real. Se acabarem, repete as que já tem. Se não houver nenhuma, usa o placeholder.
        const thumbnailUrl = proThumbnails.length > 0 
            ? proThumbnails[i % proThumbnails.length] // O operador '%' garante que nunca tentaremos acessar um item que não existe
            : 'https://placehold.co/400x225/1a1a1a/333333/png?text=+';
            
        const placeholderCard = document.createElement('div');
        placeholderCard.className = 'video-card';
        placeholderCard.style.filter = 'blur(10px)';
        placeholderCard.style.pointerEvents = 'none';
        placeholderCard.innerHTML = `
            <div class="thumbnail-container">
                <img src="${thumbnailUrl}" alt="Thumbnail Borrado" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <div class="video-info">
                <h4 style="background-color: var(--hover-color); height: 1.3em; width: 80%; border-radius: 4px; opacity: 0.5;"></h4>
                 <div class="video-meta" style="margin-top: 8px;">
                    <span style="background-color: var(--hover-color); height: 1em; width: 40px; display: inline-block; border-radius: 4px; opacity: 0.5;"></span>
                    <span style="background-color: var(--hover-color); height: 1em; width: 40px; display: inline-block; border-radius: 4px; opacity: 0.5;"></span>
                </div>
            </div>`;
        videoGrid.appendChild(placeholderCard);
    }

    // Adiciona o botão "Torne-se Pro" sobre a grade borrada
    const proButtonOverlay = document.createElement('div');
    proButtonOverlay.style.position = 'absolute';
    proButtonOverlay.style.top = '50%';
    proButtonOverlay.style.left = '50%';
    proButtonOverlay.style.transform = 'translate(-50%, -50%)';
    proButtonOverlay.style.zIndex = '10';
    proButtonOverlay.style.textAlign = 'center';

    const proButton = document.createElement('button');
    proButton.innerHTML = '<i data-feather="star" style="width: 18px; height: 18px;"></i> <span>Torne-se Pro</span>';
    proButton.className = 'btn'; 
    proButton.style.backgroundColor = 'var(--accent-color)';
    proButton.style.color = 'var(--primary-text-color)';
    proButton.style.border = '2px solid rgba(255, 255, 255, 0.7)';
    proButton.style.boxShadow = '0 5px 20px rgba(0,0,0,0.6)';
    proButton.style.fontSize = '1.2rem';
    proButton.style.padding = '15px 30px';
    proButton.onclick = () => {
        if (currentUserProfile) {
            openSubscriptionModal();
        } else {
            openAuthModal();
        }
    };

    proButtonOverlay.appendChild(proButton);
    const videoContentSection = document.querySelector('.video-content');
    if (videoContentSection) {
        videoContentSection.style.position = 'relative'; 
        videoContentSection.appendChild(proButtonOverlay);
        
        const oldOverlay = document.getElementById('pro-button-overlay');
        if(oldOverlay) oldOverlay.remove();
        proButtonOverlay.id = 'pro-button-overlay';
    }

    setupPagination(0); // Esconde a paginação
    feather.replace(); // Renderiza o novo ícone do botão
}


// --- FUNÇÃO OTIMIZADA PARA EXIBIR VÍDEOS (COM PAGINAÇÃO NO SERVIDOR E FILTROS CORRIGIDOS) ---
async function displayVideos(categorySlug = 'all', sortBy = 'random', page = 1) {
    const videoGrid = document.querySelector('.video-grid');
    if (!videoGrid) return;

    // Remove o botão "Obter Pro" se ele existir de uma visualização anterior
    const proButtonOverlay = document.getElementById('pro-button-overlay');
    if (proButtonOverlay) proButtonOverlay.remove();
    document.querySelector('.video-content').style.position = 'static';
    
    document.querySelector('.video-section-header h2').textContent = 'Recomendados';
    videoGrid.innerHTML = '<p>Carregando vídeos...</p>';

    try {
        let videos = [];
        let totalVideos = 0;

        if (sortBy === 'hidden') {
            document.querySelector('.video-section-header h2').textContent = 'Conteúdo Exclusivo';
            if (currentUserProfile && currentUserProfile.pro_info?.status === 'active') {
                // Usuário é PRO, busca os vídeos PRO
                const proStatusRef = fbDb.ref('video_metadata');
                const snapshot = await proStatusRef.orderByChild('is_pro').equalTo(true).once('value');
                const proVideosData = snapshot.val() || {};
                const proVideoIds = Object.keys(proVideosData);

                if (proVideoIds.length === 0) {
                    videoGrid.innerHTML = '<p>Nenhum vídeo exclusivo encontrado no momento.</p>';
                    setupPagination(0);
                    return;
                }

                let query = _supabase.from('videos').select('*', { count: 'exact' }).in('id', proVideoIds).eq('status', 'approved');
                if (categorySlug && categorySlug !== 'all') {
                    query = query.ilike('category', categorySlug);
                }
                
                const startIndex = (page - 1) * videosPerPage;
                const endIndex = startIndex + videosPerPage - 1;
                const { data, error, count } = await query.range(startIndex, endIndex);

                if (error) throw error;
                videos = data;
                totalVideos = count;

            } else {
                // Usuário não é PRO, mostra o placeholder
                await renderHiddenContentPlaceholder();
                return; // Encerra a função aqui
            }
        } else if (sortBy === 'random') {
            const cacheKey = `randomVideoCache_${categorySlug || 'all'}`;
            const cachedItem = localStorage.getItem(cacheKey);
            const oneHour = 60 * 60 * 1000;
            let videoIds = [];

            if (cachedItem) {
                const { ids, timestamp } = JSON.parse(cachedItem);
                if (Date.now() - timestamp < oneHour) {
                    videoIds = ids;
                }
            }

            if (videoIds.length === 0) {
                let idQuery = _supabase.from('videos').select('id').eq('status', 'approved');
                if (categorySlug && categorySlug !== 'all') {
                    idQuery = idQuery.ilike('category', categorySlug);
                }
                const { data: idData, error: idError } = await idQuery;
                if (idError) throw idError;

                const freshIds = idData.map(v => v.id);
                for (let i = freshIds.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [freshIds[i], freshIds[j]] = [freshIds[j], freshIds[i]];
                }
                
                videoIds = freshIds;
                localStorage.setItem(cacheKey, JSON.stringify({ ids: videoIds, timestamp: Date.now() }));
            }

            totalVideos = videoIds.length;
            const startIndex = (page - 1) * videosPerPage;
            const pageIds = videoIds.slice(startIndex, startIndex + videosPerPage);

            if (pageIds.length > 0) {
                const { data: supabaseVideos, error: videoError } = await _supabase.from('videos').select('*').in('id', pageIds);
                if (videoError) throw videoError;
                videos = supabaseVideos.sort((a, b) => pageIds.indexOf(a.id) - pageIds.indexOf(b.id));
            }
        } else if (sortBy === 'views' || sortBy === 'likes') {
            const interactionRef = fbDb.ref('videos');
            const snapshot = await interactionRef.once('value');
            const interactionData = snapshot.val() || {};
            
            let sortedIds = Object.keys(interactionData);

            if (sortBy === 'views') {
                sortedIds.sort((a, b) => (interactionData[b].views || 0) - (interactionData[a].views || 0));
            } else { // 'likes'
                sortedIds.sort((a, b) => {
                    const likesA = interactionData[a].likes ? Object.values(interactionData[a].likes).filter(v => v === 1).length : 0;
                    const likesB = interactionData[b].likes ? Object.values(interactionData[b].likes).filter(v => v === 1).length : 0;
                    return likesB - likesA;
                });
            }

            const top50Ids = sortedIds.slice(0, 50);
            
            if (top50Ids.length > 0) {
                let supabaseQuery = _supabase.from('videos').select('*').in('id', top50Ids).eq('status', 'approved');
                 if (categorySlug && categorySlug !== 'all') {
                    supabaseQuery = supabaseQuery.ilike('category', categorySlug);
                }
                const { data: supabaseVideos, error } = await supabaseQuery;
                if (error) throw error;
                
                videos = supabaseVideos.sort((a, b) => top50Ids.indexOf(String(a.id)) - top50Ids.indexOf(String(b.id)));
            }
            
            totalVideos = videos.length;
            const startIndex = (page - 1) * videosPerPage;
            videos = videos.slice(startIndex, startIndex + videosPerPage);
        }
        // Lógica para 'recentes' e padrão
        else {
            const startIndex = (page - 1) * videosPerPage;
            const endIndex = startIndex + videosPerPage - 1;
            let supabaseQuery = _supabase.from('videos').select('*', { count: 'exact' }).eq('status', 'approved');
            if (categorySlug && categorySlug !== 'all') {
                supabaseQuery = supabaseQuery.ilike('category', categorySlug);
            }
            supabaseQuery = supabaseQuery.order('created_at', { ascending: false });
            
            const { data, error, count } = await supabaseQuery.range(startIndex, endIndex);
            if (error) throw error;
            videos = data;
            totalVideos = count;
        }

        if (!videos || videos.length === 0) {
            videoGrid.innerHTML = '<p>Nenhum vídeo encontrado.</p>';
            setupPagination(0);
            return;
        }
        
        const interactionRef = fbDb.ref('videos');
        const proStatusRef = fbDb.ref('video_metadata');
        const [interactionSnapshot, proStatusSnapshot] = await Promise.all([interactionRef.once('value'), proStatusRef.once('value')]);
        const interactionData = interactionSnapshot.val() || {};
        const proStatusData = proStatusSnapshot.val() || {};

        const combinedVideos = videos.map(video => ({
            ...video,
            views: interactionData[video.id]?.views || 0,
            likeCount: interactionData[video.id]?.likes ? Object.values(interactionData[video.id].likes).filter(v => v === 1).length : 0,
            is_pro: proStatusData[video.id]?.is_pro === true
        }));
        
        if (page === 1 && sortBy !== 'hidden') { // Não atualiza o cache principal com vídeos PRO
            allFetchedVideos = combinedVideos;
            setupFeaturedVideo();
        }

        renderVideoGrid(combinedVideos);
        setupPagination(totalVideos);
        currentPage = page;

    } catch (error) {
        console.error('Erro ao buscar ou ordenar vídeos:', error);
        videoGrid.innerHTML = '<p>Não foi possível carregar os vídeos.</p>';
        setupPagination(0);
    }
}
        
        function setupCustomVideoControls() {
            const playerWrapper = document.querySelector('.custom-video-player');
            const video = document.getElementById('main-player-video');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const progressBar = playerWrapper.querySelector('.progress-bar');
            const progressFilled = playerWrapper.querySelector('.progress-filled');
            const progressBuffered = playerWrapper.querySelector('.progress-buffered');
            const volumeBtn = document.getElementById('volume-btn');
            const volumeSlider = document.getElementById('volume-slider');
            const qualityBtn = document.getElementById('quality-btn');
            const qualityOptionsList = document.getElementById('quality-options-list');

            if (!video || !playPauseBtn || !qualityBtn) return;

            function togglePlay() { if (video.paused) { video.play(); } else { video.pause(); } }

            function updatePlayIcon() {
                const icon = video.paused ? 'play' : 'pause';
                playPauseBtn.innerHTML = `<i data-feather="${icon}"></i>`;
                feather.replace();
            }

            function updateProgressBar() {
                const percentage = (video.currentTime / video.duration) * 100;
                progressFilled.style.width = `${percentage}%`;
            }

            function scrub(e) {
                const scrubTime = (e.offsetX / progressBar.offsetWidth) * video.duration;
                video.currentTime = scrubTime;
            }

            function isMobileDevice() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            }

            function toggleFullscreen() {
                if (isMobileDevice() && typeof video.webkitEnterFullscreen === 'function') {
                    video.webkitEnterFullscreen();
                } else {
                    if (!document.fullscreenElement) {
                        playerWrapper.requestFullscreen().catch(err => {
                            console.error("Erro ao entrar em tela cheia:", err.message);
                        });
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        }
                    }
                }
            }
            
            function updateFullscreenIcon() {
                const icon = document.fullscreenElement ? 'minimize' : 'maximize';
                fullscreenBtn.innerHTML = `<i data-feather="${icon}"></i>`;
                feather.replace();
            }
            
            // A CORREÇÃO PRINCIPAL ESTÁ AQUI
            playPauseBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Impede que o clique "vaze" para o vídeo que está atrás
                togglePlay();
            });

            video.addEventListener('click', togglePlay);
            video.addEventListener('play', updatePlayIcon);
            video.addEventListener('pause', updatePlayIcon);
            video.addEventListener('timeupdate', updateProgressBar);
            progressBar.addEventListener('click', scrub);
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            document.addEventListener('fullscreenchange', updateFullscreenIcon);
            video.addEventListener('dblclick', toggleFullscreen);

            function updateBufferBar() {
                if (video.duration > 0 && video.buffered.length > 0) {
                    const bufferedEnd = video.buffered.end(video.buffered.length - 1);
                    const bufferPercentage = (bufferedEnd / video.duration) * 100;
                    progressBuffered.style.width = `${bufferPercentage}%`;
                }
            }
            video.addEventListener('progress', updateBufferBar);

            function updateVolumeIcon() {
                const icon = video.muted || video.volume === 0 ? 'volume-x' : video.volume > 0.5 ? 'volume-2' : 'volume-1';
                volumeBtn.innerHTML = `<i data-feather="${icon}"></i>`;
                feather.replace();
            }

            function handleVolumeChange() {
                video.volume = volumeSlider.value;
                video.muted = video.volume === 0;
            }

            volumeBtn.addEventListener('click', () => {
                video.muted = !video.muted;
                if (!video.muted && video.volume === 0) {
                    video.volume = 0.5;
                }
            });
            volumeSlider.addEventListener('input', handleVolumeChange);
            video.addEventListener('volumechange', () => {
                volumeSlider.value = video.volume;
                updateVolumeIcon();
            });
            updateVolumeIcon();
            volumeSlider.value = video.volume;
            
            qualityBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                qualityOptionsList.classList.toggle('active');
            });

            qualityOptionsList.addEventListener('click', (e) => {
                const targetLi = e.target.closest('li');
                if (!targetLi) return;
                const quality = targetLi.dataset.quality;
                let qualityChanged = false;

                if (quality === 'sd') {
                    if (qualityBtn.textContent !== 'SD') {
                        qualityBtn.textContent = 'SD';
                        qualityChanged = true;
                        video.classList.add('sd-quality-effect');
                    }
                } else if (quality === 'hd') {
                    if (currentUserProfile && currentUserProfile.pro_info?.status === 'active') {
                        if (qualityBtn.textContent !== 'Full HD') {
                            qualityBtn.textContent = 'Full HD';
                            qualityChanged = true;
                            video.classList.remove('sd-quality-effect');
                        }
                    } else {
                        openSubscriptionModal();
                    }
                }
                qualityOptionsList.classList.remove('active');

                if (qualityChanged) {
                    const currentTime = video.currentTime;
                    const isPaused = video.paused;
                    video.style.display = 'none'; 
                    setTimeout(() => {
                        video.style.display = 'block'; 
                        video.currentTime = currentTime;
                        if (!isPaused) { 
                            video.play(); 
                        }
                    }, 100);
                }
            });

            const downloadBtn = document.getElementById('download-video-btn');
            downloadBtn.addEventListener('click', async () => {
                if (!currentUserProfile) {
                    openAuthModal();
                    return;
                }

                if (currentUserProfile.pro_info?.status !== 'active') {
                    openSubscriptionModal();
                    return;
                }

                const videoUrl = video.src;
                const videoTitle = document.getElementById('player-video-title').textContent.trim() || 'video';
                const sanitizedTitle = videoTitle.replace(/[^a-zA-Z0-9\s]/g, "").replace(/\s+/g, '_');
                const originalIcon = downloadBtn.innerHTML;
                downloadBtn.innerHTML = `<i data-feather="loader"></i>`;
                downloadBtn.disabled = true;
                feather.replace();

                try {
                    const response = await fetch(videoUrl);
                    if (!response.ok) throw new Error('Falha na rede ao buscar o vídeo.');
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `${sanitizedTitle}.mp4`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } catch (error) {
                    console.error('Erro ao baixar o vídeo:', error);
                    alert('Não foi possível iniciar o download. Tente novamente.');
                } finally {
                    downloadBtn.innerHTML = originalIcon;
                    downloadBtn.disabled = false;
                    feather.replace();
                }
            });
        }

        function setupEventListeners() {
            const searchInput = document.querySelector('.search-bar input');
            const mainContent = document.querySelector('.main-content');
            const footerInfo = document.querySelector('.footer-info-container');

            function setActiveNav(buttonId) {
                document.querySelectorAll('.nav-menu a').forEach(a => a.classList.remove('active'));
                if (buttonId) document.getElementById(buttonId).classList.add('active');
            }

// --- BARRA DE PESQUISA ---
            searchInput.addEventListener('keyup', (event) => {
                const searchTerm = event.target.value.toLowerCase().trim();
                
                if (searchTerm.length > 2) {
                    currentViewVideos = allFetchedVideos.filter(video => 
                        video.title.toLowerCase().includes(searchTerm)
                    );
                    document.querySelector('.video-section-header h2').textContent = `Resultados para: "${searchTerm}"`;
                } else {
                    currentViewVideos = allFetchedVideos; // Se a busca for curta ou vazia, volta para a lista completa
                    document.querySelector('.video-section-header h2').textContent = `Recomendados`;
                }
                
                // Em ambos os casos, reconfigura a paginação para a nova lista e vai para a página 1
                currentPage = 1;
                setupPagination(currentViewVideos.length);
                renderCurrentPage();
            });
            
            // --- FUNÇÃO PARA VOLTAR PARA A HOME ---
            function goToHome(event) {
                event.preventDefault();
                mainContent.style.display = 'block'; // Mostra o conteúdo principal
                footerInfo.style.display = 'none';   // Esconde a seção de informações

                closePlayer();
                setActiveNav('home-btn');
                displayVideos('all', 'random');
                setupFeaturedVideo();
            }
            
            // --- BOTÕES DO LOGO ---
            document.querySelector('.sidebar .logo').addEventListener('click', goToHome);
            document.querySelector('.player-header .player-logo').addEventListener('click', goToHome);

            // --- BOTÕES DO MENU ---
            document.getElementById('home-btn').addEventListener('click', goToHome);

            document.getElementById('explore-btn').addEventListener('click', async (e) => {
                e.preventDefault();
                mainContent.style.display = 'block'; // Garante que a home esteja visível
                footerInfo.style.display = 'none';
                setActiveNav('explore-btn');
                if (allFetchedVideos.length > 0) {
                    const randomVideo = allFetchedVideos[Math.floor(Math.random() * allFetchedVideos.length)];
                    // Usa a nova função de verificação
                    tryToOpenVideo(randomVideo.id);
                }
            });

            document.getElementById('liked-videos-btn').addEventListener('click', (e) => {
                e.preventDefault();
                mainContent.style.display = 'block';
                footerInfo.style.display = 'none';
                setActiveNav('liked-videos-btn');
                displayLikedVideos();
            });

            document.getElementById('history-btn').addEventListener('click', (e) => {
                e.preventDefault();
                mainContent.style.display = 'block';
                footerInfo.style.display = 'none';
                setActiveNav('history-btn');
                displayHistory();
            });

            // --- BOTÃO DE INSCRIÇÕES ---
            document.getElementById('subscriptions-btn').addEventListener('click', (e) => {
                e.preventDefault();
                
                // Se o elemento clicado foi o próprio relógio, não faz nada,
                // pois ele tem sua própria lógica de abrir o menu.
                if (e.target.closest('#pending-payment-clock')) {
                    return;
                }

                if (currentUserProfile) {
                    // Se o usuário já é PRO, avisa.
                    if (currentUserProfile.pro_info?.status === 'active') {
                        alert('Você já faz parte do plano PRO!');
                    } 
                    // Se não for PRO (seja por não ter pago ou por ter pagamento pendente),
                    // abre o modal de inscrição/pagamento.
                    else {
                        openSubscriptionModal();
                    }
                } else {
                    // Se não estiver logado, abre o modal de login.
                    openAuthModal();
                }
            });

            // Event listener para as categorias (sidebar e player)
            document.querySelectorAll('[data-category]').forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    mainContent.style.display = 'block';
                    footerInfo.style.display = 'none';
                    setActiveNav('home-btn');
                    const category = link.dataset.category;
                    const activeSort = document.querySelector('.filter-options a.active').dataset.sort;

                    if (link.closest('#sidebar-category-list')) {
                        document.querySelectorAll('#sidebar-category-list a').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                    }
                    if (link.closest('#player-categories')) {
                        closePlayer();
                        document.querySelectorAll('#sidebar-category-list a').forEach(sideLink => sideLink.classList.toggle('active', sideLink.dataset.category === category));
                    }
                    displayVideos(category, activeSort);
                });
            });

            // Event listener para os filtros (Mais vistos, etc.)
            document.querySelectorAll('.filter-options a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.filter-options a').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    const sortBy = link.dataset.sort;
                    const activeCategory = document.querySelector('#sidebar-category-list a.active').dataset.category;
                    displayVideos(activeCategory, sortBy);
                });
            });

            // --- LÓGICA DOS LINKS DO RODAPÉ ---
            document.querySelectorAll('.footer-links-wrapper a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    mainContent.style.display = 'none'; // Esconde o conteúdo principal
                    footerInfo.style.display = 'block'; // Mostra a seção de informações

                    const targetId = link.getAttribute('href');
                    const targetElement = document.querySelector(targetId);
if (targetElement) {
                        // Rola a página para o topo da seção clicada
                        targetElement.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            });
        }

        // --- FUNÇÕES DO PLAYER E INTERAÇÕES ---

        async function tryToOpenVideo(videoId) {
            if (!videoId) return;

            // Tenta encontrar na lista global primeiro
            let videoData = allFetchedVideos.find(v => v.id == videoId);

            // Se não encontrar (ex: vídeo de outra página), busca diretamente no banco
            if (!videoData) {
                try {
                    // Busca os dados principais do Supabase
                    const { data: supabaseData, error: supabaseError } = await _supabase.from('videos').select('id, video_url, title, description').eq('id', videoId).single();
                    if (supabaseError || !supabaseData) {
                        throw new Error(supabaseError?.message || "Vídeo não encontrado no Supabase.");
                    }
                    
                    // Busca o status PRO do Firebase, que é essencial para a lógica de permissão
                    const proStatusSnapshot = await fbDb.ref(`video_metadata/${videoId}`).once('value');
                    
                    // Combina os dados necessários
                    videoData = {
                        ...supabaseData,
                        is_pro: proStatusSnapshot.val()?.is_pro === true
                    };
                } catch (err) {
                    console.error("Falha ao buscar dados do vídeo sob demanda:", err);
                    alert("Não foi possível carregar os dados deste vídeo. Tente recarregar a página.");
                    return;
                }
            }

            const isProVideo = videoData.is_pro;

            if (isProVideo) {
                // CORREÇÃO APLICADA AQUI
                if (currentUserProfile && currentUserProfile.pro_info?.status === 'active') {
                    const mockCard = { dataset: { videoId: videoData.id, videoUrl: videoData.video_url, title: videoData.title, description: videoData.description || '' } };
                    openPlayer(mockCard);
                } else if (currentUserProfile) {
                    openSubscriptionModal();
                } else {
                    openAuthModal();
                }
            } else {
                const mockCard = { dataset: { videoId: videoData.id, videoUrl: videoData.video_url, title: videoData.title, description: videoData.description || '' } };
                openPlayer(mockCard);
            }
        }

                function populateRecommendations(currentVideoId) {
            const recommendationsList = document.getElementById('recommendations-list');
            if (!recommendationsList) return;
            recommendationsList.innerHTML = '';

            const sourceVideos = _allVideosCache.length > 0 ? _allVideosCache : allFetchedVideos;
            const currentVideo = sourceVideos.find(v => v.id == currentVideoId);

            if (!currentVideo) {
                const fallbackVideos = sourceVideos.filter(v => v.id != currentVideoId).sort(() => 0.5 - Math.random()).slice(0, 10);
                renderRecommendationCards(fallbackVideos);
                return;
            }

            const currentCategory = currentVideo.category;
            const totalRecommendations = 10;
            const sameCategoryTarget = 6;

            const sameCategoryVideos = sourceVideos.filter(v => v.id != currentVideoId && v.category === currentCategory);
            const otherCategoryVideos = sourceVideos.filter(v => v.id != currentVideoId && v.category !== currentCategory);

            sameCategoryVideos.sort(() => 0.5 - Math.random());
            otherCategoryVideos.sort(() => 0.5 - Math.random());

            let finalRecommendations = [];
            const sameCategoryCount = Math.min(sameCategoryVideos.length, sameCategoryTarget);
            const otherCategoryCount = totalRecommendations - sameCategoryCount;

            finalRecommendations.push(...sameCategoryVideos.slice(0, sameCategoryCount));
            finalRecommendations.push(...otherCategoryVideos.slice(0, otherCategoryCount));

            if (finalRecommendations.length < totalRecommendations) {
                const remainingNeeded = totalRecommendations - finalRecommendations.length;
                const remainingFromOthers = otherCategoryVideos.slice(otherCategoryCount);
                finalRecommendations.push(...remainingFromOthers.slice(0, remainingNeeded));
            }
            
            finalRecommendations.sort(() => 0.5 - Math.random());
            renderRecommendationCards(finalRecommendations);
        }

        function renderRecommendationCards(videos) {
            const recommendationsList = document.getElementById('recommendations-list');
            const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);

            videos.forEach(video => {
                const recLink = document.createElement('a');
                recLink.href = `?v=${video.id}`;
                recLink.classList.add('recommendation-card-link');

                const recCard = document.createElement('div');
                recCard.className = 'recommendation-card';
                recCard.dataset.videoId = video.id;
                
                const proBadge = video.is_pro ? '<span class="pro-badge-overlay">PRO</span>' : '';
                const videoCreationDate = new Date(video.created_at);
                const isNew = videoCreationDate > twentyFourHoursAgo;
                const newBadge = isNew ? '<span class="new-badge-overlay">NOVO</span>' : '';

                recCard.innerHTML = `
                    <div class="recommendation-thumbnail-container">
                        ${proBadge}
                        ${newBadge}
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/05/Flag_of_Brazil.svg/330px-Flag_of_Brazil.svg.png" alt="Bandeira do Brasil" class="flag-overlay">
                        <img loading="lazy" src="${video.thumbnail_url}?transform=w-320,h-180" alt="Thumbnail" class="video-thumbnail-img">
                    </div>
                    <div class="recommendation-info">
                        <h4>${video.title}</h4>
                        <p>${video.duration || ''}</p>
                    </div>`;
                
                recLink.appendChild(recCard);
                recommendationsList.appendChild(recLink);
            });
        }
        
        function openPlayer(card) {
            const playerOverlay = document.getElementById('video-player-overlay');
            const mainContent = document.querySelector('.main-content');
            if (!playerOverlay || !mainContent) return;
            const videoId = card.dataset.videoId;
            const playerVideo = document.getElementById('main-player-video');
            
            const videoUrl = card.dataset.videoUrl;

            // VALIDAÇÃO: Impede a abertura do player se a URL do vídeo for inválida ou vazia
            if (!videoUrl || typeof videoUrl !== 'string' || videoUrl.trim() === '') {
                console.error("Tentativa de abrir player com URL de vídeo inválida para o ID:", videoId);
                alert("Não foi possível carregar este vídeo. A URL parece estar ausente ou corrompida.");
                return;
            }

            const videoData = allFetchedVideos.find(v => v.id == videoId);
            if (videoData) {
                playerVideo.poster = videoData.thumbnail_url;
            }

            playerVideo.classList.remove('sd-quality-effect');

            const playerNav = document.getElementById('player-categories');
            playerNav.innerHTML = '';
            const allCategories = Array.from(categoriesMap.entries());
            for (let i = allCategories.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allCategories[i], allCategories[j]] = [allCategories[j], allCategories[i]];
            }
            const randomCategories = allCategories.slice(0, 4);
            randomCategories.forEach(([slug, name]) => {
                const link = document.createElement('a');
                link.href = '#';
                link.dataset.category = slug;
                link.textContent = name;
                playerNav.appendChild(link);
            });

            fbDb.ref(`videos/${videoId}/views`).transaction(currentViews => (currentViews || 0) + 1);

            if (currentUserProfile) {
                fbDb.ref(`profiles/${currentUserProfile.uid}/history/${videoId}`).set(firebase.database.ServerValue.TIMESTAMP);
            }

            playerOverlay.dataset.currentVideoId = videoId;

            if (videoUrl.includes('.m3u8')) {
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(videoUrl);
                    hls.attachMedia(playerVideo);
                    playerVideo.hls = hls; // Guarda a instância para poder destruí-la depois
                } else if (playerVideo.canPlayType('application/vnd.apple.mpegurl')) {
                    playerVideo.src = videoUrl;
                }
            } else {
                playerVideo.src = videoUrl;
            }

            document.getElementById('player-video-title').textContent = card.dataset.title;
            const videoDataForCategory = allFetchedVideos.find(v => v.id == videoId);
            if (videoDataForCategory) {
                const categoryBtn = document.getElementById('player-video-category-btn');
                const categoryContainer = document.getElementById('player-category-container');
                const categoryName = categoriesMap.get(videoDataForCategory.category) || videoDataForCategory.category;
                if (categoryBtn && categoryContainer && categoryName) {
                    categoryBtn.textContent = categoryName;
                    categoryBtn.dataset.category = videoDataForCategory.category;
                    categoryContainer.style.display = 'block';
                } else if (categoryContainer) {
                    categoryContainer.style.display = 'none';
                }
            }
            document.getElementById('player-video-description').textContent = card.dataset.description;
            populateRecommendations(videoId);
            attachFirebaseListeners(videoId);
            mainContent.style.display = 'none';
            playerOverlay.classList.add('active');
            document.title = card.dataset.title;

            const qualityBtn = document.getElementById('quality-btn');
            if (currentUserProfile && currentUserProfile.pro_status === 'active') {
                qualityBtn.textContent = 'Full HD';
            } else {
                qualityBtn.textContent = 'SD';
                playerVideo.classList.add('sd-quality-effect');
            }
            
            setupCustomVideoControls();
            
            // CORREÇÃO: Trata a promessa do play() para evitar o AbortError
            const playPromise = playerVideo.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    if (error.name !== 'AbortError') {
                        console.error("Erro ao tentar iniciar o vídeo:", error);
                    }
                });
            }
            
            feather.replace();
        }

        function renderVideoGrid(videosToRender, categorySlug = 'all') {
            const videoGrid = document.querySelector('.video-grid');
            videoGrid.innerHTML = '';
            if (!videosToRender || videosToRender.length === 0) {
                videoGrid.innerHTML = `<p>Nenhum vídeo encontrado.</p>`;
                return;
            }
            const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);

            videosToRender.forEach(video => {
                // Cria um link <a> como invólucro para o card
                const videoLink = document.createElement('a');
                videoLink.href = `?v=${video.id}`; // Define o link para deep linking
                videoLink.classList.add('video-card-link'); // Adiciona classe para estilização

                const videoCard = document.createElement('div');
                videoCard.classList.add('video-card');
                // Os data attributes não são mais a fonte primária, mas podem ser mantidos para compatibilidade se necessário
                videoCard.dataset.videoId = video.id;
                videoCard.dataset.isPro = video.is_pro; 
                
                const categoryName = categoriesMap.get(video.category) || video.category;
                const categoryBadge = (categorySlug === 'all' && video.category) ? `<span class="video-category">${categoryName}</span>` : '';
                const proBadge = video.is_pro ? '<span class="pro-badge-overlay">PRO</span>' : '';

                const videoCreationDate = new Date(video.created_at);
                const isNew = videoCreationDate > twentyFourHoursAgo;
                const newBadge = isNew ? '<span class="new-badge-overlay">NOVO</span>' : '';

                videoCard.innerHTML = `
                    <div class="thumbnail-container">
                        ${proBadge}
                        ${newBadge}
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/05/Flag_of_Brazil.svg/330px-Flag_of_Brazil.svg.png" alt="Bandeira do Brasil" class="flag-overlay">
                        <img loading="lazy" src="${video.thumbnail_url}?transform=w-400,h-225" alt="Thumbnail do Vídeo" class="video-thumbnail-img">
                        <span class="video-duration">${video.duration || '--:--'}</span>
                        <div class="play-icon"><i data-feather="play"></i></div>
                    </div>
                    <div class="video-info">
                        <h4>${video.title}</h4>
                        <div class="video-meta" style="margin-top: 8px;">
                            <span><i data-feather="eye" style="width:14px; margin-right: 5px;"></i>${video.views || 0}</span>
                            <span><i data-feather="thumbs-up" style="width:14px; margin-right: 5px;"></i>${video.likeCount || 0}</span>
                        </div>
                        ${categoryBadge}
                    </div>`;
                
                videoLink.appendChild(videoCard); // Adiciona o card dentro do link
                videoGrid.appendChild(videoLink); // Adiciona o link (com o card dentro) na grade
            });
            feather.replace();
        }

        async function displayLikedVideos() {
            if (!currentUserProfile) { openAuthModal(); return; }

            document.querySelector('.video-section-header h2').textContent = 'Vídeos Curtidos';
            const videoGrid = document.querySelector('.video-grid');
            videoGrid.innerHTML = '<p>Buscando vídeos que você curtiu...</p>';

            try {
                // 1. Encontrar IDs dos vídeos curtidos no Firebase
                const videosRef = fbDb.ref('videos');
                const snapshot = await videosRef.once('value');
                const videosData = snapshot.val() || {};
                const likedVideoIds = [];

                for (const videoId in videosData) {
                    if (videosData[videoId].likes && videosData[videoId].likes[currentUserProfile.uid] === 1) {
                        likedVideoIds.push(videoId);
                    }
                }

                if (likedVideoIds.length === 0) {
                    videoGrid.innerHTML = '<p>Você ainda não curtiu nenhum vídeo.</p>';
                    setupPagination(0);
                    return;
                }

                // 2. Buscar os detalhes desses vídeos no Supabase
                const { data: videos, error } = await _supabase.from('videos').select('*').in('id', likedVideoIds);
                if (error) throw error;
                
                // 3. Configurar paginação e renderizar
                currentViewVideos = videos.sort((a,b) => likedVideoIds.indexOf(a.id) - likedVideoIds.indexOf(b.id)); // Mantém a ordem
                currentPage = 1;
                setupPagination(currentViewVideos.length);
                renderCurrentPage();

            } catch (error) {
                console.error("Erro ao buscar vídeos curtidos:", error);
                videoGrid.innerHTML = '<p>Não foi possível carregar os vídeos curtidos.</p>';
                setupPagination(0);
            }
        }

        async function displayHistory() {
            if (!currentUserProfile) { openAuthModal(); return; }

            document.querySelector('.video-section-header h2').textContent = 'Seu Histórico';
            const videoGrid = document.querySelector('.video-grid');
            videoGrid.innerHTML = '<p>Buscando seu histórico...</p>';

            try {
                // 1. Pega os IDs do histórico do perfil no Firebase
                const historyRef = fbDb.ref(`profiles/${currentUserProfile.uid}/history`).orderByValue().limitToLast(50); // Pega os 50 mais recentes
                const snapshot = await historyRef.once('value');
                const historyData = snapshot.val() || {};
                const historyVideoIds = Object.keys(historyData).reverse();

                if (historyVideoIds.length === 0) {
                    videoGrid.innerHTML = '<p>Seu histórico de visualização está vazio.</p>';
                    setupPagination(0);
                    return;
                }

                // 2. Buscar os detalhes desses vídeos no Supabase
                const { data: videos, error } = await _supabase.from('videos').select('*').in('id', historyVideoIds);
                if (error) throw error;
                
                const orderedVideos = historyVideoIds.map(id => videos.find(video => video.id == id)).filter(Boolean);

                // 3. Configurar paginação e renderizar
                currentViewVideos = orderedVideos;
                currentPage = 1;
                setupPagination(currentViewVideos.length);
                renderCurrentPage();

            } catch (error) {
                console.error("Erro ao buscar histórico:", error);
                videoGrid.innerHTML = '<p>Não foi possível carregar seu histórico.</p>';
                setupPagination(0);
            }
        }


        function closePlayer() {
            const playerOverlay = document.getElementById('video-player-overlay');
            const mainContent = document.querySelector('.main-content');
            const playerVideo = document.getElementById('main-player-video');
            if (!playerOverlay || !mainContent || !playerVideo) return;
            
            detachFirebaseListeners();
            playerVideo.pause();
            
            if (playerVideo.hls) {
                playerVideo.hls.destroy();
                delete playerVideo.hls;
            }

            // CORREÇÃO: A linha playerVideo.load() foi removida daqui.
            // Chamar .load() em um elemento sem 'src' é o que causa o erro NotSupportedError.
            playerVideo.src = '';
            playerVideo.removeAttribute('src'); 

            playerVideo.classList.remove('sd-quality-effect');
            playerOverlay.classList.remove('active');
            mainContent.style.display = 'block';
            document.title = originalPageTitle;
        }

        // --- FUNÇÕES DE INTERAÇÃO COM FIREBASE (LIKES/COMENTÁRIOS) ---
        function attachFirebaseListeners(videoId) {
            // Escuta o nó do vídeo inteiro para pegar likes, views e comentários de uma vez
            const videoRef = fbDb.ref(`videos/${videoId}`);
            likesListener = videoRef.on('value', snapshot => {
                const videoData = snapshot.val() || {};
                const likesData = videoData.likes || {};
                const viewsData = videoData.views || 0;
                
                // Atualiza Views
                document.getElementById('view-count').textContent = viewsData;

                // Atualiza Likes/Dislikes
                const likes = Object.values(likesData).filter(v => v === 1).length;
                const dislikes = Object.values(likesData).filter(v => v === -1).length;
                document.getElementById('like-count').textContent = likes;
                document.getElementById('dislike-count').textContent = dislikes;
                
                const likeBtn = document.getElementById('like-btn');
                const dislikeBtn = document.getElementById('dislike-btn');
                likeBtn.classList.remove('active');
                dislikeBtn.classList.remove('active');
                if (currentUserProfile && likesData[currentUserProfile.uid]) {
                    if (likesData[currentUserProfile.uid] === 1) likeBtn.classList.add('active');
                    if (likesData[currentUserProfile.uid] === -1) dislikeBtn.classList.add('active');
                }
            });

            // Listener separado para comentários (mais eficiente para listas longas)
            const commentsRef = fbDb.ref(`videos/${videoId}/comments`).orderByChild('timestamp');
            commentsListener = commentsRef.on('value', snapshot => {
                const commentsData = snapshot.val() || {};
                const commentsList = document.getElementById('comments-list');
                commentsList.innerHTML = '';
                document.getElementById('comment-count').textContent = Object.keys(commentsData).length;

                const commentIds = Object.keys(commentsData).reverse();
                
                commentIds.forEach(commentId => {
                    const comment = commentsData[commentId];
                    const item = document.createElement('div');
                    item.className = 'comment-item';

                    // Lógica de Votos
                    const votes = comment.votes || {};
                    const likes = Object.values(votes).filter(v => v === 1).length;
                    const dislikes = Object.values(votes).filter(v => v === -1).length;
                    let likeActiveClass = '', dislikeActiveClass = '';
                    if (currentUserProfile && votes[currentUserProfile.uid]) {
                        if (votes[currentUserProfile.uid] === 1) likeActiveClass = 'active';
                        if (votes[currentUserProfile.uid] === -1) dislikeActiveClass = 'active';
                    }

                    let deleteButtonHTML = '';
                    if (currentUserProfile && currentUserProfile.uid === comment.user_id) {
                        deleteButtonHTML = `<span class="delete-comment-btn" data-comment-id="${commentId}" title="Apagar comentário"><i data-feather="trash-2"></i></span>`;
                    }

                    const proBadgeHTML = comment.is_pro ? '<span class="comment-pro-badge">PRO</span>' : '';
                    const proAvatarClass = comment.is_pro ? 'pro-avatar-border' : '';

                    item.innerHTML = `
                        <img src="${comment.avatar_url}" alt="${comment.full_name}" class="${proAvatarClass} comment-clickable-user" data-user-id="${comment.user_id}">
                        <div class="comment-content">
                            <div>
                                <span class="comment-author comment-clickable-user" data-user-id="${comment.user_id}">${comment.full_name}</span>
                                ${proBadgeHTML}
                                <span class="comment-date">${new Date(comment.timestamp).toLocaleDateString()}</span>
                            </div>
                            <p class="comment-text">${comment.content}</p>
                            <div class="comment-actions">
                                <span class="comment-action-btn ${likeActiveClass}" data-vote="1" data-comment-id="${commentId}">
                                    <i data-feather="thumbs-up"></i> ${likes}
                                </span>
                                <span class="comment-action-btn ${dislikeActiveClass}" data-vote="-1" data-comment-id="${commentId}">
                                    <i data-feather="thumbs-down"></i> ${dislikes}
                                </span>
                            </div>
                        </div>
                        ${deleteButtonHTML}`;
                    commentsList.appendChild(item);
                });
                feather.replace();
            });
        }
        
        function detachFirebaseListeners() {
            const videoId = document.getElementById('video-player-overlay').dataset.currentVideoId;
            if (likesListener) fbDb.ref(`videos/${videoId}/likes`).off('value', likesListener);
            if (commentsListener) fbDb.ref(`videos/${videoId}/comments`).off('value', commentsListener);
            likesListener = null;
            commentsListener = null;
        }

        async function handleLikeDislike(type) {
            if (!currentUserProfile) { openAuthModal(); return; }
            const videoId = document.getElementById('video-player-overlay').dataset.currentVideoId;
            const likeRef = fbDb.ref(`videos/${videoId}/likes/${currentUserProfile.uid}`);
            const snapshot = await likeRef.once('value');
            if (snapshot.val() === type) { likeRef.remove(); } else { likeRef.set(type); }
        }

        async function handleCommentVote(commentId, voteType) {
            if (!currentUserProfile) { openAuthModal(); return; }
            const videoId = document.getElementById('video-player-overlay').dataset.currentVideoId;
            const voteRef = fbDb.ref(`videos/${videoId}/comments/${commentId}/votes/${currentUserProfile.uid}`);
            const snapshot = await voteRef.once('value');
            if (snapshot.val() === voteType) {
                voteRef.remove(); // Clicar de novo no mesmo botão remove o voto
            } else {
                voteRef.set(voteType); // Adiciona ou troca o voto
            }
        }

        async function handleDeleteComment(commentId) {
            if (!currentUserProfile) { return; } // Segurança básica
            const videoId = document.getElementById('video-player-overlay').dataset.currentVideoId;
            if (!videoId) return;

            const commentRef = fbDb.ref(`videos/${videoId}/comments/${commentId}`);
            
            // Confirmação antes de apagar
            if (confirm("Tem certeza que deseja apagar este comentário?")) {
                try {
                    // Opcional: Verificar propriedade novamente antes de apagar
                    const snapshot = await commentRef.once('value');
                    const commentData = snapshot.val();
                    if (commentData && commentData.user_id === currentUserProfile.uid) {
                        await commentRef.remove();
                    } else {
                        alert("Você não tem permissão para apagar este comentário.");
                    }
                } catch (error) {
                    alert("Erro ao apagar o comentário: " + error.message);
                }
            }
        }

        function handleShare() {
            const videoId = document.getElementById('video-player-overlay').dataset.currentVideoId;
            if (!videoId) return;
            
            // Constrói a URL base (sem parâmetros existentes)
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?v=${videoId}`;
            
            // Usa a API do Clipboard para copiar o link
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert("Link do vídeo copiado para a área de transferência!");
            }).catch(err => {
                console.error('Falha ao copiar o link: ', err);
                alert("Não foi possível copiar o link.");
            });
        }
        
        async function openVideoById(videoId) {
            // 1. Busca os detalhes do vídeo no Supabase
            const { data, error } = await _supabase.from('videos').select('*').eq('id', videoId).single();

            if (error || !data) {
                console.error("Vídeo do link não encontrado:", videoId, error);
                alert("O vídeo solicitado no link não foi encontrado.");
                return;
            }

            // 2. Busca o status PRO do Firebase para esse vídeo específico
            const proStatusSnapshot = await fbDb.ref(`video_metadata/${videoId}`).once('value');
            const isProVideo = proStatusSnapshot.val()?.is_pro === true;
            
            // 3. Roda a lógica de verificação
            if (isProVideo) {
                if (currentUserProfile && currentUserProfile.pro_status === 'active') {
                    // Usuário é PRO, pode abrir
                } else if (currentUserProfile) {
                    openSubscriptionModal();
                    return; // Para a execução
                } else {
                    openAuthModal();
                    return; // Para a execução
                }
            }

            // 4. Se passou na verificação (ou não é PRO), abre o player
            const mockCard = {
                dataset: {
                    videoId: data.id,
                    videoUrl: data.video_url,
                    title: data.title,
                    description: data.description || 'Sem descrição disponível.'
                }
            };
            openPlayer(mockCard);
        }

        function closeMiniProfileModal() {
            document.getElementById('mini-profile-overlay').classList.remove('active');
        }

        async function openMiniProfileModal(userId) {
            if (!userId) return;
            recipientForNewChat = userId;
            const overlay = document.getElementById('mini-profile-overlay');
            try {
                const snapshot = await fbDb.ref(`profiles/${userId}`).once('value');
                if (!snapshot.exists()) { throw new Error('Perfil não encontrado.'); }
                const profile = snapshot.val();

                const miniAvatar = document.getElementById('mini-profile-avatar-img');
                miniAvatar.src = profile.avatar_url || 'https://yxdjmyqkltaqjulfkcuu.supabase.co/storage/v1/object/public/avatars/public/iYCPry8dBdWV7mMwfMM2yC7jb5n2/images%20(3).jpeg';
                
                document.getElementById('mini-profile-user-name').textContent = profile.full_name || 'Usuário';
                document.getElementById('mini-profile-bio').textContent = profile.bio || 'Nenhuma biografia disponível.';
                document.getElementById('mini-profile-age').textContent = profile.age || '--';
                document.getElementById('mini-profile-gender').textContent = profile.gender || 'Não informado';

                // Calcula e exibe tempo de conta (COM CORREÇÃO PARA NaN)
                const accountAgeEl = document.getElementById('mini-profile-account-age');
                if (profile.creation_timestamp && typeof profile.creation_timestamp === 'number') {
                    const diff = Date.now() - profile.creation_timestamp;
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    accountAgeEl.textContent = `Membro há ${days} dias`;
                } else {
                    // Se for uma conta nova ou sem timestamp, mostra 0 dias.
                    accountAgeEl.textContent = 'Membro há 0 dias';
                }

                // Calcula e exibe tempo de atividade
                const totalMinutes = profile.time_spent_minutes || 0;
                const hours = Math.floor(totalMinutes / 60);
                document.getElementById('mini-profile-time-spent').textContent = `~ ${hours} horas`;

                const isPro = profile.pro_info?.status === 'active';
                document.getElementById('mini-profile-pro-badge').style.display = isPro ? 'inline-block' : 'none';
                miniAvatar.style.borderColor = isPro ? 'gold' : 'var(--accent-color)';
                
                overlay.classList.add('active');

            } catch (error) {
                console.error("Erro ao buscar mini-perfil:", error);
            }
        }

        
        async function handleCommentSubmit(event) {
            event.preventDefault();
            if (!currentUserProfile) { openAuthModal(); return; }
            const content = document.getElementById('comment-input').value.trim();
            if (!content) return;
            const videoId = document.getElementById('video-player-overlay').dataset.currentVideoId;
            const commentsRef = fbDb.ref(`videos/${videoId}/comments`);
            try {
                await commentsRef.push({
                    content: content,
                    user_id: currentUserProfile.uid,
                    full_name: currentUserProfile.full_name,
                    avatar_url: currentUserProfile.avatar_url,
                    // CORREÇÃO APLICADA AQUI
                    is_pro: currentUserProfile.pro_info?.status === 'active',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                document.getElementById('comment-input').value = '';
            } catch (error) { alert("Erro ao enviar comentário: " + error.message); }
        }

        // --- FUNÇÕES DE SETUP ---
        // Event listener para as categorias (agora delegado para funcionar com links dinâmicos)
            document.body.addEventListener('click', (event) => {
                const link = event.target.closest('[data-category]');
                if (!link) return; // Se o clique não foi em um link de categoria, ignora

                event.preventDefault();
                mainContent.style.display = 'block';
                footerInfo.style.display = 'none';
                setActiveNav('home-btn');
                const category = link.dataset.category;
                const activeSort = document.querySelector('.filter-options a.active').dataset.sort;

                if (link.closest('#sidebar-category-list')) {
                    document.querySelectorAll('#sidebar-category-list a').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                }
                
                if (link.closest('#player-categories')) {
                    closePlayer();
                    document.querySelectorAll('#sidebar-category-list a').forEach(sideLink => {
                        sideLink.classList.toggle('active', sideLink.dataset.category === category);
                    });
                }
                displayVideos(category, activeSort);
            });

        async function setupFeaturedVideo() {
            if (allFetchedVideos.length === 0) return;
            const featuredSection = document.querySelector('.featured-mural');
            const featuredBtn = document.getElementById('featured-video-btn');
            const randomIndex = Math.floor(Math.random() * allFetchedVideos.length);
            const randomVideo = allFetchedVideos[randomIndex];
            featuredSection.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.8)), url('${randomVideo.thumbnail_url}')`;
            
            // Recria o botão para limpar listeners antigos e adiciona o novo com a verificação
            const newBtn = featuredBtn.cloneNode(true);
            featuredBtn.parentNode.replaceChild(newBtn, featuredBtn);
            newBtn.addEventListener('click', (e) => {
                e.preventDefault();
                // Usa a nova função de verificação
                tryToOpenVideo(randomVideo.id);
            });
        }
        
        // --- FUNÇÕES PARA PEGAR DURAÇÃO DO VÍDEO (REUTILIZADA) ---
        function getVideoDuration(file) {
            return new Promise((resolve, reject) => {
                const video = document.createElement('video');
                video.preload = 'metadata';
                video.onloadedmetadata = function() {
                    window.URL.revokeObjectURL(video.src);
                    const duration = video.duration;
                    const minutes = Math.floor(duration / 60);
                    const seconds = Math.floor(duration % 60).toString().padStart(2, '0');
                    resolve(`${minutes}:${seconds}`);
                };
                video.onerror = () => reject("Erro ao ler metadados do vídeo.");
                video.src = window.URL.createObjectURL(file);
            });
        }

// NOVA FUNÇÃO PARA OUVIR MUDANÇAS NA TABELA DE VÍDEOS
        function listenForVideoChanges() {
            _supabase.channel('videos')
              .on('postgres_changes', { event: '*', schema: 'public', table: 'videos' }, payload => {
                console.log('Mudança detectada na tabela de vídeos:', payload);
                // Quando qualquer mudança ocorrer, simplesmente recarregamos os vídeos na tela
                displayVideos('all', 'random');
                fetchAllVideosForCache(); // Atualiza o cache de recomendações
              })
              .subscribe();
        }

        async function fetchAllVideosForCache() {
            try {
                // Passo 1: Buscar todos os vídeos aprovados do Supabase (sem a coluna 'is_pro')
                const { data: videos, error } = await _supabase.from('videos')
                    .select('id, title, category, thumbnail_url, created_at, duration')
                    .eq('status', 'approved');

                if (error) throw error; // Lança o erro para o bloco catch

                // Passo 2: Buscar todos os metadados (incluindo status PRO) do Firebase
                const proStatusRef = fbDb.ref('video_metadata');
                const proStatusSnapshot = await proStatusRef.once('value');
                const proStatusData = proStatusSnapshot.val() || {};

                // Passo 3: Combinar os dados em um único array
                const combinedVideos = videos.map(video => ({
                    ...video,
                    is_pro: proStatusData[video.id]?.is_pro === true
                }));

                _allVideosCache = combinedVideos; // Salva o resultado combinado no cache
                
            } catch (err) {
                console.error("Erro ao carregar cache de vídeos:", err);
            }
        }

        async function fetchAllVideosForCache() {
            try {
                // Passo 1: Buscar todos os vídeos aprovados do Supabase (CORREÇÃO APLICADA AQUI)
                const { data: videos, error } = await _supabase.from('videos')
                    .select('id, title, category, thumbnail_url, created_at, duration') // Removida a coluna 'is_pro'
                    .eq('status', 'approved');

                if (error) throw error; // Lança o erro para o bloco catch

                // Passo 2: Buscar todos os metadados (incluindo status PRO) do Firebase
                const proStatusRef = fbDb.ref('video_metadata');
                const proStatusSnapshot = await proStatusRef.once('value');
                const proStatusData = proStatusSnapshot.val() || {};

                // Passo 3: Combinar os dados em um único array
                const combinedVideos = videos.map(video => ({
                    ...video,
                    is_pro: proStatusData[video.id]?.is_pro === true
                }));

                _allVideosCache = combinedVideos; // Salva o resultado combinado no cache
                
            } catch (err) {
                console.error("Erro ao carregar cache de vídeos:", err);
            }
        }


        // --- FUNÇÕES DE VISUALIZAÇÃO MÓVEL (AGORA AUTOMÁTICO) ---
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function applyMobileView() {
            if (isMobileDevice()) {
                document.body.classList.add('mobile-view');
            }
        }


        // --- FUNÇÕES DO MENU MOBILE DEDICADO ---
        function populateMobileMenu() {
            const sidebarLogo = document.querySelector('.sidebar .logo');
            const sidebarNav = document.querySelector('.sidebar .nav-menu');
            const sidebarCategories = document.querySelector('.sidebar .categories');
            const mobileMenuContent = document.getElementById('mobile-menu-content');

            if (sidebarLogo && sidebarNav && sidebarCategories && mobileMenuContent) {
                // Clona os elementos para não removê-los do sidebar original
                mobileMenuContent.appendChild(sidebarLogo.cloneNode(true));
                mobileMenuContent.appendChild(sidebarNav.cloneNode(true));
                mobileMenuContent.appendChild(sidebarCategories.cloneNode(true));
            }
        }

        function openMobileMenu() {
            document.getElementById('mobile-menu-overlay').classList.add('active');
            document.body.classList.add('body-no-scroll');
        }

        function closeMobileMenu() {
            document.getElementById('mobile-menu-overlay').classList.remove('active');
            document.body.classList.remove('body-no-scroll');
        }


document.addEventListener('DOMContentLoaded', async () => {
            // --- VERIFICAÇÃO DE GEOLOCALIZAÇÃO (VERSÃO CORRIGIDA) ---
            try {
                // Usando uma API alternativa (get.geojs.io) que é mais permissiva
                const response = await fetch('https://get.geojs.io/v1/ip/country.json');
                if (!response.ok) throw new Error('Geo API request failed');
                const data = await response.json();
                // A resposta desta API tem a chave "country" para o código de 2 letras
                if (data.country !== 'BR') {
                    document.getElementById('geo-block-overlay').style.display = 'flex';
                    document.querySelector('.sidebar').classList.add('hidden-by-geo-block');
                    document.querySelector('.page-wrapper').classList.add('hidden-by-geo-block');
                    return; // Interrompe a execução do restante do script
                }
            } catch (error) {
                console.error("Geo-blocking check failed:", error);
                // Bloqueia o acesso se a verificação falhar, por segurança.
                const overlay = document.getElementById('geo-block-overlay');
                overlay.innerHTML = "<p>Could not verify your location. Access denied.</p>";
                overlay.style.display = 'flex';
                document.querySelector('.sidebar').classList.add('hidden-by-geo-block');
                document.querySelector('.page-wrapper').classList.add('hidden-by-geo-block');
                return; // Interrompe a execução
            }
            // --- FIM DA VERIFICAÇÃO ---


            // --- INICIALIZAÇÃO DOS SDKs (CORREÇÃO PARA O ERRO 'supabase is not defined') ---
            // Este código agora roda depois que os scripts 'defer' foram carregados.
            const { createClient } = supabase;
            // As constantes SUPABASE_URL e SUPABASE_ANON_KEY agora são globais
            _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            const firebaseConfig = {
                apiKey: "AIzaSyDxAMjX4aVhOIXBpbYD0ENm8WDEUjnTQWM",
                authDomain: "pixwin-fd0be.firebaseapp.com",
                databaseURL: "https://pixwin-fd0be-default-rtdb.europe-west1.firebasedatabase.app",
                projectId: "pixwin-fd0be",
                storageBucket: "pixwin-fd0be.appspot.com",
                messagingSenderId: "588655063887",
                appId: "1:588655063887:web:d144b395a4a98a904d0b3a"
            };
            firebase.initializeApp(firebaseConfig);
            fbAuth = firebase.auth();
            fbDb = firebase.database();
            fbStorage = firebase.storage();
            // --- FIM DA INICIALIZAÇÃO ---

            // --- LÓGICA DE CONTAGEM DE ACESSOS (ANALYTICS) ---
            const analyticsRef = fbDb.ref('site_analytics');
            // Incrementa o contador total de visitas
            analyticsRef.child('total_visits').transaction(count => (count || 0) + 1);
            // Incrementa o contador de visitas do dia atual usando o horário de Brasília
            const today = getBrasiliaDate().toISOString().slice(0, 10); // Formato YYYY-MM-DD
            analyticsRef.child('daily_visits').child(today).transaction(count => (count || 0) + 1);
            // --- FIM DO ANALYTICS ---

            // **LISTENER DE AUTENTICAÇÃO MOVIDO PARA CÁ (CORREÇÃO DEFINITIVA)**
            fbAuth.onAuthStateChanged(async (user) => {
                const impersonateUid = localStorage.getItem('admin_impersonate_uid');
                let effectiveUid = user ? user.uid : null;
                let isAdminAction = false;

                if (impersonateUid) {
                    effectiveUid = impersonateUid;
                    isAdminAction = true;
                    localStorage.removeItem('admin_impersonate_uid');
                }

                if (effectiveUid) {
                    clearGuestPresence();
                    const profileRef = fbDb.ref('profiles/' + effectiveUid);
                    profileRef.once('value', (snapshot) => {
                        let profileData = snapshot.val() || {};

                        if (profileData.status === 'banned') {
                            alert("Este usuário está banido.");
                            handleLogout();
                            return;
                        }
                        
                        const onlineStatusRef = fbDb.ref(`online_status/${effectiveUid}`);
                        onlineStatusRef.set({ last_seen: firebase.database.ServerValue.TIMESTAMP });
                        onlineStatusRef.onDisconnect().remove();
                        
                        updateUIAfterLogin({ uid: effectiveUid, ...profileData });
                        listenForPendingPayment(effectiveUid);
                        listenForUnreadChats(effectiveUid);
                        
                        if (!isAdminAction && user) {
                             if (timeSpentInterval) clearInterval(timeSpentInterval);
                             timeSpentInterval = setInterval(() => {
                                const userTimeRef = fbDb.ref(`profiles/${user.uid}/time_spent_minutes`);
                                userTimeRef.transaction(currentMinutes => (currentMinutes || 0) + 1);
                                fbDb.ref(`online_status/${user.uid}`).update({ last_seen: firebase.database.ServerValue.TIMESTAMP });
                            }, 60000);
                        }
                        
                        const lastChecked = profileData.lastCheckedNotifications;
                        listenForNotifications(lastChecked); 
                    });
                } else {
                    if (timeSpentInterval) clearInterval(timeSpentInterval);
                    
                    if (proPaymentRef && proPaymentListener) {
                        proPaymentRef.off('value', proPaymentListener);
                        proPaymentListener = null;
                        proPaymentRef = null;
                    }
                     if (unreadChatsRef && unreadChatsListener) {
                        unreadChatsRef.off('value', unreadChatsListener);
                        unreadChatsListener = null;
                        unreadChatsRef = null;
                    }

                    hidePendingPaymentUI();
                    document.getElementById('main-chat-badge').style.display = 'none';
                    resetUIToLoggedOut();
                    manageGuestPresence();
                }
            });
            
            applyMobileView(); // Aplica a visualização correta ao carregar a página

            // Adiciona o listener para o novo botão de login
            document.getElementById('login-prompt-btn').addEventListener('click', openAuthModal);
            
            // Carrega dependências visuais e configura todos os event listeners primeiro
            await fetchAndDisplayCategories(); 
            fetchAllVideosForCache(); // Inicia o carregamento de todos os vídeos para o cache em segundo plano
            populateMobileMenu(); // <<-- MOVIDO PARA DEPOIS DE CARREGAR AS CATEGORIAS
            setupEventListeners(); 

            // --- LÓGICA DO MODAL DE UPLOAD DO USUÁRIO ---
            const uploadOverlay = document.getElementById('upload-overlay');
            const openUploadBtn = document.getElementById('open-upload-modal-btn');
            const closeUploadBtn = document.getElementById('upload-close-btn');
            const userUploadForm = document.getElementById('user-upload-form');

            openUploadBtn.addEventListener('click', () => {
                // SÓ ABRE O MODAL SE O USUÁRIO ESTIVER LOGADO
                if (currentUserProfile) {
                    uploadOverlay.classList.add('active');
                } else {
                    openAuthModal(); // Se não estiver logado, abre o modal de login
                }
            });

            closeUploadBtn.addEventListener('click', () => {
                uploadOverlay.classList.remove('active');
            });

            userUploadForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const title = document.getElementById('upload-video-title').value;
                const description = document.getElementById('upload-video-description').value;
                const category = document.getElementById('upload-video-category').value;
                const thumbnailFile = document.getElementById('upload-thumbnail-file').files[0];
                const videoFile = document.getElementById('upload-video-file').files[0];

                if (!title || !description || !category || !thumbnailFile || !videoFile) {
                    alert('Por favor, preencha todos os campos.');
                    return;
                }

                const submitButton = document.getElementById('user-submit-btn');
                const progressContainer = document.getElementById('user-progress-container');
                const progressBar = document.getElementById('user-upload-progress');
                const progressPercentage = document.getElementById('user-progress-percentage');

                submitButton.disabled = true;
                submitButton.textContent = 'Enviando...';
                progressContainer.style.display = 'block';
                progressBar.value = 0;
                progressPercentage.textContent = '0%';

                try {
                    const duration = await getVideoDuration(videoFile);

                    // Upload da Thumbnail para Supabase
                    const thumbPath = `public/${Date.now()}_${thumbnailFile.name}`;
                    await _supabase.storage.from('thumbnails').upload(thumbPath, thumbnailFile);
                    const { data: { publicUrl: thumbnailUrl } } = _supabase.storage.from('thumbnails').getPublicUrl(thumbPath);

                    // Upload do Vídeo para Supabase com progresso
                    const videoPath = `public/${Date.now()}_${videoFile.name}`;
                    await _supabase.storage.from('videos').upload(videoPath, videoFile, {
                        onUploadProgress: (e) => {
                            const p = Math.floor((e.loaded / e.total) * 100);
                            progressBar.value = p; 
                            progressPercentage.textContent = `${p}%`;
                        }
                    });
                    const { data: { publicUrl: videoUrl } } = _supabase.storage.from('videos').getPublicUrl(videoPath);

                    // Insere os dados na tabela 'videos' com o status 'pending'
                    const { error } = await _supabase.from('videos').insert([{ 
                        title, 
                        description, 
                        category, 
                        thumbnail_url: thumbnailUrl, 
                        video_url: videoUrl, 
                        duration,
                        status: 'pending' // AQUI ESTÁ A CHAVE DA LÓGICA!
                    }]);

                    if (error) throw error;

                    alert('Vídeo enviado para análise com sucesso! Você será notificado se for aprovado.');
                    userUploadForm.reset();
                    uploadOverlay.classList.remove('active');

                } catch (error) {
                    alert('Ocorreu um erro durante o envio: ' + error.message);
                    console.error('Erro no envio do usuário:', error);
                } finally {
                    // Reseta o botão e a barra de progresso
                    submitButton.disabled = false;
                    submitButton.textContent = 'Enviar para Análise';
                    progressContainer.style.display = 'none';
                }
            });

            // --- Event Listeners de Notificação ---
            const bellIcon = document.getElementById('notification-bell');
            const notifList = document.getElementById('notification-list');

            bellIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                const isVisible = notifList.style.display === 'block';
                notifList.style.display = isVisible ? 'none' : 'block';

                // Se o dropdown está sendo aberto e o usuário está logado
                if (!isVisible && currentUserProfile) {
                    unreadNotifs = 0;
                    updateNotificationUI();
                    
                    // ATUALIZA O TEMPO NO BANCO DE DADOS
                    const userProfileRef = fbDb.ref('profiles/' + currentUserProfile.uid);
                    userProfileRef.update({
                        lastCheckedNotifications: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            });

            notifList.addEventListener('click', (e) => {
                const li = e.target.closest('li');
                if (li && li.dataset.videoId) {
                    notifList.style.display = 'none'; // Esconde a lista
                    openVideoById(li.dataset.videoId);
                }
            });
            // Clicar fora dos popups os fecha
            document.body.addEventListener('click', (e) => {
                const qualityOptionsList = document.getElementById('quality-options-list');
                const qualityBtn = document.getElementById('quality-btn');
                const paymentMenu = document.getElementById('pending-payment-menu');
                const clockIcon = document.getElementById('pending-payment-clock');

                if (notifList.style.display === 'block' && !bellIcon.contains(e.target) && !notifList.contains(e.target)) {
                    notifList.style.display = 'none';
                }
                if (qualityOptionsList && qualityOptionsList.classList.contains('active') && !qualityBtn.contains(e.target) && !qualityOptionsList.contains(e.target)) {
                    qualityOptionsList.classList.remove('active');
                }
                if (paymentMenu && paymentMenu.style.display === 'block' && !paymentMenu.contains(e.target) && !clockIcon.contains(e.target)) {
                    paymentMenu.style.display = 'none';
                }
            });


            // NOVA FUNÇÃO DE DENÚNCIA (AGORA GLOBAL)
            async function handleReportVideo() {
                if (!currentUserProfile) {
                    openAuthModal();
                    return;
                }
                const videoId = document.getElementById('video-player-overlay').dataset.currentVideoId;
                const videoTitle = document.getElementById('player-video-title').textContent;

                const reason = prompt(`Por favor, descreva o motivo da sua denúncia para o vídeo:\n"${videoTitle}"`);

                if (reason && reason.trim() !== '') {
                    try {
                        await fbDb.ref('reports').push({
                            videoId: videoId,
                            videoTitle: videoTitle,
                            reason: reason.trim(),
                            reportedBy_uid: currentUserProfile.uid,
                            reportedBy_name: currentUserProfile.full_name,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            status: 'new'
                        });
                        alert('Obrigado! Sua denúncia foi enviada para análise.');
                    } catch (error) {
                        alert('Não foi possível enviar sua denúncia. Tente novamente.');
                        console.error("Erro ao criar denúncia:", error);
                    }
                }
            }


            // Event Listeners Principais
            document.querySelector('.video-grid').addEventListener('click', (e) => {
                const cardLink = e.target.closest('.video-card-link');
                if (cardLink) {
                    // Previne a navegação padrão para que o player em modal possa abrir
                    e.preventDefault();
                    // Extrai o ID do vídeo do href do link
                    const videoId = new URL(cardLink.href).searchParams.get('v');
                    if (videoId) {
                        tryToOpenVideo(videoId);
                    }
                }
            });
            
            document.getElementById('recommendations-list').addEventListener('click', (e) => { 
                const cardLink = e.target.closest('.recommendation-card-link');
                if (cardLink) {
                    e.preventDefault();
                    const videoId = new URL(cardLink.href).searchParams.get('v');
                    if (videoId) {
                        tryToOpenVideo(videoId);
                    }
                }
            });

            document.getElementById('player-close-btn').addEventListener('click', closePlayer);
            
            // Listeners de Autenticação
            const authModal = document.querySelector('.auth-modal');

            // Listener DELEGADO para o "olhinho" de ver a senha (CORRIGIDO)
            authModal.addEventListener('click', (event) => {
                const icon = event.target.closest('.password-toggle-icon');
                if (!icon) return; // Se o clique não foi no ícone, ignora

                const formGroup = icon.closest('.form-group');
                const input = formGroup.querySelector('input');
                
                const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                input.setAttribute('type', type);

                // Troca o ícone
                const newIconName = type === 'password' ? 'eye' : 'eye-off';
                // Substitui o conteúdo SVG do ícone diretamente para evitar problemas
                icon.innerHTML = feather.icons[newIconName].toSvg();
            });

            document.getElementById('auth-close-btn').addEventListener('click', closeAuthModal);
            document.getElementById('signup-form').addEventListener('submit', handleSignUp);
            document.getElementById('login-form').addEventListener('submit', handleSignIn);
            document.querySelectorAll('.auth-tab-btn').forEach(btn => btn.addEventListener('click', () => switchAuthForm(btn.dataset.form)));
            
            
            
            // Listener de Perfil (Avatar Principal)
            document.getElementById('main-user-avatar').addEventListener('click', () => {
                if (currentUserProfile) { openProfileModal(); } else { openAuthModal(); }
            });

            // Listeners do Player de Vídeo
            document.getElementById('like-btn').addEventListener('click', () => handleLikeDislike(1));
            document.getElementById('dislike-btn').addEventListener('click', () => handleLikeDislike(-1));
            document.getElementById('share-btn').addEventListener('click', handleShare);
            document.getElementById('report-video-btn').addEventListener('click', handleReportVideo);

            document.getElementById('player-video-category-btn').addEventListener('click', (e) => {
                e.preventDefault();
                const categorySlug = e.currentTarget.dataset.category;
                if (!categorySlug) return;

                closePlayer();

                document.querySelectorAll('#sidebar-category-list a').forEach(a => {
                    a.classList.toggle('active', a.dataset.category === categorySlug);
                });
                
                document.querySelector('.main-content').style.display = 'block';
                document.querySelector('.footer-info-container').style.display = 'none';
                document.querySelectorAll('.nav-menu a').forEach(a => a.classList.remove('active'));
                document.getElementById('home-btn').classList.add('active');

                displayVideos(categorySlug, 'random');
            });
            document.getElementById('comment-form').addEventListener('submit', handleCommentSubmit);
            document.getElementById('comments-list').addEventListener('click', (event) => {
                const deleteBtn = event.target.closest('.delete-comment-btn');
                const voteBtn = event.target.closest('.comment-action-btn');
                const userElement = event.target.closest('.comment-clickable-user');

                if (deleteBtn) {
                    handleDeleteComment(deleteBtn.dataset.commentId);
                } else if (voteBtn) {
                    handleCommentVote(voteBtn.dataset.commentId, parseInt(voteBtn.dataset.vote, 10));
                } else if (userElement) {
                    openMiniProfileModal(userElement.dataset.userId);
                }
            });

            // Listeners do Modal de Perfil
            document.getElementById('profile-close-btn').addEventListener('click', closeProfileModal);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('avatar-file-input').addEventListener('change', handleAvatarUpload);
            document.getElementById('save-bio-btn').addEventListener('click', handleBioUpdate);
            document.getElementById('save-gender-btn').addEventListener('click', handleGenderUpdate);

// Listeners do Chat ---
            document.getElementById('open-chat-btn').addEventListener('click', openChatOverlay);
            document.getElementById('chat-close-btn').addEventListener('click', closeChatOverlay);
            document.getElementById('chat-input-form').addEventListener('submit', handleSendMessage);
            
            // Listeners do Menu Mobile Dedicado
            document.getElementById('mobile-menu-btn').addEventListener('click', openMobileMenu);
            document.getElementById('mobile-menu-close-btn').addEventListener('click', closeMobileMenu);
            
            // Listener de clique para o CONTEÚDO do menu mobile que executa as funções corretas
            document.getElementById('mobile-menu-content').addEventListener('click', (event) => {
                const link = event.target.closest('a');
                const logo = event.target.closest('.logo');
                const mainContent = document.querySelector('.main-content');
                const footerInfo = document.querySelector('.footer-info-container');

                // Se não clicou em um link ou no logo, não faz nada
                if (!link && !logo) return;

                event.preventDefault(); // Previne o comportamento padrão do link

                // Função interna para ativar o link correto no menu de navegação
                function setActiveNav(buttonId) {
                    // Primeiro, remove a classe 'active' de todos os links no menu mobile
                    document.querySelectorAll('#mobile-menu-content .nav-menu a').forEach(a => a.classList.remove('active'));
                    // Depois, adiciona a classe ao link que foi clicado
                    if (buttonId) {
                        const activeLink = document.querySelector(`#mobile-menu-content #${buttonId}`);
                        if (activeLink) activeLink.classList.add('active');
                    }
                }

                if (logo || (link && link.id === 'home-btn')) {
                    goToHome(event);
                } else if (link && link.id === 'explore-btn') {
                    mainContent.style.display = 'block';
                    footerInfo.style.display = 'none';
                    setActiveNav('explore-btn');
                    if (allFetchedVideos.length > 0) {
                        const randomVideo = allFetchedVideos[Math.floor(Math.random() * allFetchedVideos.length)];
                        tryToOpenVideo(randomVideo.id);
                    }
                } else if (link && link.id === 'liked-videos-btn') {
                    mainContent.style.display = 'block';
                    footerInfo.style.display = 'none';
                    setActiveNav('liked-videos-btn');
                    displayLikedVideos();
                } else if (link && link.id === 'history-btn') {
                    mainContent.style.display = 'block';
                    footerInfo.style.display = 'none';
                    setActiveNav('history-btn');
                    displayHistory();
                } else if (link && link.id === 'subscriptions-btn') {
                    if (currentUserProfile) {
                        if (currentUserProfile.pro_info?.status === 'active') {
                            alert('Você já faz parte do plano PRO!');
                        } else {
                            openSubscriptionModal();
                        }
                    } else {
                        openAuthModal();
                    }
                } else if (link && link.dataset.category) {
                    mainContent.style.display = 'block';
                    footerInfo.style.display = 'none';
                    const category = link.dataset.category;
                    const activeSort = document.querySelector('.filter-options a.active').dataset.sort;
                    displayVideos(category, activeSort);
                }

                // Fecha o menu após qualquer ação
                closeMobileMenu();
            });

            // Listener para o botão de voltar no chat móvel
            document.getElementById('chat-back-btn').addEventListener('click', () => {
                if (document.body.classList.contains('mobile-view')) {
                    document.getElementById('chat-list-sidebar').style.display = 'flex';
                    document.getElementById('chat-window-main').style.display = 'none';
                    if (chatMessageRef && chatMessageListener) {
                        chatMessageRef.off('child_added', chatMessageListener);
                    }
                    activeChatId = null;
                }
            });
            
            // Listener para o novo input de arquivo
            document.getElementById('chat-media-input').addEventListener('change', handleMediaUploadAndSend);

            document.getElementById('chat-list').addEventListener('click', (e) => {
                const chatItem = e.target.closest('.chat-list-item');
                if (chatItem) {
                    openChat(chatItem.dataset.chatId);
                }
            });
            document.getElementById('mini-profile-send-message-btn').addEventListener('click', () => {
                if(recipientForNewChat) {
                    closeMiniProfileModal();
                    startOrOpenConversation(recipientForNewChat);
                }
            });

            // --- Listeners do Pop-up de Pagamento Pendente ---
            const clockIcon = document.getElementById('pending-payment-clock');
            const paymentMenu = document.getElementById('pending-payment-menu');

            clockIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();

                const rect = clockIcon.getBoundingClientRect();
                
                // Posiciona o menu abaixo do ícone e alinha sua borda direita com a borda direita do ícone
                paymentMenu.style.top = `${rect.bottom + 10}px`; 
                paymentMenu.style.left = 'auto';
                paymentMenu.style.right = `${window.innerWidth - rect.right}px`;

                paymentMenu.style.display = paymentMenu.style.display === 'block' ? 'none' : 'block';
            });

            document.getElementById('open-support-chat-from-menu').addEventListener('click', () => {
                startOrOpenConversation('support');
                paymentMenu.style.display = 'none';
                closeSubscriptionModal();
            });

            // Listener delegado para todos os cliques dentro do pop-up de pagamento
            paymentMenu.addEventListener('click', async (event) => {
                const target = event.target;
                
                // Botão de Suporte
                if (target.matches('#support-pro-btn')) {
                    startOrOpenConversation('support');
                    paymentMenu.style.display = 'none'; // Fecha o menu ao abrir o chat
                }
                
                // Botão de Voltar
                if (target.matches('.back-to-main-menu-btn')) {
                    switchPaymentMenuView('payment-menu-main');
                }

                // Botão que pode Cancelar ou Reativar
                if (target.matches('#cancel-pro-btn')) {
                    if (!currentUserProfile || !userPendingPaymentId) {
                        alert('Não foi possível encontrar sua solicitação de pagamento.');
                        return;
                    }
                    
                    const action = target.dataset.action;
                    const confirmationRef = fbDb.ref(`pro_payment_confirmations/${userPendingPaymentId}`);

                    if (action === 'cancel') {
                        // Adiciona a confirmação antes de fazer qualquer coisa
                        if (confirm("Você tem certeza que quer cancelar?")) {
                            // Ao confirmar, mostra a tela de cancelamento
                            switchPaymentMenuView('payment-menu-cancel');
                            // E atualiza o status no banco de dados
                            try {
                                await confirmationRef.update({ status: 'canceling' });
                            } catch (error) {
                                alert('Erro ao solicitar cancelamento: ' + error.message);
                            }
                        }

                    } else if (action === 'reinstate') {
                        // Ao clicar para reativar o plano
                        try {
                            await confirmationRef.update({ status: 'pending' });
                            // O listener vai atualizar a UI de volta para o estado normal
                            paymentMenu.style.display = 'none'; // Fecha o menu
                        } catch (error) {
                            alert('Erro ao reativar o plano: ' + error.message);
                        }
                    }
                }
            });

            // Listeners do Modal Mini-Perfil
            document.getElementById('mini-profile-close-btn').addEventListener('click', closeMiniProfileModal);
            document.getElementById('mini-profile-overlay').addEventListener('click', closeMiniProfileModal);

            document.querySelectorAll('.support-chat-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentUserProfile) {
                        startOrOpenConversation('support');
                    } else {
                        openAuthModal();
                    }
                });
            });

            // Listeners do Modal de Assinatura
            document.getElementById('subscription-close-btn').addEventListener('click', closeSubscriptionModal);
            document.getElementById('get-pro-btn').addEventListener('click', handleGetProPlan);

            document.getElementById('copy-pix-btn').addEventListener('click', (e) => {
                const pixInput = document.getElementById('pix-copy-paste');
                navigator.clipboard.writeText(pixInput.value).then(() => {
                    const originalText = e.target.textContent;
                    e.target.textContent = 'Copiado!';
                    setTimeout(() => {
                        e.target.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    alert('Falha ao copiar o código.');
                });
            });

            document.getElementById('confirm-payment-btn').addEventListener('click', async () => {
                const user = fbAuth.currentUser;
                if (!user) {
                    alert("Você precisa estar logado para confirmar um pagamento.");
                    openAuthModal();
                    return;
                }
                const payerName = document.getElementById('pix-payer-name').value.trim();
                if (!payerName) {
                    alert("Por favor, informe o primeiro nome que aparecerá no comprovante.");
                    return;
                }

                const pixArea = document.getElementById('pix-payment-area');
                const loadingArea = document.getElementById('payment-loading-area');

                try {
                    pixArea.style.display = 'none';
                    loadingArea.querySelector('h4').textContent = 'Confirmando seu pagamento...';
                    loadingArea.style.display = 'block';

                    // ETAPA CRÍTICA: Busca os dados mais recentes do perfil do usuário AGORA.
                    const profileSnapshot = await fbDb.ref(`profiles/${user.uid}`).once('value');
                    const latestProfile = profileSnapshot.val();

                    if (!latestProfile || !latestProfile.full_name) {
                        throw new Error("Não foi possível carregar os dados do seu perfil. Tente novamente.");
                    }

                    // Usa os dados recém-buscados para garantir que estão corretos
                    await fbDb.ref('pro_payment_confirmations').push({
                        user_uid: user.uid,
                        user_name: latestProfile.full_name,
                        user_email: user.email,
                        payer_name: payerName,
                        status: 'pending',
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    alert("Seu pagamento está em análise. A aprovação pode ser instantânea ou demorar em torno de 1 a 3 horas. Você receberá um email com a confirmação.");
                    closeSubscriptionModal();

                } catch (error) {
                    alert("Erro ao enviar confirmação: " + error.message);
                    loadingArea.style.display = 'none';
                    pixArea.style.display = 'block';
                } finally {
                    setTimeout(() => {
                        loadingArea.style.display = 'none';
                        document.querySelector('.plan-card').style.display = 'block';
                        document.getElementById('pix-payer-name').value = '';
                    }, 500);
                }
            });


       


            


            // --- LÓGICA DE DEEP LINKING ---
            const params = new URLSearchParams(window.location.search);
            const videoIdFromUrl = params.get('v');

            // Carrega a home page primeiro para que a variável `allFetchedVideos` seja populada
            // Isso é importante para as recomendações e para o botão "Explorar"
            await displayVideos('all', 'random');
            await setupFeaturedVideo();
            
            // AQUI ESTÁ A ADIÇÃO: Inicia o "ouvinte" de mudanças
            listenForVideoChanges();

            if (videoIdFromUrl) {
                // Se houver um ID na URL, abre o vídeo por cima da página já carregada
                await openVideoById(videoIdFromUrl);
            }

            // --- LÓGICA DA ANIMAÇÃO DO COELHO PROMOCIONAL ---
            if (Math.random() < 0.5) { // 1 em 2 chances (50%)
                const rabbitContainer = document.getElementById('promo-rabbit-container');
                const rabbitText = document.getElementById('promo-rabbit-text');

                if (rabbitContainer && rabbitText) {
                    // 1. O coelho aparece
                    setTimeout(() => {
                        rabbitContainer.classList.add('animate-in');
                    }, 500); // Meio segundo de delay após o site carregar

                    // 2. O texto aparece 0.8 segundos depois do coelho começar a aparecer
                    setTimeout(() => {
                        rabbitText.classList.add('animate-in');
                    }, 1300); // 500ms (delay inicial) + 800ms (duração da anim do coelho)

                                        // 3. O coelho e o texto somem após ficarem visíveis
                    setTimeout(() => {
                        // Primeiro, inicia a animação de saída do texto
                        rabbitText.classList.remove('animate-in');
                        rabbitText.classList.add('animate-out');

                        // Em seguida, inicia a animação de saída do container.
                        // É crucial NÃO remover a classe 'animate-in' do container neste momento,
                        // pois ela o mantém visível para que a animação de saída possa ser executada.
                        rabbitContainer.classList.add('animate-out');
                    }, 4300); // 1.3s para aparecer + 2s visível + 1s para sumir
                }
            }
        });
    </script>

    <!-- Animação do Coelho Promocional -->
    <div id="promo-rabbit-container">
        <span id="promo-rabbit-text">Vídeos novos todos os dias!</span>
        <img id="promo-rabbit-img" src="https://yxdjmyqkltaqjulfkcuu.supabase.co/storage/v1/object/public/thumbnails/rabbit.png" alt="Coelho Promocional">
    </div>

    <!-- Pop-up do Pagamento Pendente -->
    <div id="pending-payment-menu">
        <div class="payment-menu-header-container">
            <h4 class="payment-menu-header">Análise Pendente</h4>
            <p class="payment-menu-description">Sua solicitação de plano PRO está em análise. A aprovação pode ser instantânea ou demorar de 1 a 3 horas.</p>
        </div>

        <!-- Tela Principal -->
        <div id="payment-menu-main" class="payment-menu-view active">
            <button id="cancel-pro-btn">Cancelar Plano PRO</button>
            <button id="support-pro-btn">Suporte</button>
        </div>

        <!-- Tela de Cancelamento (apenas informativo) -->
        <div id="payment-menu-cancel" class="payment-menu-view">
            <h4 class="payment-menu-header">Cancelamento Solicitado</h4>
            <p class="payment-menu-description">Sua solicitação de cancelamento foi recebida e será processada em até 24 horas. Se o pagamento for confirmado neste período, o valor será estornado via PIX.</p>
            <button class="back-to-main-menu-btn">Voltar</button>
        </div>


        <!-- Tela de Suporte -->
        <div id="payment-menu-support" class="payment-menu-view">
             <h4 class="payment-menu-header">Suporte</h4>
            <p class="payment-menu-description">Para obter ajuda com seu plano, por favor, entre em contato com nosso suporte via chat.</p>
            <!-- O botão agora abre o chat em vez de enviar email -->
            <button id="open-support-chat-from-menu" class="support-email-btn">Abrir Chat de Suporte</button>
            <button class="back-to-main-menu-btn">Voltar</button>
        </div>
    </div>

<!-- JANELA MODAL DE AUTENTICAÇÃO -->
    <div id="auth-overlay" class="auth-overlay">
        <div class="auth-modal">
            <button id="auth-close-btn" class="auth-close-btn">&times;</button>
            <div class="auth-tabs">
                <button class="auth-tab-btn active" data-form="login">Fazer Login</button>
                <button class="auth-tab-btn" data-form="signup">Criar Conta</button>
            </div>
<form id="login-form" class="auth-form active">
                <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required autocomplete="email"></div>
                <div class="form-group">
                    <label for="login-password">Senha</label>
                    <input type="password" id="login-password" required autocomplete="current-password">
                    <i data-feather="eye" class="password-toggle-icon"></i>
                </div>
                <button type="submit" class="btn-auth">Entrar</button>
            </form>
            <form id="signup-form" class="auth-form">
                <div class="form-group"><label for="full-name">Nome*</label><input type="text" id="full-name" required></div>
                <div class="form-group"><label for="signup-email">Email</label><input type="email" id="signup-email" required autocomplete="email"></div>
                <div class="form-group">
                    <label for="signup-password">Senha</label>
                    <input type="password" id="signup-password" required autocomplete="new-password">
                    <i data-feather="eye" class="password-toggle-icon"></i>
                </div>
                <div class="form-group">
                    <label for="signup-password-confirm">Confirme sua senha</label>
                    <input type="password" id="signup-password-confirm" required autocomplete="new-password">
                    <i data-feather="eye" class="password-toggle-icon"></i>
                </div>
                <div class="form-group"><label for="age">Sua Idade</label><input type="number" id="age" min="18" required placeholder="18 ou mais"></div>
                <button type="submit" class="btn-auth">Criar Perfil</button>
            </form>
        </div>
    </div>

<!-- JANELA MODAL DE PERFIL DO USUÁRIO -->
    <div id="profile-overlay" class="profile-overlay">
        <div class="profile-modal">
            <button id="profile-close-btn" class="profile-close-btn">&times;</button>
            <div class="profile-content">
                <div class="profile-header">
                    <div class="profile-avatar-container">
                        <img id="profile-avatar-img" src="https://i.pinimg.com/236x/55-6e-2e/556e2edc7518c0e5cb4d59aef6729b24.jpg" alt="Avatar do Usuário">
                        <input type="file" id="avatar-file-input" accept="image/*">
                        <label for="avatar-file-input" id="change-avatar-btn" title="Alterar foto de perfil">
                            <i data-feather="camera" style="width:16px; height:16px;"></i>
                        </label>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <h2 id="profile-user-name">Nome do Usuário</h2>
                        <span id="pro-badge" style="background-color: gold; color: #333; font-weight: 600; font-size: 0.8rem; padding: 2px 8px; border-radius: 10px; display: none;">PRO</span>
                    </div>
                    <p id="profile-user-age">Idade: --</p>
                    <div style="display: flex; gap: 20px; color: var(--secondary-text-color); font-size: 0.9rem; margin-top: 5px;">
                        <span id="profile-account-age"></span>
                        <span id="profile-time-spent"></span>
                    </div>
                </div>
                <div class="profile-section">
                    <h3>Biografia</h3>
                    <textarea id="profile-bio-textarea" placeholder="Conte um pouco sobre você..."></textarea>
                    <button id="save-bio-btn">Salvar Biografia</button>
                </div>

                <div class="profile-section">
                    <h3>Gênero</h3>
                    <select id="profile-gender-select" style="width: 100%; padding: 10px; background-color: var(--background-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--primary-text-color);">
                        <option value="Não informado">Não informar</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Feminino">Feminino</option>
                        <option value="Outro">Outro</option>
                    </select>
                    <button id="save-gender-btn" style="display: block; margin-top: 10px; margin-left: auto; background-color: var(--accent-color); color: var(--primary-text-color); border: none; border-radius: 15px; padding: 8px 15px; cursor: pointer;">Salvar Gênero</button>
                </div>

                <div class="profile-section">
                    <h3>Últimos Comentários</h3>
                    <div id="recent-comments-list">
                        <p>Nenhum comentário encontrado.</p>
                    </div>
                </div>
                <div class="profile-actions">
                    <button id="logout-btn" class="btn-auth">Sair da Conta</button>
                </div>
            </div>
        </div>
    </div>

<!-- JANELA MODAL DE UPLOAD DE VÍDEO PARA USUÁRIOS -->
    <div id="upload-overlay" class="auth-overlay"> <!-- Reutilizando o estilo do overlay de autenticação -->
        <div class="auth-modal" style="max-width: 650px;"> <!-- Modal um pouco maior -->
            <button id="upload-close-btn" class="auth-close-btn">&times;</button>
            <h2 style="text-align: center; margin-bottom: 25px;">Enviar Vídeo para Análise</h2>
            
            <form id="user-upload-form">
                <div class="form-group">
                    <label for="upload-video-title">Título do Vídeo</label>
                    <input type="text" id="upload-video-title" required placeholder="Um título claro e descritivo">
                </div>
                <div class="form-group">
                    <label for="upload-video-description">Descrição</label>
                    <textarea id="upload-video-description" required style="width:100%; height: 80px; background-color: var(--background-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--primary-text-color); padding: 10px; resize: vertical;" placeholder="Fale um pouco sobre o seu vídeo..."></textarea>
                </div>
                <div class="form-group">
                    <label for="upload-video-category">Categoria</label>
                    <select id="upload-video-category" required style="width:100%; padding: 10px; background-color: var(--background-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--primary-text-color);">
                        <option value="">Selecione uma categoria</option>
                        <!-- Populado via JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="upload-thumbnail-file">Capa do Vídeo (Thumbnail)</label>
                    <input type="file" id="upload-thumbnail-file" required accept="image/*" style="width: 100%; padding: 10px; background-color: var(--background-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--primary-text-color);">
                </div>
                 <div class="form-group">
                    <label for="upload-video-file">Arquivo de Vídeo</label>
                    <input type="file" id="upload-video-file" required accept="video/*" style="width: 100%; padding: 10px; background-color: var(--background-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--primary-text-color);">
                </div>

                <!-- Barra de Progresso do Upload -->
                <div class="form-group" id="user-progress-container" style="display: none;">
                    <label>Progresso do Upload:</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <progress id="user-upload-progress" value="0" max="100" style="width: 100%; height: 12px;"></progress>
                        <span id="user-progress-percentage">0%</span>
                    </div>
                </div>

                <button type="submit" id="user-submit-btn" class="btn-auth">Enviar para Análise</button>
            </form>
        </div>
    </div>

    <<!-- JANELA MODAL DE ASSINATURA -->
    <div id="subscription-overlay" class="auth-overlay">
        <div class="auth-modal subscription-modal">
            <button id="subscription-close-btn" class="auth-close-btn">&times;</button>
            
            <div class="plan-card">
                <h2>Pro</h2>
                <p>Para os verdadeiros apreciadores de feitiches!</p>

                <div class="price-info">
                    <span class="old-price">R$29.99</span>
                    <span class="new-price">R$14.99</span>
                    <span class="period">/mês</span>
                </div>
                <p class="billing-details"></p>

                <button id="get-pro-btn" class="btn-auth">Tornar-se Pro</button>

                <ul class="features-list">
                    <li><i data-feather="check"></i> Destintivo Pro</li>
                    <li><i data-feather="check"></i> Acesso a videos Exclusivos</li>
                    <li><i data-feather="check"></i> Videos em FULL HD</li>
                    <li><i data-feather="check"></i> Download em Full HD</li>
                    <li><i data-feather="check"></i> Suporte</li>
                    <li><i data-feather="check"></i> Notificações de novidades do site</li>
                </ul>
            </div>
            
            <!-- ÁREA DE CARREGAMENTO -->
            <div id="payment-loading-area" style="display: none; text-align: center; margin-top: 20px; padding: 40px 0;">
                <h4 style="color: var(--primary-text-color); font-size: 1.2rem;"></h4>
            </div>

            <!-- ÁREA PARA EXIBIR O QR CODE DO PIX -->
            <div id="pix-payment-area" style="display: none; text-align: center; margin-top: 20px;">
                 <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Logo%E2%80%94pix_powered_by_Banco_Central_%28Brazil%2C_2020%29.svg/2560px-Logo%E2%80%94pix_powered_by_Banco_Central_%28Brazil%2C_2020%29.svg.png" alt="Logo PIX" style="max-width: 100px; margin-bottom: 20px;">
                <img id="pix-qr-code" src="https://yxdjmyqkltaqjulfkcuu.supabase.co/storage/v1/object/public/pix/a.jpg" alt="PIX QR Code" style="max-width: 250px; margin: 15px auto; border-radius: 8px; display: block;">
                <p style="margin-top: 15px;">Ou use o PIX Copia e Cola:</p>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="text" id="pix-copy-paste" value="00020126710014br.gov.bcb.pix01366b384ac7-88f3-46fb-a5ff-a9eef05855f40209PulseRoom520400005303986540514.995802BR5924Pedro Antonio Trinta Tri6009Sao Paulo610901227-20062230519daqr28858930277974563040348" readonly style="flex-grow: 1; text-align: center; background-color: var(--background-color); border: 1px solid var(--border-color); color: var(--secondary-text-color); padding: 8px;">
                    <button id="copy-pix-btn" style="padding: 8px 12px; background-color: var(--hover-color); border: 1px solid var(--border-color); color: var(--primary-text-color); border-radius: 5px; cursor: pointer;">Copiar</button>
                </div>
                
                <div class="form-group" style="margin-top: 20px; text-align: left;">
                    <label for="pix-payer-name">Seu primeiro nome constado no comprovante</label>
                    <input type="text" id="pix-payer-name" required placeholder="Ex: Joao" style="width: 100%; padding: 10px; background-color: var(--background-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--primary-text-color);">
                </div>
                 <button id="confirm-payment-btn" class="btn-auth" style="margin-top: 15px;">Confirmo meu pagamento</button>
            </div>
        </div>
    </div>

    <!-- JANELA MODAL DO MINI-PERFIL -->
    <div id="mini-profile-overlay" class="auth-overlay">
        <div class="profile-modal" style="max-width: 450px; cursor: default;" onclick="event.stopPropagation();">
            <button id="mini-profile-close-btn" class="profile-close-btn">&times;</button>
            <div class="profile-content">
                <div class="profile-header">
                    <div id="mini-profile-avatar-container" class="profile-avatar-container">
                        <img id="mini-profile-avatar-img" src="" alt="Avatar do Usuário">
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <h2 id="mini-profile-user-name"></h2>
                        <span id="mini-profile-pro-badge" style="background-color: gold; color: #333; font-weight: 600; font-size: 0.8rem; padding: 2px 8px; border-radius: 10px; display: none;">PRO</span>
                    </div>
                </div>
                <div class="profile-section">
                    <h3>Biografia</h3>
                    <p id="mini-profile-bio" style="color: var(--secondary-text-color); font-style: italic;"></p>
                </div>
<div class="profile-section" style="text-align: center;">
                    <p id="mini-profile-account-age" style="color: var(--secondary-text-color); font-size: 0.9rem; margin-bottom: 15px;"></p>
                    <!-- Botão de Enviar Mensagem -->
                    <button id="mini-profile-send-message-btn" class="btn-auth" style="width: auto; padding: 8px 20px; font-size: 0.9rem; margin-bottom: 20px;">Enviar Mensagem</button>
                    <div style="display: flex; justify-content: space-around;">
                        <div>
                            <h3>Idade</h3>
                            <p id="mini-profile-age"></p>
                        </div>
                        <div>
                            <h3>Gênero</h3>
                            <p id="mini-profile-gender"></p>
                        </div>
                        <div>
                            <h3>Atividade</h3>
                            <p id="mini-profile-time-spent"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- INÍCIO DA SEÇÃO DE INFORMAÇÕES DO RODAPÉ -->
    <style>
        .footer-info-container {
            max-width: 1200px;
            margin: 60px auto 20px auto;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            color: var(--secondary-text-color);
            display: none; /* Adicionado para esconder por padrão */
        }
        .footer-info-container h2 {
            color: var(--primary-text-color);
            font-size: 2rem;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }
        .footer-info-container h3 {
            color: var(--primary-text-color);
            font-size: 1.5rem;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        .footer-info-container h4 {
            color: var(--accent-color);
            font-size: 1.1rem;
            margin-top: 20px;
            margin-bottom: 5px;
        }
        .footer-info-container p {
            line-height: 1.6;
            margin-bottom: 15px;
        }
        .footer-links {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        .footer-links a {
            color: var(--secondary-text-color);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s;
        }
        .footer-links a:hover {
            color: var(--accent-color);
        }
        .footer-links span {
            margin: 0 10px;
        }
    </style>

    <footer class="footer-info-container">
        
        <!-- Seção de Perguntas Frequentes -->
        <div id="faq">
            <h2>Perguntas Frequentes</h2>
            
            <h4>Qual a idade mínima?</h4>
            <p>Você precisa ter pelo menos 18 anos para acessar o PulseRoom.</p>

            <h4>O que é o PulseRoom?</h4>
            <p>PulseRoom é uma plataforma de hospedagem que oferece uma maneira segura e fácil de carregar, armazenar e compartilhar suas fotos e vídeos. Você controla com quem compartilha seu conteúdo.</p>

            <h4>O que posso enviar?</h4>
            <p>Fotos e vídeos. Aceitamos a maioria dos formatos de arquivo.</p>
            
            <h4>Meus arquivos estão seguros?</h4>
            <p>Sim, claro! Seus arquivos são armazenados em servidores seguros. Também temos configurações de privacidade para manter todo o seu material privado.</p>
            
            <h4>E a minha privacidade?</h4>
            <p>Nós amamos a privacidade tanto quanto você e coletamos apenas os dados necessários para você fazer login e para manter a segurança do nosso site e de seus usuários. No entanto, observe que se você enviar intencionalmente conteúdo ilegal, poderemos divulgar suas informações privadas sem aviso prévio, seja proativamente ou mediante solicitação das autoridades policiais.</p>

            <h4>Posso deletar meu conteúdo?</h4>
            <p>Você pode deletar seus vídeos a qualquer momento. Nós removeremos instantaneamente todos os arquivos de nossos servidores.</p>
            
            <h4>Posso deletar minha conta?</h4>
            <p>Você pode fazer isso por si mesmo na seção de configurações da sua conta.</p>
            
            <h4>Como denuncio abusos?</h4>
            <p>Por favor, envie um e-mail para: luanamonique2222@gmail.com</p>
        </div>

        <!-- Seção para Criadores -->
        <div id="criadores" style="margin-top: 50px;">
            <h2>Para Criadores</h2>
            <p>Nós não pagamos pelo envio de vídeos para o PulseRoom, mas você pode promover seu site de fãs ou site pago no PulseRoom e obter vendas a partir de um link em sua Biografia.</p>
            <p>Quando você se torna um Criador de Conteúdo verificado, seu perfil se destacará e atrairá mais atenção.</p>
            
            <h3>Regras</h3>
            <ul>
                <li><p>Apenas conteúdo de qualidade é aceito para não ser considerado spam e degradar o site.</p></li>
                <li><p>Isso implica: sem cenas cortadas, sem compilações e vídeos com um final lógico.</p></li>
                <li><p>Nenhuma menção à "versão completa" disponível em outro lugar, como em um site pago.</p></li>
                <li><p>Sem marcas d'água exageradas e irritantes.</p></li>
            </ul>

            <h3>Como faço?</h3>
            <p>Cadastre sua conta, vá para as Configurações do seu perfil e clique no link para "tornar-se verificado".</p>
        </div>

        <!-- Seção de Termos e Privacidade -->
        <div id="termos" style="margin-top: 50px;">
            <h2>Termos & Privacidade</h2>
            <p>Bem-vindo ao PulseRoom! Seu uso e acesso ao PulseRoom, referido como serviço, site ou website, estão incluídos abaixo. Você está aceitando estes termos ao usar este serviço. Se necessário, estes termos podem ser alterados.</p>
            
            <h3>Seu Conteúdo</h3>
            <p>Nestes termos, "seu conteúdo" significa o material (vídeos, fotos, texto, etc.) que você envia para este website. Seu conteúdo é seu.</p>
            <p>Precisamos da sua permissão para fazer coisas como hospedar e exibir seu conteúdo em conexão com o site. Nosso serviço também oferece recursos como miniaturas de fotos e vídeos, edição e compartilhamento. Você nos dá permissão para fazer essas coisas.</p>
            <p>Estes termos não nos dão nenhum direito ao seu conteúdo de usuário, exceto pelos direitos limitados que nos permitem oferecer o serviço.</p>
            <p>Após a exclusão, seu conteúdo é completamente removido do site.</p>
            <p>Reservamo-nos o direito de analisar o material enviado e remover qualquer conteúdo que não esteja em conformidade com o serviço. Seu conteúdo deve aderir às leis e regulamentos aplicáveis. Conteúdo que retrata menores de idade é estritamente proibido.</p>
            
            <h3>Sem Garantias e Responsabilidades</h3>
            <p>Este website é oferecido em sua forma atual, sem garantia.</p>
            <p>Nada neste website significa, ou pretende significar, qualquer tipo de conselho.</p>
            <p>Não seremos responsáveis perante você em relação ao conteúdo, uso ou perdas de qualquer forma em conexão com o serviço. Você aceita indenizar, defender e isentar o serviço de quaisquer perdas, responsabilidades e despesas relacionadas ou decorrentes do seu uso ou incapacidade de usar o serviço.</p>

            <h3>Privacidade</h3>
            <p>Nós respeitamos sua privacidade. Esta declaração de privacidade oferece informações sobre nossas práticas com respeito às informações individuais e públicas que podemos coletar, utilizar e revelar utilizando o serviço. É, portanto, sua obrigação legal revisar e aceitar esta política.</p>

            <h3>Informações Coletadas</h3>
            <p>Nós coletamos em contas padrão seu e-mail (opcional) e endereços IP para identificação ao visitar e utilizar o serviço.</p>
            <p>Também podemos coletar automaticamente informações relacionadas ao hardware e software do seu computador. Esta informação pode incluir: endereços IP, tipo de navegador, nomes de domínio, tempos de acesso e endereços de sites de referência. Esta informação é utilizada para a operação, para manter a qualidade do serviço e disponibilizar estatísticas gerais sobre o uso do Site. Não vendemos, alugamos ou compartilhamos listas e informações de clientes com terceiros.</p>
            <p>Estamos usando o Google Analytics para entender melhor como o site está sendo usado. Para mais informações sobre o Google Analytics, por favor, visite https://support.google.com/analytics/answer/6004245.</p>

            <h3>Anúncios</h3>
            <p>Podemos usar empresas de publicidade de terceiros para veicular anúncios quando você usa o serviço. Essas empresas podem usar informações sobre suas visitas a este e a outros sites para fornecer anúncios sobre bens e serviços de seu interesse. Se você quiser mais informações sobre essa prática e conhecer suas opções para não ter essa informação usada por essas empresas para publicidade baseada em interesses, por favor, visite http://www.aboutads.info/choices/.</p>

            <h3>Cookies</h3>
            <p>Solicitamos a você a coleta, uso e armazenamento de "Cookies" através de nossos servidores web. Podemos enviar pelo menos um cookie para o seu computador que reconhece exclusivamente sua sessão de navegador. No entanto, os recursos do site podem ficar indisponíveis se você considerar recusar os cookies.</p>

            <h3>Divulgação de Informações</h3>
            <p>Divulgaremos todas as informações privadas se você enviar intencionalmente qualquer material ilegal para o serviço, sem aviso prévio, e qualquer outra informação relevante, desde que seja solicitado legalmente ou de boa-fé. Divulgaremos todas as informações privadas se solicitado pela aplicação da lei em qualquer um dos países operacionais.</p>

            <h3>Segurança</h3>
            <p>Assumiremos todas as precauções razoáveis e técnicas para impedir a perda, uso indevido ou alteração de suas informações privadas e públicas. Todas as informações são armazenadas em nossos servidores protegidos.</p>
            <p>Você pode nos enviar um e-mail para luanamonique2222@gmail.com se tiver alguma dúvida ou acreditar que alguém usou indevidamente qualquer um destes termos.</p>
        </div>

        <!-- Seção de Denúncia de Abuso -->
        <div id="abuse" style="margin-top: 50px;">
            <h2>Denúncia de Abuso</h2>
            <p>O PulseRoom tem uma política de tolerância zero contra a exploração e o abuso de menores. É estritamente proibido o upload, compartilhamento ou visualização de qualquer conteúdo que envolva indivíduos menores de 18 anos.</p>
            <p>Se você encontrar qualquer conteúdo que suspeite envolver menores de idade, é seu dever cívico e moral reportá-lo imediatamente utilizando o botão "Reportar" <i data-feather="flag" style="width:14px; vertical-align: middle;"></i> no vídeo. Levamos todas as denúncias dessa natureza com a máxima seriedade e urgência. A sua ajuda é fundamental para mantermos o PulseRoom um ambiente seguro e respeitoso para todos os adultos.</p>
            
            <h4 style="margin-top: 30px;">Conteúdo Não Autorizado</h4>
            <p>Da mesma forma, levamos a sério a privacidade e o consentimento. Se você encontrar um vídeo que mostra você, um membro da sua família ou alguém que você conhece, e essa postagem não foi autorizada, por favor, utilize a função "Reportar" no vídeo imediatamente para que nossa equipe possa analisar a situação.</p>
        </div>

        <div class="footer-links">
            <a href="#faq">FAQ</a>
            <span>-</span>
            <a href="#criadores">Criadores</a>
            <span>-</span>
            <a href="#termos">Termos & Privacidade</a>
            <span>-</span>
            <a href="#" class="support-chat-link">Suporte</a>
        </div>

    </footer>
    <!-- FIM DA SEÇÃO DE INFORMAÇÕES DO RODAPÉ -->

    <!-- O final do seu arquivo agora deve ser apenas a tag de fechamento body e html -->

    <!-- TELA DE MENU DEDICADA PARA O MOBILE -->
    <div id="mobile-menu-overlay" class="mobile-menu-overlay">
        <button id="mobile-menu-close-btn">&times;</button>
        <div id="mobile-menu-content">
            <!-- Conteúdo da sidebar será clonado aqui via JS -->
        </div>
    </div>
    
    <!-- JANELA MODAL DO CHAT -->
    <div id="chat-overlay" class="auth-overlay">
        <div id="chat-container">
            <!-- Barra Lateral com a Lista de Conversas -->
            <aside id="chat-list-sidebar">
                <header class="chat-list-header">
                    <h3>Conversas</h3>
                    <button id="chat-close-btn" class="auth-close-btn">&times;</button>
                </header>
                <div id="chat-list">
                    <!-- A lista de conversas será populada aqui -->
                </div>
            </aside>

            <!-- Janela Principal da Conversa Ativa -->
            <main id="chat-window-main">
                <div id="chat-welcome-screen">
                    <i data-feather="message-circle"></i>
                    <p>Selecione uma conversa para começar</p>
                </div>
                <div id="active-chat-window" style="display: none;">
<header id="chat-window-header">
                        <!-- Botão de voltar para a visualização móvel -->
                        <div id="chat-back-btn" style="display: none;">
                            <i data-feather="arrow-left"></i>
                        </div>
                        <img id="chat-header-avatar" src="" alt="Avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                        <span id="chat-header-name"></span>
                    </header>
                    <div id="chat-messages">
                        <!-- Mensagens aparecerão aqui -->
                    </div>
                    <form id="chat-input-form">
                        <input type="file" id="chat-media-input" accept="image/*,video/*" style="display: none;">
                        <label for="chat-media-input" id="chat-media-btn" title="Enviar foto ou vídeo">
                            <i data-feather="paperclip"></i>
                        </label>
                        <input type="text" id="chat-message-input" placeholder="Digite sua mensagem..." autocomplete="off" required>
                        <button type="submit" title="Enviar mensagem"><i data-feather="send"></i></button>
                    </form>
                </div>
            </main>
        </div>
    </div>

</body>
</html>